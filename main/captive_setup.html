<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>WiFi Setup - ESP32 Door Station</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>📶</text></svg>">
  <style>
    /* ===== CSS Custom Properties ===== */

    /* Dark Theme (Default) */
    :root {
      /* Primary Colors */
      --color-primary: #66bb6a;
      --color-primary-dark: #4caf50;
      --color-primary-light: #81c784;
      --color-danger: #ef5350;
      --color-warning: #ffca28;
      --color-info: #29b6f6;
      --color-success: #66bb6a;

      /* Background Colors */
      --color-bg: #1e1e1e;
      --color-surface: #2d2d2d;
      --color-hover: #3a3a3a;
      --color-active: #404040;

      /* Text Colors */
      --color-text: #e0e0e0;
      --color-text-secondary: #b0b0b0;
      --color-text-muted: #808080;
      --color-text-inverse: #1e1e1e;

      /* Border Colors */
      --color-border: #404040;
      --color-border-light: #353535;
      --color-border-dark: #4a4a4a;

      /* Shadows */
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 2px 4px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.4);
      --shadow-xl: 0 8px 16px rgba(0, 0, 0, 0.5);

      /* Spacing */
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;

      /* Typography */
      --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      --font-size-xs: 12px;
      --font-size-sm: 14px;
      --font-size-base: 16px;
      --font-size-lg: 18px;
      --font-size-xl: 20px;
      --font-size-2xl: 24px;
      --font-weight-normal: 400;
      --font-weight-medium: 500;
      --font-weight-bold: 600;

      /* Border Radius */
      --border-radius: 8px;
      --border-radius-sm: 4px;
      --border-radius-lg: 12px;

      /* Transitions */
      --transition-fast: 150ms ease;
      --transition-base: 200ms ease;
      --transition-slow: 300ms ease;
    }

    /* ===== Base Styles ===== */

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      font-family: var(--font-family);
      font-size: var(--font-size-base);
      line-height: 1.5;
      color: var(--color-text);
      background-color: var(--color-bg);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--spacing-md);
    }

    /* ===== Setup Container ===== */

    .setup-container {
      width: 100%;
      max-width: 500px;
      background-color: var(--color-surface);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-xl);
      overflow: hidden;
    }

    .setup-header {
      padding: var(--spacing-xl);
      text-align: center;
      background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
      color: var(--color-text-inverse);
    }

    .setup-icon {
      font-size: 48px;
      margin-bottom: var(--spacing-md);
    }

    .setup-title {
      font-size: var(--font-size-2xl);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--spacing-xs);
    }

    .setup-subtitle {
      font-size: var(--font-size-sm);
      opacity: 0.9;
    }

    .setup-body {
      padding: var(--spacing-xl);
    }

    .setup-info {
      background-color: rgba(23, 162, 184, 0.1);
      border: 1px solid var(--color-info);
      border-radius: var(--border-radius-sm);
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
      font-size: var(--font-size-sm);
      color: var(--color-text);
    }

    .setup-info strong {
      display: block;
      margin-bottom: var(--spacing-xs);
      color: var(--color-info);
    }

    /* ===== Form Styles ===== */

    .form-group {
      margin-bottom: var(--spacing-lg);
    }

    .form-group label {
      display: block;
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      color: var(--color-text);
      margin-bottom: var(--spacing-sm);
    }

    .form-group input {
      width: 100%;
      padding: var(--spacing-md);
      font-size: var(--font-size-base);
      font-family: var(--font-family);
      color: var(--color-text);
      background-color: var(--color-bg);
      border: 2px solid var(--color-border);
      border-radius: var(--border-radius-sm);
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }

    .form-group input.invalid {
      border-color: var(--color-danger);
    }

    .form-group input.invalid:focus {
      box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
    }

    .form-group input.valid {
      border-color: var(--color-success);
    }

    .form-group input.valid:focus {
      box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
    }

    .form-hint {
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
      margin-top: var(--spacing-xs);
    }

    /* ===== Message ===== */

    .message {
      display: none;
      padding: var(--spacing-md);
      margin-bottom: var(--spacing-lg);
      border-radius: var(--border-radius-sm);
      font-size: var(--font-size-sm);
    }

    .message.show {
      display: block;
    }

    .message.error {
      background-color: rgba(220, 53, 69, 0.1);
      border: 1px solid var(--color-danger);
      color: var(--color-danger);
      animation: shake 0.3s ease-in-out;
    }

    .message.success {
      background-color: rgba(40, 167, 69, 0.1);
      border: 1px solid var(--color-success);
      color: var(--color-success);
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    /* ===== Button Styles ===== */

    .btn {
      width: 100%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-md) var(--spacing-lg);
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-medium);
      font-family: var(--font-family);
      color: var(--color-text-inverse);
      background-color: var(--color-primary);
      border: none;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      transition: background-color var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
      user-select: none;
      min-height: 48px;
    }

    .btn:hover:not(:disabled) {
      background-color: var(--color-primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.3);
    }

    .btn-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid var(--color-text-inverse);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* ===== Footer ===== */

    .setup-footer {
      padding: var(--spacing-lg) var(--spacing-xl);
      background-color: var(--color-bg);
      text-align: center;
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      border-top: 1px solid var(--color-border);
    }

    /* ===== WiFi Network List ===== */

    .network-list {
      margin-top: var(--spacing-md);
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius-sm);
      background-color: var(--color-bg);
    }

    .network-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-md);
      border-bottom: 1px solid var(--color-border);
      cursor: pointer;
      transition: background-color var(--transition-fast);
    }

    .network-item:last-child {
      border-bottom: none;
    }

    .network-item:hover {
      background-color: var(--color-hover);
    }

    .network-item.selected {
      background-color: var(--color-active);
      border-color: var(--color-primary);
    }

    .network-info {
      flex: 1;
    }

    .network-name {
      font-weight: var(--font-weight-medium);
      margin-bottom: var(--spacing-xs);
    }

    .network-details {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
    }

    .network-security {
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
    }

    .network-signal {
      font-size: var(--font-size-lg);
    }

    /* ===== Responsive Design ===== */

    @media (max-width: 480px) {
      .setup-container {
        max-width: 100%;
      }

      .setup-header {
        padding: var(--spacing-lg);
      }

      .setup-icon {
        font-size: 40px;
      }

      .setup-title {
        font-size: var(--font-size-xl);
      }

      .setup-body {
        padding: var(--spacing-lg);
      }
    }
  </style>
</head>
<body>
  <!-- Setup Container -->
  <div class="setup-container">
    <!-- Header -->
    <div class="setup-header">
      <div class="setup-icon">📶</div>
      <h1 class="setup-title">WiFi Setup</h1>
      <p class="setup-subtitle">Connect to your WiFi network</p>
    </div>

    <!-- Body -->
    <div class="setup-body">
      <!-- Info Box -->
      <div class="setup-info">
        <strong>📡 Connect to WiFi</strong>
        <p>Scan for available networks and enter your WiFi credentials to connect this device to your network.</p>
      </div>

      <!-- Message -->
      <div id="message" class="message" role="alert"></div>

      <!-- WiFi Scan Button -->
      <button type="button" class="btn" id="scan-btn" onclick="scanNetworks()">
        <span id="scan-text">🔍 Scan Networks</span>
        <span class="btn-spinner" id="scan-spinner" hidden></span>
      </button>

      <!-- Network List -->
      <div id="network-list" class="network-list" style="display: none;"></div>

      <!-- WiFi Connection Form -->
      <form id="wifi-form" onsubmit="connectToWifi(event)" style="margin-top: var(--spacing-lg);">
        <div class="form-group">
          <label for="ssid">Network Name (SSID)</label>
          <input
            type="text"
            id="ssid"
            name="ssid"
            required
            placeholder="Enter WiFi network name"
            autocomplete="off"
          >
        </div>

        <div class="form-group">
          <label for="password">Password</label>
          <input
            type="password"
            id="password"
            name="password"
            placeholder="Enter WiFi password"
            autocomplete="off"
          >
          <div class="form-hint">Leave empty for open networks</div>
        </div>

        <button type="submit" class="btn" id="connect-btn">
          <span id="connect-text">🔗 Connect to WiFi</span>
          <span class="btn-spinner" id="connect-spinner" hidden></span>
        </button>
      </form>
    </div>

    <!-- Footer -->
    <div class="setup-footer">
      <p>ESP32 Door Station - Captive Portal</p>
    </div>
  </div>

  <script>
    // Form elements
    const scanBtn = document.getElementById('scan-btn');
    const scanText = document.getElementById('scan-text');
    const scanSpinner = document.getElementById('scan-spinner');
    const networkList = document.getElementById('network-list');
    const wifiForm = document.getElementById('wifi-form');
    const ssidInput = document.getElementById('ssid');
    const passwordInput = document.getElementById('password');
    const connectBtn = document.getElementById('connect-btn');
    const connectText = document.getElementById('connect-text');
    const connectSpinner = document.getElementById('connect-spinner');
    const messageDiv = document.getElementById('message');

    // Show message
    function showMessage(message, type) {
      messageDiv.textContent = message;
      messageDiv.className = 'message show ' + type;
    }

    // Clear message
    function clearMessage() {
      messageDiv.classList.remove('show');
    }

    // Set loading state for scan button
    function setScanLoading(loading) {
      scanBtn.disabled = loading;
      scanSpinner.hidden = !loading;
      if (loading) {
        scanText.textContent = 'Scanning...';
      } else {
        scanText.textContent = '🔍 Scan Networks';
      }
    }

    // Set loading state for connect button
    function setConnectLoading(loading) {
      connectBtn.disabled = loading;
      passwordInput.disabled = loading;
      ssidInput.disabled = loading;
      connectSpinner.hidden = !loading;
      if (loading) {
        connectText.textContent = 'Connecting...';
      } else {
        connectText.textContent = '🔗 Connect to WiFi';
      }
    }

    // Scan for WiFi networks
    async function scanNetworks() {
      clearMessage();
      setScanLoading(true);

      try {
        const response = await fetch('/api/wifi/scan', {
          method: 'POST'
        });

        const data = await response.json();

        if (response.ok && data.networks && data.networks.length > 0) {
          displayNetworks(data.networks);
          networkList.style.display = 'block';
        } else {
          showMessage('No networks found or scan failed', 'error');
          networkList.style.display = 'none';
        }
      } catch (error) {
        console.error('Scan error:', error);
        showMessage('Failed to scan networks', 'error');
        networkList.style.display = 'none';
      } finally {
        setScanLoading(false);
      }
    }

    // Display scanned networks
    function displayNetworks(networks) {
      networkList.innerHTML = '';

      networks.forEach(network => {
        const networkItem = document.createElement('div');
        networkItem.className = 'network-item';
        networkItem.onclick = () => selectNetwork(network.ssid);

        const signalStrength = getSignalStrength(network.rssi);
        const securityIcon = network.secure ? '🔒' : '🔓';

        networkItem.innerHTML = `
          <div class="network-info">
            <div class="network-name">${network.ssid}</div>
            <div class="network-details">
              <span class="network-signal">${signalStrength}</span>
              <span class="network-security">${securityIcon}</span>
            </div>
          </div>
        `;

        networkList.appendChild(networkItem);
      });
    }

    // Get signal strength emoji based on RSSI
    function getSignalStrength(rssi) {
      if (rssi >= -50) return '📶';
      if (rssi >= -60) return '📶';
      if (rssi >= -70) return '📶';
      return '📶';
    }

    // Select a network from the list
    function selectNetwork(ssid) {
      ssidInput.value = ssid;

      // Highlight selected network
      const networkItems = networkList.querySelectorAll('.network-item');
      networkItems.forEach(item => {
        if (item.querySelector('.network-name').textContent === ssid) {
          item.classList.add('selected');
        } else {
          item.classList.remove('selected');
        }
      });
    }

    // Connect to WiFi
    async function connectToWifi(event) {
      event.preventDefault();
      clearMessage();

      const ssid = ssidInput.value.trim();
      const password = passwordInput.value;

      if (!ssid) {
        showMessage('Please enter a network name', 'error');
        return;
      }

      setConnectLoading(true);

      try {
        const response = await fetch('/api/wifi/connect', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            ssid: ssid,
            password: password
          })
        });

        const data = await response.json();

        if (response.ok && data.status === 'success') {
          showMessage('WiFi connection initiated. Device will restart when connected.', 'success');

          // Disable form after successful submission
          wifiForm.style.pointerEvents = 'none';
          wifiForm.style.opacity = '0.6';

          // Auto-refresh after 10 seconds to check status
          setTimeout(() => {
            window.location.reload();
          }, 10000);
        } else {
          const errorMsg = data.message || 'Failed to connect to WiFi';
          showMessage(errorMsg, 'error');
          setConnectLoading(false);
        }
      } catch (error) {
        console.error('Connect error:', error);
        showMessage('Connection failed. Please try again.', 'error');
        setConnectLoading(false);
      }
    }

    // Load existing WiFi config on page load
    async function loadConfig() {
      try {
        const response = await fetch('/api/wifi/config');
        if (response.ok) {
          const data = await response.json();
          if (data.ssid) {
            ssidInput.value = data.ssid;
          }
        }
      } catch (error) {
        console.error('Failed to load WiFi config:', error);
      }
    }

    // Initialize
    loadConfig();
  </script>
</body>
</html>