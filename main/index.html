<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>ESP32 SIP Door Station</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üîî</text></svg>">
  <style>
    /* ===== CSS Custom Properties (Task 2.1) ===== */
    
    /* Light Theme (Default) */
    :root {
      /* Primary Colors */
      --color-primary: #4CAF50;
      --color-primary-dark: #45a049;
      --color-primary-light: #81C784;
      --color-danger: #dc3545;
      --color-warning: #ffc107;
      --color-info: #17a2b8;
      --color-success: #28a745;
      
      /* Background Colors */
      --color-bg: #f4f4f4;
      --color-surface: #ffffff;
      --color-hover: #f8f9fa;
      --color-active: #e9ecef;
      
      /* Text Colors */
      --color-text: #333333;
      --color-text-secondary: #666666;
      --color-text-muted: #999999;
      --color-text-inverse: #ffffff;
      
      /* Border Colors */
      --color-border: #dddddd;
      --color-border-light: #eeeeee;
      --color-border-dark: #cccccc;
      
      /* Status Colors */
      --color-status-connected: #28a745;
      --color-status-disconnected: #dc3545;
      --color-status-connecting: #ffc107;
      --color-status-inactive: #6c757d;
      
      /* Shadows */
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 2px 4px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.15);
      --shadow-xl: 0 8px 16px rgba(0, 0, 0, 0.2);
      
      /* Spacing */
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;
      
      /* Typography */
      --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      --font-size-xs: 12px;
      --font-size-sm: 14px;
      --font-size-base: 16px;
      --font-size-lg: 18px;
      --font-size-xl: 20px;
      --font-size-2xl: 24px;
      --font-weight-normal: 400;
      --font-weight-medium: 500;
      --font-weight-bold: 600;
      
      /* Layout */
      --header-height: 60px;
      --sidebar-width: 240px;
      --sidebar-collapsed-width: 60px;
      --border-radius: 8px;
      --border-radius-sm: 4px;
      --border-radius-lg: 12px;
      
      /* Transitions */
      --transition-fast: 150ms ease;
      --transition-base: 200ms ease;
      --transition-slow: 300ms ease;
    }
    
    /* Dark Theme */
    [data-theme="dark"] {
      /* Primary Colors */
      --color-primary: #66bb6a;
      --color-primary-dark: #4caf50;
      --color-primary-light: #81c784;
      --color-danger: #ef5350;
      --color-warning: #ffca28;
      --color-info: #29b6f6;
      --color-success: #66bb6a;
      
      /* Background Colors */
      --color-bg: #1e1e1e;
      --color-surface: #2d2d2d;
      --color-hover: #3a3a3a;
      --color-active: #404040;
      
      /* Text Colors */
      --color-text: #e0e0e0;
      --color-text-secondary: #b0b0b0;
      --color-text-muted: #808080;
      --color-text-inverse: #1e1e1e;
      
      /* Border Colors */
      --color-border: #404040;
      --color-border-light: #353535;
      --color-border-dark: #4a4a4a;
      
      /* Status Colors */
      --color-status-connected: #66bb6a;
      --color-status-disconnected: #ef5350;
      --color-status-connecting: #ffca28;
      --color-status-inactive: #9e9e9e;
      
      /* Shadows */
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 2px 4px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 4px 8px rgba(0, 0, 0, 0.4);
      --shadow-xl: 0 8px 16px rgba(0, 0, 0, 0.5);
    }
    
    /* ===== Base Styles ===== */
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html {
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    body {
      font-family: var(--font-family);
      font-size: var(--font-size-base);
      line-height: 1.5;
      color: var(--color-text);
      background-color: var(--color-bg);
      overflow-x: hidden;
    }
    
    /* ===== Header Styles (Task 2.2) ===== */
    
    .app-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--header-height);
      background-color: var(--color-surface);
      border-bottom: 1px solid var(--color-border);
      box-shadow: var(--shadow-sm);
      display: flex;
      align-items: center;
      padding: 0 var(--spacing-md);
      gap: var(--spacing-md);
      z-index: 1000;
    }
    
    .menu-toggle {
      display: none;
      width: 44px;
      height: 44px;
      background: none;
      border: none;
      font-size: var(--font-size-2xl);
      color: var(--color-text);
      cursor: pointer;
      border-radius: var(--border-radius-sm);
      transition: background-color var(--transition-fast);
    }
    
    .menu-toggle:hover {
      background-color: var(--color-hover);
    }
    
    .menu-toggle:active {
      background-color: var(--color-active);
    }
    
    .app-title {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-bold);
      color: var(--color-text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .header-actions {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      margin-left: auto;
    }
    
    .global-search {
      width: 250px;
      height: 36px;
      padding: 0 var(--spacing-md);
      background-color: var(--color-bg);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      font-size: var(--font-size-sm);
      color: var(--color-text);
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
    }
    
    .global-search:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }
    
    .global-search::placeholder {
      color: var(--color-text-muted);
    }
    
    .theme-toggle {
      width: 44px;
      height: 44px;
      background: none;
      border: none;
      font-size: var(--font-size-xl);
      cursor: pointer;
      border-radius: var(--border-radius-sm);
      transition: background-color var(--transition-fast);
    }
    
    .theme-toggle:hover {
      background-color: var(--color-hover);
    }
    
    .theme-toggle:active {
      background-color: var(--color-active);
    }
    
    .version {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      white-space: nowrap;
    }
    
    /* ===== Sidebar Styles (Task 2.2) ===== */
    
    .sidebar {
      position: fixed;
      top: var(--header-height);
      left: 0;
      width: var(--sidebar-width);
      height: calc(100vh - var(--header-height));
      background-color: var(--color-surface);
      border-right: 1px solid var(--color-border);
      overflow-y: auto;
      overflow-x: hidden;
      transition: transform var(--transition-slow);
      z-index: 900;
    }
    
    .nav-menu {
      list-style: none;
      padding: var(--spacing-sm) 0;
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md) var(--spacing-lg);
      color: var(--color-text);
      cursor: pointer;
      transition: background-color var(--transition-fast), color var(--transition-fast);
      position: relative;
      user-select: none;
    }
    
    .nav-item:hover {
      background-color: var(--color-hover);
    }
    
    .nav-item.active {
      background-color: var(--color-primary);
      color: var(--color-text-inverse);
      font-weight: var(--font-weight-medium);
    }
    
    .nav-item.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background-color: var(--color-primary-dark);
    }
    
    .nav-icon {
      font-size: var(--font-size-xl);
      flex-shrink: 0;
      width: 24px;
      text-align: center;
    }
    
    .nav-label {
      flex: 1;
      font-size: var(--font-size-base);
    }
    
    .unsaved-indicator {
      color: var(--color-warning);
      font-size: var(--font-size-lg);
      flex-shrink: 0;
    }
    
    /* ===== Main Content Area (Task 2.2) ===== */
    
    .main-content {
      margin-top: var(--header-height);
      margin-left: var(--sidebar-width);
      padding: var(--spacing-lg);
      min-height: calc(100vh - var(--header-height));
      transition: margin-left var(--transition-slow);
    }
    
    .content-section {
      opacity: 0;
      transition: opacity var(--transition-base);
    }
    
    .content-section.active {
      opacity: 1;
    }
    
    .content-section h2 {
      font-size: var(--font-size-2xl);
      font-weight: var(--font-weight-bold);
      color: var(--color-text);
      margin-bottom: var(--spacing-lg);
    }
    
    /* ===== Status Panel Styles (Task 2.3) ===== */
    
    .status-panel {
      background-color: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
    }
    
    .status-toggle {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-md) var(--spacing-lg);
      background: none;
      border: none;
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-medium);
      color: var(--color-text);
      cursor: pointer;
      transition: background-color var(--transition-fast);
    }
    
    .status-toggle:hover {
      background-color: var(--color-hover);
    }
    
    .toggle-icon {
      font-size: var(--font-size-base);
      transition: transform var(--transition-base);
    }
    
    .status-panel.collapsed .toggle-icon {
      transform: rotate(-90deg);
    }
    
    .status-content {
      max-height: 500px;
      overflow: hidden;
      transition: max-height var(--transition-slow), opacity var(--transition-slow);
      opacity: 1;
    }
    
    .status-panel.collapsed .status-content {
      max-height: 0;
      opacity: 0;
    }
    
    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-md);
      padding: var(--spacing-md) var(--spacing-lg) var(--spacing-lg);
    }
    
    .status-card {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      background-color: var(--color-bg);
      border: 2px solid var(--color-border);
      border-radius: var(--border-radius);
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
    }
    
    .status-card[data-status="connected"],
    .status-card[data-status="registered"] {
      border-color: var(--color-status-connected);
    }
    
    .status-card[data-status="disconnected"],
    .status-card[data-status="error"] {
      border-color: var(--color-status-disconnected);
    }
    
    .status-card[data-status="connecting"] {
      border-color: var(--color-status-connecting);
    }
    
    .status-card[data-status="closed"],
    .status-card[data-status="off"],
    .status-card[data-status="inactive"] {
      border-color: var(--color-status-inactive);
    }
    
    .status-icon {
      font-size: var(--font-size-2xl);
      flex-shrink: 0;
    }
    
    .status-info {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-xs);
      flex: 1;
    }
    
    .status-label {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      color: var(--color-text-secondary);
    }
    
    .status-value {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-medium);
      color: var(--color-text);
    }
    
    /* ===== Toast Notification Styles ===== */
    
    .toast-container {
      position: fixed;
      top: calc(var(--header-height) + var(--spacing-md));
      right: var(--spacing-md);
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
      max-width: 400px;
    }
    
    .toast {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      background-color: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-lg);
      opacity: 0;
      transform: translateX(100%);
      transition: opacity var(--transition-base), transform var(--transition-base);
    }
    
    .toast.show {
      opacity: 1;
      transform: translateX(0);
    }
    
    .toast-icon {
      font-size: var(--font-size-xl);
      flex-shrink: 0;
    }
    
    .toast-message {
      flex: 1;
      font-size: var(--font-size-sm);
      color: var(--color-text);
    }
    
    .toast-close {
      width: 24px;
      height: 24px;
      background: none;
      border: none;
      font-size: var(--font-size-lg);
      color: var(--color-text-secondary);
      cursor: pointer;
      border-radius: var(--border-radius-sm);
      transition: background-color var(--transition-fast);
    }
    
    .toast-close:hover {
      background-color: var(--color-hover);
    }
    
    /* ===== Search Results Styles ===== */
    
    .search-results {
      position: absolute;
      top: calc(var(--header-height) - var(--spacing-sm));
      right: var(--spacing-md);
      width: 350px;
      max-height: 400px;
      background-color: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-lg);
      overflow-y: auto;
      z-index: 1100;
    }
    
    .search-result {
      display: flex;
      flex-direction: column;
      padding: var(--spacing-md);
      cursor: pointer;
      border-bottom: 1px solid var(--color-border-light);
      transition: background-color var(--transition-fast);
      min-height: 44px;
    }
    
    .search-result:last-child {
      border-bottom: none;
    }
    
    .search-result:hover,
    .search-result.selected {
      background-color: var(--color-hover);
    }
    
    .search-result.selected {
      background-color: var(--color-primary);
      color: var(--color-text-inverse);
    }
    
    .result-label {
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-medium);
      color: var(--color-text);
      margin-bottom: var(--spacing-xs);
    }
    
    .search-result.selected .result-label {
      color: var(--color-text-inverse);
    }
    
    .result-section {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
    }
    
    .search-result.selected .result-section {
      color: var(--color-text-inverse);
      opacity: 0.9;
    }
    
    .search-no-results {
      padding: var(--spacing-lg);
      text-align: center;
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
    }
    
    .search-highlight {
      background-color: var(--color-warning);
      color: var(--color-text);
      padding: 2px 4px;
      border-radius: var(--border-radius-sm);
      animation: highlight-fade 2s ease-out;
    }
    
    @keyframes highlight-fade {
      0% {
        background-color: var(--color-warning);
      }
      100% {
        background-color: transparent;
      }
    }
    
    /* ===== Form Styles (Task 4) ===== */
    
    .config-form {
      background-color: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius);
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-lg);
      box-shadow: var(--shadow-sm);
    }
    
    .form-group {
      margin-bottom: var(--spacing-lg);
    }
    
    .form-group label {
      display: block;
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      color: var(--color-text);
      margin-bottom: var(--spacing-sm);
    }
    
    .form-group label .required {
      color: var(--color-danger);
      margin-left: var(--spacing-xs);
    }
    
    .form-group input[type="text"],
    .form-group input[type="email"],
    .form-group input[type="password"],
    .form-group input[type="url"],
    .form-group input[type="tel"],
    .form-group input[type="number"],
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: var(--spacing-sm) var(--spacing-md);
      font-size: var(--font-size-base);
      font-family: var(--font-family);
      color: var(--color-text);
      background-color: var(--color-bg);
      border: 1px solid var(--color-border);
      border-radius: var(--border-radius-sm);
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
    }
    
    .form-group input.invalid,
    .form-group select.invalid,
    .form-group textarea.invalid {
      border-color: var(--color-danger);
    }
    
    .form-group input.invalid:focus,
    .form-group select.invalid:focus,
    .form-group textarea.invalid:focus {
      box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
    }
    
    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .form-group input[type="checkbox"],
    .form-group input[type="radio"] {
      width: auto;
      margin-right: var(--spacing-sm);
    }
    
    .error-message {
      display: block;
      font-size: var(--font-size-sm);
      color: var(--color-danger);
      margin-top: var(--spacing-xs);
    }
    
    .form-help {
      display: block;
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      margin-top: var(--spacing-xs);
    }
    
    .form-actions {
      display: flex;
      gap: var(--spacing-md);
      margin-top: var(--spacing-xl);
      padding-top: var(--spacing-lg);
      border-top: 1px solid var(--color-border);
    }
    
    /* ===== Button Styles ===== */
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm) var(--spacing-lg);
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-medium);
      font-family: var(--font-family);
      color: var(--color-text-inverse);
      background-color: var(--color-primary);
      border: none;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      transition: background-color var(--transition-fast), transform var(--transition-fast), box-shadow var(--transition-fast);
      user-select: none;
      min-height: 44px;
    }
    
    .btn:hover:not(:disabled) {
      background-color: var(--color-primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    .btn:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .btn:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.3);
    }
    
    .btn-primary {
      background-color: var(--color-primary);
    }
    
    .btn-primary:hover:not(:disabled) {
      background-color: var(--color-primary-dark);
    }
    
    .btn-secondary {
      background-color: var(--color-text-secondary);
      color: var(--color-text-inverse);
    }
    
    .btn-secondary:hover:not(:disabled) {
      background-color: var(--color-text);
    }
    
    .btn-danger {
      background-color: var(--color-danger);
    }
    
    .btn-danger:hover:not(:disabled) {
      background-color: #c82333;
    }
    
    .btn-warning {
      background-color: var(--color-warning);
      color: var(--color-text);
    }
    
    .btn-warning:hover:not(:disabled) {
      background-color: #e0a800;
    }
    
    .btn-info {
      background-color: var(--color-info);
    }
    
    .btn-info:hover:not(:disabled) {
      background-color: #138496;
    }
    
    .btn-success {
      background-color: var(--color-success);
    }
    
    .btn-success:hover:not(:disabled) {
      background-color: #218838;
    }
    
    .btn-spinner {
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.7;
        transform: scale(1.1);
      }
    }
    
    .btn-sm {
      padding: var(--spacing-xs) var(--spacing-md);
      font-size: var(--font-size-sm);
      min-height: 32px;
    }
    
    .btn-lg {
      padding: var(--spacing-md) var(--spacing-xl);
      font-size: var(--font-size-lg);
      min-height: 48px;
    }
    
    /* ===== Dashboard Styles (Task 6) ===== */
    
    .dashboard-info-card {
      padding: var(--spacing-md);
      background-color: var(--color-bg);
      border-radius: var(--border-radius);
      border: 1px solid var(--color-border);
      transition: box-shadow var(--transition-fast);
    }
    
    .dashboard-info-card:hover {
      box-shadow: var(--shadow-md);
    }
    
    .dashboard-info-label {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--spacing-xs);
    }
    
    .dashboard-info-value {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-bold);
      color: var(--color-text);
    }
    
    .activity-entry {
      padding: var(--spacing-sm);
      border-bottom: 1px solid var(--color-border-light);
      display: flex;
      gap: var(--spacing-sm);
      align-items: start;
      transition: background-color var(--transition-fast);
    }
    
    .activity-entry:last-child {
      border-bottom: none;
    }
    
    .activity-entry:hover {
      background-color: var(--color-hover);
    }
    
    .activity-type {
      font-weight: var(--font-weight-bold);
      min-width: 60px;
      font-size: var(--font-size-sm);
    }
    
    .activity-timestamp {
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
      min-width: 80px;
    }
    
    .activity-message {
      flex: 1;
      color: var(--color-text);
      font-size: var(--font-size-sm);
      word-break: break-word;
    }
    
    /* ===== Dialog Styles (Task 4.4) ===== */
    
    .dialog-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      opacity: 0;
      transition: opacity var(--transition-base);
    }
    
    .dialog-overlay.show {
      opacity: 1;
    }
    
    .dialog {
      background-color: var(--color-surface);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-xl);
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.9);
      transition: transform var(--transition-base);
    }
    
    .dialog-overlay.show .dialog {
      transform: scale(1);
    }
    
    .dialog-header {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-lg);
      border-bottom: 1px solid var(--color-border);
    }
    
    .dialog-icon {
      font-size: var(--font-size-2xl);
      flex-shrink: 0;
    }
    
    .dialog-title {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-bold);
      color: var(--color-text);
      margin: 0;
    }
    
    .dialog-body {
      padding: var(--spacing-lg);
    }
    
    .dialog-message {
      font-size: var(--font-size-base);
      color: var(--color-text);
      line-height: 1.6;
      margin: 0;
    }
    
    .dialog-footer {
      display: flex;
      gap: var(--spacing-md);
      justify-content: flex-end;
      padding: var(--spacing-lg);
      border-top: 1px solid var(--color-border);
    }
    
    .dialog-warning .dialog-icon {
      color: var(--color-warning);
    }
    
    .dialog-danger .dialog-icon {
      color: var(--color-danger);
    }
    
    /* ===== OTA Update Styles (Task 14) ===== */
    
    #ota-drop-zone.dragging {
      border-color: var(--color-primary);
      background-color: rgba(76, 175, 80, 0.05);
    }
    
    #ota-progress-bar {
      transition: width 0.3s ease;
      background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-primary-light) 100%);
    }
    
    #ota-update-log {
      font-family: 'Courier New', Courier, monospace;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    #ota-update-log::-webkit-scrollbar {
      width: 8px;
    }
    
    #ota-update-log::-webkit-scrollbar-track {
      background: var(--color-bg);
      border-radius: var(--border-radius-sm);
    }
    
    #ota-update-log::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: var(--border-radius-sm);
    }
    
    #ota-update-log::-webkit-scrollbar-thumb:hover {
      background: var(--color-text-secondary);
    }
    
    /* ===== Documentation Styles (Task 15) ===== */
    
    .docs-section {
      margin-bottom: var(--spacing-md);
    }
    
    .docs-section-header {
      cursor: pointer;
      user-select: none;
      transition: background-color var(--transition-fast);
      padding: var(--spacing-sm);
      margin: calc(var(--spacing-md) * -1);
      margin-bottom: var(--spacing-md);
      border-radius: var(--border-radius);
    }
    
    .docs-section-header:hover {
      background-color: var(--color-hover);
    }
    
    .docs-toggle-icon {
      display: inline-block;
      transition: transform var(--transition-base);
      font-size: var(--font-size-sm);
    }
    
    .docs-section.collapsed .docs-toggle-icon {
      transform: rotate(-90deg);
    }
    
    .docs-section-content {
      max-height: 5000px;
      overflow: hidden;
      transition: max-height var(--transition-slow), opacity var(--transition-slow);
      opacity: 1;
    }
    
    .docs-section.collapsed .docs-section-content {
      max-height: 0;
      opacity: 0;
    }
    
    .docs-toc-link {
      display: block;
      padding: var(--spacing-sm) var(--spacing-md);
      color: var(--color-text);
      text-decoration: none;
      border-radius: var(--border-radius-sm);
      transition: background-color var(--transition-fast), color var(--transition-fast);
    }
    
    .docs-toc-link:hover {
      background-color: var(--color-hover);
      color: var(--color-primary);
    }
    
    .docs-search-highlight {
      background-color: var(--color-warning);
      color: var(--color-text);
      padding: 2px 4px;
      border-radius: var(--border-radius-sm);
    }
    
    .api-endpoint {
      padding: var(--spacing-md);
      background-color: var(--color-bg);
      border-radius: var(--border-radius-sm);
      border-left: 4px solid var(--color-primary);
    }
    
    /* ===== Responsive Design (Task 2.4) ===== */
    
    /* Mobile: < 768px */
    @media (max-width: 767px) {
      .menu-toggle {
        display: block;
      }
      
      .app-title {
        font-size: var(--font-size-base);
      }
      
      .version {
        display: none;
      }
      
      .sidebar {
        transform: translateX(-100%);
        box-shadow: none;
      }
      
      .sidebar.open {
        transform: translateX(0);
        box-shadow: var(--shadow-xl);
      }
      
      .main-content {
        margin-left: 0;
        padding: var(--spacing-md);
      }
      
      .status-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: var(--spacing-sm);
        padding: var(--spacing-md);
      }
      
      .status-card {
        padding: var(--spacing-sm);
        min-height: 60px;
      }
      
      .status-icon {
        font-size: var(--font-size-xl);
      }
      
      .status-label {
        font-size: var(--font-size-xs);
      }
      
      .status-value {
        font-size: var(--font-size-sm);
      }
      
      .toast-container {
        left: var(--spacing-sm);
        right: var(--spacing-sm);
        max-width: none;
      }
      
      .search-results {
        left: var(--spacing-sm);
        right: var(--spacing-sm);
        width: auto;
        top: var(--header-height);
      }
      
      .global-search {
        display: block;
        width: 100%;
        max-width: 200px;
      }
      
      /* Touch-friendly button sizes (minimum 44x44px) */
      .nav-item {
        min-height: 44px;
        padding: var(--spacing-sm) var(--spacing-md);
      }
      
      .status-toggle {
        min-height: 44px;
      }
      
      /* Touch-friendly form inputs */
      .form-group input[type="text"],
      .form-group input[type="email"],
      .form-group input[type="password"],
      .form-group input[type="url"],
      .form-group input[type="tel"],
      .form-group input[type="number"],
      .form-group select {
        min-height: 44px;
      }
      
      /* Ensure buttons in forms are touch-friendly */
      .btn-sm {
        min-height: 44px;
      }
    }
    
    /* Tablet: 768px - 1024px */
    @media (min-width: 768px) and (max-width: 1024px) {
      .sidebar {
        width: 200px;
      }
      
      .main-content {
        margin-left: 200px;
      }
      
      .nav-item {
        padding: var(--spacing-sm) var(--spacing-md);
      }
      
      .nav-label {
        font-size: var(--font-size-sm);
      }
      
      .global-search {
        width: 180px;
      }
      
      .status-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    /* Desktop: > 1024px */
    @media (min-width: 1025px) {
      .status-grid {
        grid-template-columns: repeat(4, 1fr);
      }
    }
    
    /* Large Desktop: > 1440px */
    @media (min-width: 1441px) {
      .main-content {
        max-width: 1400px;
        margin-left: auto;
        margin-right: auto;
        padding-left: calc(var(--sidebar-width) + var(--spacing-xl));
        padding-right: var(--spacing-xl);
      }
    }
    
    /* Mobile Overlay for Sidebar */
    @media (max-width: 767px) {
      .sidebar.open::before {
        content: '';
        position: fixed;
        top: var(--header-height);
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: -1;
      }
    }
    
    /* Reduced Motion Support */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
    
    /* High Contrast Mode Support */
    @media (prefers-contrast: high) {
      .status-card {
        border-width: 3px;
      }
      
      .nav-item.active {
        outline: 2px solid var(--color-text-inverse);
        outline-offset: -2px;
      }
    }
    
    /* Print Styles */
    @media print {
      .app-header,
      .sidebar,
      .status-panel,
      .toast-container {
        display: none;
      }
      
      .main-content {
        margin: 0;
        padding: 0;
      }
    }
    
    /* Hardware Testing State Indicators */
    .state-item.state-active {
      border-color: var(--color-status-connected) !important;
      background-color: rgba(76, 175, 80, 0.05);
    }
    
    .state-item.state-inactive {
      border-color: var(--color-status-inactive) !important;
    }
    
    .state-item.state-on {
      border-color: var(--color-warning) !important;
      background-color: rgba(255, 193, 7, 0.05);
    }
    
    .state-item.state-off {
      border-color: var(--color-status-inactive) !important;
    }
    
    .state-item.state-pressed {
      border-color: var(--color-primary) !important;
      background-color: rgba(76, 175, 80, 0.1);
    }
    
    .state-value-active {
      color: var(--color-status-connected) !important;
    }
    
    .state-value-inactive {
      color: var(--color-status-inactive) !important;
    }
    
    .state-value-on {
      color: var(--color-warning) !important;
    }
    
    .state-value-off {
      color: var(--color-status-inactive) !important;
    }
    
    .state-value-pressed {
      color: var(--color-primary) !important;
    }
  </style>
</head>
<body>
  
  <!-- Header -->
  <header class="app-header">
    <button class="menu-toggle" aria-label="Toggle navigation menu" aria-expanded="false" aria-controls="sidebar">
      ‚ò∞
    </button>
    <h1 class="app-title">ESP32 SIP Door Station</h1>
    <div class="header-actions">
      <input type="search" 
             class="global-search" 
             id="global-search"
             placeholder="Search settings... (Ctrl+K)"
             autocomplete="off"
             aria-label="Search settings">
      <button class="theme-toggle" aria-label="Toggle theme" id="theme-toggle">
        üåô
      </button>
      <span class="version">v1.0</span>
    </div>
  </header>

  <!-- Sidebar Navigation -->
  <nav class="sidebar" id="sidebar" role="navigation" aria-label="Main navigation">
    <ul class="nav-menu">
      <li class="nav-item active" data-section="dashboard">
        <span class="nav-icon">üè†</span>
        <span class="nav-label">Dashboard</span>
        <span class="unsaved-indicator" hidden>‚óè</span>
      </li>
      <li class="nav-item" data-section="sip">
        <span class="nav-icon">üìû</span>
        <span class="nav-label">SIP Settings</span>
        <span class="unsaved-indicator" hidden>‚óè</span>
      </li>
      <li class="nav-item" data-section="network">
        <span class="nav-icon">üåê</span>
        <span class="nav-label">Network</span>
        <span class="unsaved-indicator" hidden>‚óè</span>
      </li>
      <li class="nav-item" data-section="hardware">
        <span class="nav-icon">‚öôÔ∏è</span>
        <span class="nav-label">Hardware</span>
        <span class="unsaved-indicator" hidden>‚óè</span>
      </li>
      <li class="nav-item" data-section="security">
        <span class="nav-icon">üîí</span>
        <span class="nav-label">Security</span>
        <span class="unsaved-indicator" hidden>‚óè</span>
      </li>
      <li class="nav-item" data-section="logs">
        <span class="nav-icon">üìã</span>
        <span class="nav-label">System Logs</span>
        <span class="unsaved-indicator" hidden>‚óè</span>
      </li>
      <li class="nav-item" data-section="testing">
        <span class="nav-icon">üß™</span>
        <span class="nav-label">Hardware Testing</span>
        <span class="unsaved-indicator" hidden>‚óè</span>
      </li>
      <li class="nav-item" data-section="email">
        <span class="nav-icon">üìß</span>
        <span class="nav-label">Email Reports</span>
        <span class="unsaved-indicator" hidden>‚óè</span>
      </li>
      <li class="nav-item" data-section="ota">
        <span class="nav-icon">üîÑ</span>
        <span class="nav-label">OTA Update</span>
        <span class="unsaved-indicator" hidden>‚óè</span>
      </li>
      <li class="nav-item" data-section="docs">
        <span class="nav-icon">üìñ</span>
        <span class="nav-label">Documentation</span>
        <span class="unsaved-indicator" hidden>‚óè</span>
      </li>
    </ul>
  </nav>

  <!-- Main Content Area -->
  <main class="main-content" id="main-content">
    
    <!-- Status Panel (Collapsible) -->
    <div class="status-panel" id="status-panel">
      <button class="status-toggle" aria-label="Toggle status panel" aria-expanded="true" aria-controls="status-content">
        <span>Status</span>
        <span class="toggle-icon">‚ñº</span>
      </button>
      <div class="status-content" id="status-content">
        <div class="status-grid">
          <div class="status-card" id="wifi-status" data-status="disconnected" role="status" aria-live="polite" aria-label="WiFi connection status">
            <span class="status-icon">üì∂</span>
            <div class="status-info">
              <span class="status-label">WiFi</span>
              <span class="status-value">Disconnected</span>
            </div>
          </div>
          <div class="status-card" id="sip-status" data-status="disconnected" role="status" aria-live="polite" aria-label="SIP connection status">
            <span class="status-icon">üìû</span>
            <div class="status-info">
              <span class="status-label">SIP</span>
              <span class="status-value">Disconnected</span>
            </div>
          </div>
          <div class="status-card" id="door-status" data-status="closed" role="status" aria-live="polite" aria-label="Door status">
            <span class="status-icon">üö™</span>
            <div class="status-info">
              <span class="status-label">Door</span>
              <span class="status-value">Closed</span>
            </div>
          </div>
          <div class="status-card" id="light-status" data-status="off" role="status" aria-live="polite" aria-label="Light status">
            <span class="status-icon">üí°</span>
            <div class="status-info">
              <span class="status-label">Light</span>
              <span class="status-value">Off</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Dashboard Section -->
    <section class="content-section active" id="section-dashboard">
      <h2 tabindex="-1">Dashboard</h2>
      
      <!-- Certificate Expiration Warnings (Task 22) -->
      <!-- Warning banner for certificate expiring within 30 days -->
      <div id="cert-expiry-warning-banner" style="display: none; padding: var(--spacing-md); background-color: rgba(255, 193, 7, 0.1); border: 1px solid var(--color-warning); border-radius: var(--border-radius); margin-bottom: var(--spacing-lg);">
        <div style="display: flex; align-items: flex-start; gap: var(--spacing-md);">
          <span style="font-size: var(--font-size-2xl); flex-shrink: 0;">‚ö†Ô∏è</span>
          <div style="flex: 1;">
            <h3 style="margin: 0 0 var(--spacing-xs) 0; color: var(--color-warning); font-size: var(--font-size-lg);">Certificate Expiring Soon</h3>
            <p id="cert-expiry-warning-text" style="margin: 0 0 var(--spacing-md) 0; color: var(--color-text);">
              Your TLS certificate will expire soon. Please renew or generate a new certificate to maintain secure access.
            </p>
            <button class="btn btn-sm btn-warning" onclick="navigateToSection('security'); scrollToElement('cert-info-panel');">
              <span>üîê</span>
              <span>Manage Certificate</span>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Critical warning banner for certificate expiring within 7 days -->
      <div id="cert-expiry-critical-banner" style="display: none; padding: var(--spacing-md); background-color: rgba(220, 53, 69, 0.1); border: 2px solid var(--color-danger); border-radius: var(--border-radius); margin-bottom: var(--spacing-lg);">
        <div style="display: flex; align-items: flex-start; gap: var(--spacing-md);">
          <span style="font-size: var(--font-size-2xl); flex-shrink: 0; animation: pulse 2s ease-in-out infinite;">üö®</span>
          <div style="flex: 1;">
            <h3 style="margin: 0 0 var(--spacing-xs) 0; color: var(--color-danger); font-size: var(--font-size-lg);">Critical: Certificate Expiring Very Soon</h3>
            <p id="cert-expiry-critical-text" style="margin: 0 0 var(--spacing-md) 0; color: var(--color-text); font-weight: var(--font-weight-medium);">
              Your TLS certificate will expire in less than 7 days! Immediate action required to prevent loss of secure access.
            </p>
            <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
              <button class="btn btn-sm btn-danger" onclick="navigateToSection('security'); scrollToElement('cert-info-panel');">
                <span>üîê</span>
                <span>Manage Certificate Now</span>
              </button>
              <button class="btn btn-sm btn-secondary" onclick="generateSelfSignedCertificateQuick()">
                <span>‚ö°</span>
                <span>Quick Generate New Certificate</span>
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Error banner for expired certificate -->
      <div id="cert-expired-banner" style="display: none; padding: var(--spacing-md); background-color: rgba(220, 53, 69, 0.15); border: 2px solid var(--color-danger); border-radius: var(--border-radius); margin-bottom: var(--spacing-lg);">
        <div style="display: flex; align-items: flex-start; gap: var(--spacing-md);">
          <span style="font-size: var(--font-size-2xl); flex-shrink: 0; animation: pulse 2s ease-in-out infinite;">‚ùå</span>
          <div style="flex: 1;">
            <h3 style="margin: 0 0 var(--spacing-xs) 0; color: var(--color-danger); font-size: var(--font-size-lg);">Certificate Expired!</h3>
            <p style="margin: 0 0 var(--spacing-md) 0; color: var(--color-text); font-weight: var(--font-weight-medium);">
              Your TLS certificate has expired! Browsers will show security warnings. Generate a new certificate immediately.
            </p>
            <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
              <button class="btn btn-sm btn-danger" onclick="generateSelfSignedCertificateQuick()">
                <span>üîê</span>
                <span>Generate New Certificate</span>
              </button>
              <button class="btn btn-sm btn-secondary" onclick="navigateToSection('security'); scrollToElement('cert-info-panel');">
                <span>‚öôÔ∏è</span>
                <span>Certificate Settings</span>
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- System Information Display (Task 6.1) -->
      <div class="config-form">
        <h3 style="margin-bottom: var(--spacing-md);">System Information</h3>
        <div id="system-info" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md);">
          <div style="padding: var(--spacing-md); background-color: var(--color-bg); border-radius: var(--border-radius); border: 1px solid var(--color-border);">
            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">Uptime</div>
            <div id="system-uptime" style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-text);">Loading...</div>
          </div>
          <div style="padding: var(--spacing-md); background-color: var(--color-bg); border-radius: var(--border-radius); border: 1px solid var(--color-border);">
            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">Free Heap</div>
            <div id="system-heap" style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-text);">Loading...</div>
          </div>
          <div style="padding: var(--spacing-md); background-color: var(--color-bg); border-radius: var(--border-radius); border: 1px solid var(--color-border);">
            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">IP Address</div>
            <div id="system-ip" style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-text);">Loading...</div>
          </div>
          <div style="padding: var(--spacing-md); background-color: var(--color-bg); border-radius: var(--border-radius); border: 1px solid var(--color-border);">
            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">Firmware Version</div>
            <div id="system-version" style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-text);">Loading...</div>
          </div>
        </div>
      </div>
      
      <!-- NTP Sync Status (Task 6.3) -->
      <div class="config-form">
        <h3 style="margin-bottom: var(--spacing-md);">Time Synchronization</h3>
        <div id="ntp-status" style="display: flex; align-items: center; gap: var(--spacing-lg); flex-wrap: wrap;">
          <div style="flex: 1; min-width: 200px;">
            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">NTP Sync Status</div>
            <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
              <span id="ntp-sync-indicator" style="font-size: var(--font-size-xl);">‚è≥</span>
              <span id="ntp-sync-text" style="font-size: var(--font-size-base); font-weight: var(--font-weight-medium); color: var(--color-text);">Checking...</span>
            </div>
          </div>
          <div style="flex: 1; min-width: 200px;">
            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">Current Time</div>
            <div id="ntp-current-time" style="font-size: var(--font-size-base); font-weight: var(--font-weight-medium); color: var(--color-text);">Loading...</div>
          </div>
        </div>
      </div>
      
      <!-- Quick Actions (Task 6.2) -->
      <div class="config-form">
        <h3 style="margin-bottom: var(--spacing-md);">Quick Actions</h3>
        <p style="margin-bottom: var(--spacing-lg); color: var(--color-text-secondary);">
          Perform common system actions. Destructive actions will require confirmation.
        </p>
        
        <div style="display: flex; gap: var(--spacing-md); flex-wrap: wrap;">
          <button class="btn btn-success" onclick="handleSIPConnect()" id="quick-sip-connect">
            <span>üìû</span>
            <span>Connect SIP</span>
          </button>
          <button class="btn btn-warning" onclick="handleSIPDisconnect()" id="quick-sip-disconnect">
            <span>üì¥</span>
            <span>Disconnect SIP</span>
          </button>
          <button class="btn btn-warning" onclick="handleSystemRestart()" id="system-restart-btn">
            <span>üîÑ</span>
            <span>Restart System</span>
          </button>
          <button class="btn btn-danger" onclick="handleFactoryReset()" id="factory-reset-btn">
            <span>‚ö†Ô∏è</span>
            <span>Factory Reset</span>
          </button>
        </div>
      </div>
      
      <!-- Recent Activity Summary (Task 6.4) -->
      <div class="config-form">
        <h3 style="margin-bottom: var(--spacing-md);">Recent Activity</h3>
        <div id="recent-activity" style="max-height: 300px; overflow-y: auto; background-color: var(--color-bg); border: 1px solid var(--color-border); border-radius: var(--border-radius); padding: var(--spacing-md);">
          <div style="text-align: center; color: var(--color-text-secondary); padding: var(--spacing-lg);">Loading recent activity...</div>
        </div>
      </div>
      
      <!-- Backup/Restore Functionality (Task 6.5) -->
      <div class="config-form">
        <h3 style="margin-bottom: var(--spacing-md);">Configuration Backup & Restore</h3>
        <p style="margin-bottom: var(--spacing-lg); color: var(--color-text-secondary);">
          Backup your configuration to a JSON file or restore from a previous backup.
        </p>
        
        <div style="display: flex; gap: var(--spacing-md); flex-wrap: wrap; margin-bottom: var(--spacing-lg);">
          <button class="btn btn-primary" onclick="handleBackupConfig()">
            <span>üíæ</span>
            <span>Download Backup</span>
          </button>
          <button class="btn btn-info" onclick="document.getElementById('restore-file-input').click()">
            <span>üìÇ</span>
            <span>Restore from File</span>
          </button>
          <input type="file" id="restore-file-input" accept=".json" style="display: none;" onchange="handleRestoreFileSelected(event)">
        </div>
        
        <div class="form-group" style="margin-bottom: 0;">
          <label>
            <input type="checkbox" id="backup-include-passwords" checked>
            Include passwords in backup (recommended for security: uncheck)
          </label>
          <span class="form-help">Unchecking this will exclude sensitive passwords from the backup file</span>
        </div>
      </div>
    </section>

    <!-- SIP Settings Section (Task 7) -->
    <section class="content-section" id="section-sip" hidden>
      <h2 tabindex="-1">SIP Settings</h2>
      
      <!-- Task 7.1: SIP Configuration Form -->
      <form class="config-form" id="sip-form" data-api="/api/sip/config">
        <h3 style="margin-bottom: var(--spacing-md);">SIP Server Configuration</h3>
        <p style="margin-bottom: var(--spacing-lg); color: var(--color-text-secondary);">
          Configure your SIP server connection and call targets. All fields marked with * are required.
        </p>
        
        <div class="form-group">
          <label for="sip-server">
            SIP Server
            <span class="required">*</span>
          </label>
          <input 
            type="text" 
            id="sip-server" 
            name="server" 
            required
            pattern="^[a-zA-Z0-9.-]+$"
            data-error="Please enter a valid server address (letters, numbers, dots, and hyphens only)"
            placeholder="sip.example.com">
          <span class="error-message" hidden></span>
          <span class="form-help">Enter your SIP server domain or IP address</span>
        </div>
        
        <div class="form-group">
          <label for="sip-username">
            Username
            <span class="required">*</span>
          </label>
          <input 
            type="text" 
            id="sip-username" 
            name="username" 
            required
            minlength="3"
            data-error="Username must be at least 3 characters"
            placeholder="doorstation">
          <span class="error-message" hidden></span>
          <span class="form-help">SIP account username for authentication</span>
        </div>
        
        <div class="form-group">
          <label for="sip-password">
            Password
            <span class="required">*</span>
          </label>
          <input 
            type="password" 
            id="sip-password" 
            name="password" 
            required
            minlength="6"
            data-error="Password must be at least 6 characters"
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          <span class="error-message" hidden></span>
          <span class="form-help">SIP account password for authentication</span>
        </div>
        
        <div class="form-group">
          <label for="sip-target1">
            Target 1 (Apartment 1)
            <span class="required">*</span>
          </label>
          <input 
            type="text" 
            id="sip-target1" 
            name="target1" 
            required
            pattern="^sip:[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+$"
            data-error="Please enter a valid SIP URI (e.g., sip:user@domain.com)"
            placeholder="sip:apartment1@example.com">
          <span class="error-message" hidden></span>
          <span class="form-help">SIP URI to call when doorbell button 1 is pressed</span>
        </div>
        
        <div class="form-group">
          <label for="sip-target2">
            Target 2 (Apartment 2)
          </label>
          <input 
            type="text" 
            id="sip-target2" 
            name="target2" 
            pattern="^sip:[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+$"
            data-error="Please enter a valid SIP URI (e.g., sip:user@domain.com)"
            placeholder="sip:apartment2@example.com">
          <span class="error-message" hidden></span>
          <span class="form-help">Optional second target for dual apartment setup (doorbell button 2)</span>
        </div>
        
        <div class="form-actions">
          <button type="submit" class="btn btn-primary" disabled>
            <span class="btn-text">Save Configuration</span>
            <span class="btn-spinner" hidden>‚è≥</span>
          </button>
          <button type="reset" class="btn btn-secondary">Reset</button>
        </div>
      </form>
      
      <!-- Task 7.2: Test Call Buttons -->
      <div class="config-form" style="margin-top: var(--spacing-lg);">
        <h3 style="margin-bottom: var(--spacing-md);">Test Calls</h3>
        <p style="margin-bottom: var(--spacing-lg); color: var(--color-text-secondary);">
          Test your SIP configuration by initiating a test call to each target. Make sure you have saved your configuration first.
        </p>
        
        <div style="display: flex; gap: var(--spacing-md); flex-wrap: wrap;">
          <button class="btn btn-info" onclick="handleTestCall(1)" id="test-call-target1">
            <span class="btn-text">
              <span>üìû</span>
              <span>Test Call Target 1</span>
            </span>
            <span class="btn-spinner" hidden>‚è≥</span>
          </button>
          <button class="btn btn-info" onclick="handleTestCall(2)" id="test-call-target2">
            <span class="btn-text">
              <span>üìû</span>
              <span>Test Call Target 2</span>
            </span>
            <span class="btn-spinner" hidden>‚è≥</span>
          </button>
        </div>
        
        <div id="test-call-feedback" style="margin-top: var(--spacing-md); padding: var(--spacing-md); background-color: var(--color-bg); border-radius: var(--border-radius); border: 1px solid var(--color-border); display: none;">
          <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
            <span id="test-call-icon" style="font-size: var(--font-size-xl);"></span>
            <span id="test-call-message" style="font-size: var(--font-size-base); color: var(--color-text);"></span>
          </div>
        </div>
      </div>
      
      <!-- Task 7.3: Connection Management -->
      <div class="config-form" style="margin-top: var(--spacing-lg);">
        <h3 style="margin-bottom: var(--spacing-md);">Connection Management</h3>
        <p style="margin-bottom: var(--spacing-lg); color: var(--color-text-secondary);">
          Manage your SIP server connection. You must be connected to receive incoming calls.
        </p>
        
        <div style="display: flex; gap: var(--spacing-md); flex-wrap: wrap; margin-bottom: var(--spacing-lg);">
          <button class="btn btn-success" onclick="handleSIPConnectEnhanced()" id="sip-connect-btn">
            <span class="btn-text">
              <span>üìû</span>
              <span>Connect to SIP</span>
            </span>
            <span class="btn-spinner" hidden>‚è≥</span>
          </button>
          <button class="btn btn-warning" onclick="handleSIPDisconnectEnhanced()" id="sip-disconnect-btn">
            <span class="btn-text">
              <span>üì¥</span>
              <span>Disconnect</span>
            </span>
            <span class="btn-spinner" hidden>‚è≥</span>
          </button>
          <button class="btn btn-info" onclick="handleSIPTestEnhanced()" id="sip-test-btn">
            <span class="btn-text">
              <span>üß™</span>
              <span>Test Configuration</span>
            </span>
            <span class="btn-spinner" hidden>‚è≥</span>
          </button>
        </div>
        
        <!-- Connection Status Display -->
        <div style="padding: var(--spacing-md); background-color: var(--color-bg); border-radius: var(--border-radius); border: 1px solid var(--color-border);">
          <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">Current Connection Status</div>
          <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
            <span id="sip-connection-icon" style="font-size: var(--font-size-xl);">‚è≥</span>
            <span id="sip-connection-status" style="font-size: var(--font-size-base); font-weight: var(--font-weight-medium); color: var(--color-text);">Checking...</span>
          </div>
        </div>
      </div>
    </section>

    <!-- Network Settings Section (Task 8) -->
    <section class="content-section" id="section-network" hidden>
      <h2 tabindex="-1">Network Settings</h2>
      
      <!-- Task 8.1: WiFi Configuration -->
      <div class="config-form">
        <h3 style="margin-bottom: var(--spacing-md);">WiFi Configuration</h3>
        <p style="margin-bottom: var(--spacing-lg); color: var(--color-text-secondary);">
          Configure your WiFi connection. Scan for available networks or enter credentials manually.
        </p>
        
        <!-- WiFi Scan -->
        <div style="margin-bottom: var(--spacing-lg);">
          <button class="btn btn-info" onclick="handleWiFiScan()" id="wifi-scan-btn">
            <span class="btn-text">
              <span>üîç</span>
              <span>Scan for Networks</span>
            </span>
            <span class="btn-spinner" hidden>‚è≥</span>
          </button>
        </div>
        
        <!-- Network List -->
        <div id="wifi-network-list" style="display: none; margin-bottom: var(--spacing-lg);">
          <h4 style="margin-bottom: var(--spacing-md); font-size: var(--font-size-base);">Available Networks</h4>
          <div id="wifi-networks" style="max-height: 300px; overflow-y: auto; background-color: var(--color-bg); border: 1px solid var(--color-border); border-radius: var(--border-radius); padding: var(--spacing-sm);">
            <!-- Networks will be populated here -->
          </div>
        </div>
        
        <!-- WiFi Connection Form -->
        <form id="wifi-form" data-api="/api/wifi/connect">
          <div class="form-group">
            <label for="wifi-ssid">
              Network Name (SSID)
              <span class="required">*</span>
            </label>
            <input 
              type="text" 
              id="wifi-ssid" 
              name="ssid" 
              required
              minlength="1"
              maxlength="32"
              data-error="Please enter a valid SSID (1-32 characters)"
              placeholder="MyNetwork">
            <span class="error-message" hidden></span>
            <span class="form-help">Enter the WiFi network name</span>
          </div>
          
          <div class="form-group">
            <label for="wifi-password">
              Password
            </label>
            <input 
              type="password" 
              id="wifi-password" 
              name="password" 
              minlength="8"
              maxlength="63"
              data-error="Password must be 8-63 characters"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            <span class="error-message" hidden></span>
            <span class="form-help">Leave empty for open networks</span>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="btn btn-primary" disabled>
              <span class="btn-text">Connect to WiFi</span>
              <span class="btn-spinner" hidden>‚è≥</span>
            </button>
            <button type="reset" class="btn btn-secondary">Reset</button>
          </div>
        </form>
      </div>
      
      <!-- Task 8.2: IP Configuration -->
      <div class="config-form">
        <h3 style="margin-bottom: var(--spacing-md);">IP Configuration</h3>
        <p style="margin-bottom: var(--spacing-lg); color: var(--color-text-secondary);">
          Configure network IP settings. Use DHCP for automatic configuration or Static IP for manual setup.
        </p>
        
        <form id="ip-config-form" data-api="/api/network/ip">
          <!-- DHCP/Static Toggle -->
          <div class="form-group">
            <label>IP Address Mode</label>
            <div style="display: flex; gap: var(--spacing-lg); margin-top: var(--spacing-sm);">
              <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                <input type="radio" name="mode" value="dhcp" id="ip-mode-dhcp" checked onchange="toggleIPMode()">
                <span>DHCP (Automatic)</span>
              </label>
              <label style="display: flex; align-items: center; gap: var(--spacing-sm); cursor: pointer;">
                <input type="radio" name="mode" value="static" id="ip-mode-static" onchange="toggleIPMode()">
                <span>Static IP (Manual)</span>
              </label>
            </div>
            <span class="form-help">DHCP automatically assigns IP settings, Static IP requires manual configuration</span>
          </div>
          
          <!-- Current IP Display -->
          <div class="form-group">
            <label>Current IP Configuration</label>
            <div style="padding: var(--spacing-md); background-color: var(--color-bg); border-radius: var(--border-radius); border: 1px solid var(--color-border);">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--spacing-md);">
                <div>
                  <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">IP Address</div>
                  <div id="current-ip" style="font-weight: var(--font-weight-medium); color: var(--color-text);">Loading...</div>
                </div>
                <div>
                  <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">Mode</div>
                  <div id="current-mode" style="font-weight: var(--font-weight-medium); color: var(--color-text);">Loading...</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Static IP Fields (hidden by default) -->
          <div id="static-ip-fields" style="display: none;">
            <div class="form-group">
              <label for="static-ip">
                IP Address
                <span class="required">*</span>
              </label>
              <input 
                type="text" 
                id="static-ip" 
                name="ip" 
                pattern="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$"
                data-error="Please enter a valid IP address (e.g., 192.168.1.100)"
                placeholder="192.168.1.100">
              <span class="error-message" hidden></span>
            </div>
            
            <div class="form-group">
              <label for="subnet-mask">
                Subnet Mask
                <span class="required">*</span>
              </label>
              <input 
                type="text" 
                id="subnet-mask" 
                name="subnet" 
                pattern="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$"
                data-error="Please enter a valid subnet mask (e.g., 255.255.255.0)"
                placeholder="255.255.255.0">
              <span class="error-message" hidden></span>
            </div>
            
            <div class="form-group">
              <label for="gateway">
                Gateway
                <span class="required">*</span>
              </label>
              <input 
                type="text" 
                id="gateway" 
                name="gateway" 
                pattern="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$"
                data-error="Please enter a valid gateway address (e.g., 192.168.1.1)"
                placeholder="192.168.1.1">
              <span class="error-message" hidden></span>
            </div>
            
            <div class="form-group">
              <label for="dns1">
                Primary DNS Server
                <span class="required">*</span>
              </label>
              <input 
                type="text" 
                id="dns1" 
                name="dns1" 
                pattern="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$"
                data-error="Please enter a valid DNS server address (e.g., 8.8.8.8)"
                placeholder="8.8.8.8">
              <span class="error-message" hidden></span>
              <span class="form-help">Google DNS: 8.8.8.8, Cloudflare DNS: 1.1.1.1</span>
            </div>
            
            <div class="form-group">
              <label for="dns2">
                Secondary DNS Server
              </label>
              <input 
                type="text" 
                id="dns2" 
                name="dns2" 
                pattern="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$"
                data-error="Please enter a valid DNS server address"
                placeholder="8.8.4.4">
              <span class="error-message" hidden></span>
              <span class="form-help">Optional secondary DNS server</span>
            </div>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="btn btn-primary" disabled>
              <span class="btn-text">Save IP Configuration</span>
              <span class="btn-spinner" hidden>‚è≥</span>
            </button>
            <button type="reset" class="btn btn-secondary">Reset</button>
          </div>
        </form>
      </div>
      
      <!-- Task 8.3: NTP Configuration -->
      <div class="config-form">
        <h3 style="margin-bottom: var(--spacing-md);">Time Synchronization (NTP)</h3>
        <p style="margin-bottom: var(--spacing-lg); color: var(--color-text-secondary);">
          Configure Network Time Protocol (NTP) settings for automatic time synchronization.
        </p>
        
        <form id="ntp-config-form" data-api="/api/ntp/config">
          <div class="form-group">
            <label for="ntp-server">
              NTP Server
              <span class="required">*</span>
            </label>
            <input 
              type="text" 
              id="ntp-server" 
              name="server" 
              required
              pattern="^[a-zA-Z0-9.-]+$"
              data-error="Please enter a valid NTP server address"
              placeholder="pool.ntp.org">
            <span class="error-message" hidden></span>
            <span class="form-help">Common servers: pool.ntp.org, time.google.com, time.cloudflare.com</span>
          </div>
          
          <div class="form-group">
            <label for="timezone">
              Timezone
              <span class="required">*</span>
            </label>
            <select id="timezone" name="timezone" required>
              <option value="">Select timezone...</option>
              <option value="UTC">UTC (GMT+0)</option>
              <option value="Europe/London">Europe/London (GMT+0/+1)</option>
              <option value="Europe/Paris">Europe/Paris (GMT+1/+2)</option>
              <option value="Europe/Berlin">Europe/Berlin (GMT+1/+2)</option>
              <option value="Europe/Rome">Europe/Rome (GMT+1/+2)</option>
              <option value="Europe/Madrid">Europe/Madrid (GMT+1/+2)</option>
              <option value="Europe/Athens">Europe/Athens (GMT+2/+3)</option>
              <option value="Europe/Moscow">Europe/Moscow (GMT+3)</option>
              <option value="America/New_York">America/New_York (EST/EDT)</option>
              <option value="America/Chicago">America/Chicago (CST/CDT)</option>
              <option value="America/Denver">America/Denver (MST/MDT)</option>
              <option value="America/Los_Angeles">America/Los_Angeles (PST/PDT)</option>
              <option value="America/Toronto">America/Toronto (EST/EDT)</option>
              <option value="America/Mexico_City">America/Mexico_City (CST/CDT)</option>
              <option value="America/Sao_Paulo">America/Sao_Paulo (BRT)</option>
              <option value="Asia/Dubai">Asia/Dubai (GMT+4)</option>
              <option value="Asia/Kolkata">Asia/Kolkata (IST)</option>
              <option value="Asia/Shanghai">Asia/Shanghai (CST)</option>
              <option value="Asia/Tokyo">Asia/Tokyo (JST)</option>
              <option value="Asia/Seoul">Asia/Seoul (KST)</option>
              <option value="Asia/Singapore">Asia/Singapore (SGT)</option>
              <option value="Australia/Sydney">Australia/Sydney (AEDT/AEST)</option>
              <option value="Australia/Melbourne">Australia/Melbourne (AEDT/AEST)</option>
              <option value="Pacific/Auckland">Pacific/Auckland (NZDT/NZST)</option>
            </select>
            <span class="error-message" hidden></span>
            <span class="form-help">Select your local timezone for accurate time display</span>
          </div>
          
          <!-- Current NTP Status -->
          <div class="form-group">
            <label>Current Sync Status</label>
            <div style="padding: var(--spacing-md); background-color: var(--color-bg); border-radius: var(--border-radius); border: 1px solid var(--color-border);">
              <div style="display: flex; align-items: center; gap: var(--spacing-md); flex-wrap: wrap;">
                <div style="flex: 1; min-width: 200px;">
                  <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">Sync Status</div>
                  <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                    <span id="ntp-status-icon" style="font-size: var(--font-size-xl);">‚è≥</span>
                    <span id="ntp-status-text" style="font-weight: var(--font-weight-medium); color: var(--color-text);">Checking...</span>
                  </div>
                </div>
                <div style="flex: 1; min-width: 200px;">
                  <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">Current Time</div>
                  <div id="ntp-status-time" style="font-weight: var(--font-weight-medium); color: var(--color-text);">Loading...</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="btn btn-primary" disabled>
              <span class="btn-text">Save NTP Configuration</span>
              <span class="btn-spinner" hidden>‚è≥</span>
            </button>
            <button type="button" class="btn btn-info" onclick="handleNTPForceSync()">
              <span class="btn-text">
                <span>üîÑ</span>
                <span>Force Sync Now</span>
              </span>
              <span class="btn-spinner" hidden>‚è≥</span>
            </button>
            <button type="reset" class="btn btn-secondary">Reset</button>
          </div>
        </form>
      </div>
    </section>

    <!-- Hardware Settings Section (Task 9) -->
    <section class="content-section" id="section-hardware" hidden>
      <h2 tabindex="-1">Hardware Settings</h2>
      
      <!-- Task 9.1: Hardware Information Display -->
      <div class="config-form">
        <h3 style="margin-bottom: var(--spacing-md);">Hardware Information</h3>
        <p style="margin-bottom: var(--spacing-lg); color: var(--color-text-secondary);">
          ESP32-S3 hardware specifications and memory status. Information updates every 10 seconds.
        </p>
        
        <div id="hardware-info" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md);">
          <div class="dashboard-info-card">
            <div class="dashboard-info-label">Chip Model</div>
            <div id="hw-chip-model" class="dashboard-info-value">Loading...</div>
          </div>
          <div class="dashboard-info-card">
            <div class="dashboard-info-label">Chip Revision</div>
            <div id="hw-chip-revision" class="dashboard-info-value">Loading...</div>
          </div>
          <div class="dashboard-info-card">
            <div class="dashboard-info-label">Flash Size</div>
            <div id="hw-flash-size" class="dashboard-info-value">Loading...</div>
          </div>
          <div class="dashboard-info-card">
            <div class="dashboard-info-label">Flash Available</div>
            <div id="hw-flash-free" class="dashboard-info-value">Loading...</div>
          </div>
          <div class="dashboard-info-card">
            <div class="dashboard-info-label">PSRAM Size</div>
            <div id="hw-psram-size" class="dashboard-info-value">Loading...</div>
          </div>
          <div class="dashboard-info-card">
            <div class="dashboard-info-label">PSRAM Free</div>
            <div id="hw-psram-free" class="dashboard-info-value">Loading...</div>
          </div>
          <div class="dashboard-info-card">
            <div class="dashboard-info-label">Free Heap</div>
            <div id="hw-free-heap" class="dashboard-info-value">Loading...</div>
          </div>
          <div class="dashboard-info-card">
            <div class="dashboard-info-label">Min Free Heap</div>
            <div id="hw-min-heap" class="dashboard-info-value">Loading...</div>
          </div>
        </div>
      </div>
      
      <!-- Task 9.2: GPIO Pin Assignments -->
      <div class="config-form">
        <h3 style="margin-bottom: var(--spacing-md);">GPIO Pin Assignments</h3>
        <p style="margin-bottom: var(--spacing-lg); color: var(--color-text-secondary);">
          GPIO pin configuration and current states for all hardware interfaces.
        </p>
        
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background-color: var(--color-bg); border-bottom: 2px solid var(--color-border);">
                <th style="padding: var(--spacing-md); text-align: left; font-weight: var(--font-weight-bold); color: var(--color-text);">GPIO Pin</th>
                <th style="padding: var(--spacing-md); text-align: left; font-weight: var(--font-weight-bold); color: var(--color-text);">Function</th>
                <th style="padding: var(--spacing-md); text-align: center; font-weight: var(--font-weight-bold); color: var(--color-text);">Current State</th>
              </tr>
            </thead>
            <tbody id="gpio-table-body">
              <tr style="border-bottom: 1px solid var(--color-border-light);">
                <td style="padding: var(--spacing-md); font-family: monospace; font-weight: var(--font-weight-medium);">GPIO 21</td>
                <td style="padding: var(--spacing-md);">Doorbell Button 1</td>
                <td style="padding: var(--spacing-md); text-align: center;">
                  <span id="gpio-21-state" style="display: inline-block; padding: 4px 12px; border-radius: var(--border-radius-sm); background-color: var(--color-status-inactive); color: var(--color-text-inverse); font-size: var(--font-size-sm); font-weight: var(--font-weight-medium);">Inactive</span>
                </td>
              </tr>
              <tr style="border-bottom: 1px solid var(--color-border-light);">
                <td style="padding: var(--spacing-md); font-family: monospace; font-weight: var(--font-weight-medium);">GPIO 4</td>
                <td style="padding: var(--spacing-md);">Doorbell Button 2</td>
                <td style="padding: var(--spacing-md); text-align: center;">
                  <span id="gpio-4-state" style="display: inline-block; padding: 4px 12px; border-radius: var(--border-radius-sm); background-color: var(--color-status-inactive); color: var(--color-text-inverse); font-size: var(--font-size-sm); font-weight: var(--font-weight-medium);">Inactive</span>
                </td>
              </tr>
              <tr style="border-bottom: 1px solid var(--color-border-light);">
                <td style="padding: var(--spacing-md); font-family: monospace; font-weight: var(--font-weight-medium);">GPIO 5</td>
                <td style="padding: var(--spacing-md);">Door Opener Relay</td>
                <td style="padding: var(--spacing-md); text-align: center;">
                  <span id="gpio-5-state" style="display: inline-block; padding: 4px 12px; border-radius: var(--border-radius-sm); background-color: var(--color-status-inactive); color: var(--color-text-inverse); font-size: var(--font-size-sm); font-weight: var(--font-weight-medium);">Inactive</span>
                </td>
              </tr>
              <tr style="border-bottom: 1px solid var(--color-border-light);">
                <td style="padding: var(--spacing-md); font-family: monospace; font-weight: var(--font-weight-medium);">GPIO 6</td>
                <td style="padding: var(--spacing-md);">Light Control Relay</td>
                <td style="padding: var(--spacing-md); text-align: center;">
                  <span id="gpio-6-state" style="display: inline-block; padding: 4px 12px; border-radius: var(--border-radius-sm); background-color: var(--color-status-inactive); color: var(--color-text-inverse); font-size: var(--font-size-sm); font-weight: var(--font-weight-medium);">Inactive</span>
                </td>
              </tr>
              <tr style="border-bottom: 1px solid var(--color-border-light);">
                <td style="padding: var(--spacing-md); font-family: monospace; font-weight: var(--font-weight-medium);">GPIO 0</td>
                <td style="padding: var(--spacing-md);">BOOT Button (Testing)</td>
                <td style="padding: var(--spacing-md); text-align: center;">
                  <span id="gpio-0-state" style="display: inline-block; padding: 4px 12px; border-radius: var(--border-radius-sm); background-color: var(--color-status-inactive); color: var(--color-text-inverse); font-size: var(--font-size-sm); font-weight: var(--font-weight-medium);">Inactive</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Task 9.3: DTMF Control Codes -->
      <div class="config-form">
        <h3 style="margin-bottom: var(--spacing-md);">DTMF Control Codes</h3>
        <p style="margin-bottom: var(--spacing-lg); color: var(--color-text-secondary);">
          DTMF (Dual-Tone Multi-Frequency) codes that can be sent during a call to control the door station.
        </p>
        
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background-color: var(--color-bg); border-bottom: 2px solid var(--color-border);">
                <th style="padding: var(--spacing-md); text-align: left; font-weight: var(--font-weight-bold); color: var(--color-text);">DTMF Code</th>
                <th style="padding: var(--spacing-md); text-align: left; font-weight: var(--font-weight-bold); color: var(--color-text);">Action</th>
                <th style="padding: var(--spacing-md); text-align: left; font-weight: var(--font-weight-bold); color: var(--color-text);">Description</th>
              </tr>
            </thead>
            <tbody>
              <tr style="border-bottom: 1px solid var(--color-border-light);">
                <td style="padding: var(--spacing-md); font-family: monospace; font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-primary);">*1</td>
                <td style="padding: var(--spacing-md); font-weight: var(--font-weight-medium);">Open Door</td>
                <td style="padding: var(--spacing-md); color: var(--color-text-secondary);">Activates door opener relay for 3 seconds</td>
              </tr>
              <tr style="border-bottom: 1px solid var(--color-border-light);">
                <td style="padding: var(--spacing-md); font-family: monospace; font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-primary);">*2</td>
                <td style="padding: var(--spacing-md); font-weight: var(--font-weight-medium);">Toggle Light</td>
                <td style="padding: var(--spacing-md); color: var(--color-text-secondary);">Toggles light control relay on/off</td>
              </tr>
              <tr style="border-bottom: 1px solid var(--color-border-light);">
                <td style="padding: var(--spacing-md); font-family: monospace; font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-primary);">#</td>
                <td style="padding: var(--spacing-md); font-weight: var(--font-weight-medium);">Hang Up</td>
                <td style="padding: var(--spacing-md); color: var(--color-text-secondary);">Ends the current call</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div style="margin-top: var(--spacing-lg); padding: var(--spacing-md); background-color: var(--color-bg); border-left: 4px solid var(--color-info); border-radius: var(--border-radius);">
          <div style="display: flex; align-items: start; gap: var(--spacing-sm);">
            <span style="font-size: var(--font-size-xl);">‚ÑπÔ∏è</span>
            <div>
              <div style="font-weight: var(--font-weight-medium); margin-bottom: var(--spacing-xs);">How to use DTMF codes</div>
              <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                During an active call, use your phone's keypad to enter these codes. The door station will respond to the commands in real-time.
                If PIN protection is enabled in Security Settings, you must enter the correct PIN before using control codes.
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Task 9.4: Button and Relay Assignments -->
      <div class="config-form">
        <h3 style="margin-bottom: var(--spacing-md);">Button and Relay Assignments</h3>
        <p style="margin-bottom: var(--spacing-lg); color: var(--color-text-secondary);">
          Physical button assignments and relay output configurations with current states.
        </p>
        
        <!-- Doorbell Buttons -->
        <h4 style="margin-bottom: var(--spacing-md); font-size: var(--font-size-base); color: var(--color-text);">Doorbell Buttons</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-xl);">
          <div style="padding: var(--spacing-md); background-color: var(--color-bg); border-radius: var(--border-radius); border: 1px solid var(--color-border);">
            <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-sm);">
              <span style="font-size: var(--font-size-2xl);">üîî</span>
              <div style="flex: 1;">
                <div style="font-weight: var(--font-weight-bold); color: var(--color-text);">Bell 1 (GPIO 21)</div>
                <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">Apartment 1</div>
              </div>
            </div>
            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">Action:</div>
            <div style="font-size: var(--font-size-sm); color: var(--color-text);">Calls SIP Target 1</div>
            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: var(--spacing-xs);">Last Press:</div>
            <div id="bell1-last-press" style="font-size: var(--font-size-sm); color: var(--color-text); font-family: monospace;">Never</div>
          </div>
          
          <div style="padding: var(--spacing-md); background-color: var(--color-bg); border-radius: var(--border-radius); border: 1px solid var(--color-border);">
            <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-sm);">
              <span style="font-size: var(--font-size-2xl);">üîî</span>
              <div style="flex: 1;">
                <div style="font-weight: var(--font-weight-bold); color: var(--color-text);">Bell 2 (GPIO 4)</div>
                <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">Apartment 2</div>
              </div>
            </div>
            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">Action:</div>
            <div style="font-size: var(--font-size-sm); color: var(--color-text);">Calls SIP Target 2</div>
            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: var(--spacing-xs);">Last Press:</div>
            <div id="bell2-last-press" style="font-size: var(--font-size-sm); color: var(--color-text); font-family: monospace;">Never</div>
          </div>
        </div>
        
        <!-- Relay Outputs -->
        <h4 style="margin-bottom: var(--spacing-md); font-size: var(--font-size-base); color: var(--color-text);">Relay Outputs</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-md);">
          <div style="padding: var(--spacing-md); background-color: var(--color-bg); border-radius: var(--border-radius); border: 1px solid var(--color-border);">
            <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-sm);">
              <span style="font-size: var(--font-size-2xl);">üö™</span>
              <div style="flex: 1;">
                <div style="font-weight: var(--font-weight-bold); color: var(--color-text);">Door Opener (GPIO 5)</div>
                <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">Electric Strike/Maglock</div>
              </div>
            </div>
            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">Current State:</div>
            <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm);">
              <span id="door-relay-indicator" style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: var(--color-status-inactive);"></span>
              <span id="door-relay-state" style="font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-text);">Inactive</span>
            </div>
            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: var(--spacing-xs);">Last Activation:</div>
            <div id="door-last-activation" style="font-size: var(--font-size-sm); color: var(--color-text); font-family: monospace;">Never</div>
          </div>
          
          <div style="padding: var(--spacing-md); background-color: var(--color-bg); border-radius: var(--border-radius); border: 1px solid var(--color-border);">
            <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-sm);">
              <span style="font-size: var(--font-size-2xl);">üí°</span>
              <div style="flex: 1;">
                <div style="font-weight: var(--font-weight-bold); color: var(--color-text);">Light Control (GPIO 6)</div>
                <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">Entrance Light</div>
              </div>
            </div>
            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">Current State:</div>
            <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm);">
              <span id="light-relay-indicator" style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: var(--color-status-inactive);"></span>
              <span id="light-relay-state" style="font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-text);">Off</span>
            </div>
            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: var(--spacing-xs);">Last Toggle:</div>
            <div id="light-last-toggle" style="font-size: var(--font-size-sm); color: var(--color-text); font-family: monospace;">Never</div>
          </div>
        </div>
      </div>
      
      <!-- Task 9.5: BOOT Button Testing Information -->
      <div class="config-form">
        <h3 style="margin-bottom: var(--spacing-md);">BOOT Button Testing</h3>
        <p style="margin-bottom: var(--spacing-lg); color: var(--color-text-secondary);">
          The BOOT button (GPIO 0) can be used for testing and diagnostics during development.
        </p>
        
        <div style="padding: var(--spacing-lg); background-color: var(--color-bg); border-radius: var(--border-radius); border: 1px solid var(--color-border);">
          <div style="display: flex; align-items: start; gap: var(--spacing-lg); margin-bottom: var(--spacing-lg);">
            <div style="flex: 1;">
              <div style="font-weight: var(--font-weight-bold); color: var(--color-text); margin-bottom: var(--spacing-sm);">GPIO Pin</div>
              <div style="font-family: monospace; font-size: var(--font-size-lg); color: var(--color-primary);">GPIO 0</div>
            </div>
            <div style="flex: 1;">
              <div style="font-weight: var(--font-weight-bold); color: var(--color-text); margin-bottom: var(--spacing-sm);">Function</div>
              <div style="font-size: var(--font-size-base); color: var(--color-text);">BOOT / Test Button</div>
            </div>
            <div style="flex: 1;">
              <div style="font-weight: var(--font-weight-bold); color: var(--color-text); margin-bottom: var(--spacing-sm);">Current State</div>
              <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
                <span id="boot-button-indicator" style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: var(--color-status-inactive);"></span>
                <span id="boot-button-state" style="font-size: var(--font-size-base); font-weight: var(--font-weight-medium); color: var(--color-text);">Not Pressed</span>
              </div>
            </div>
          </div>
          
          <div style="padding: var(--spacing-md); background-color: var(--color-surface); border-radius: var(--border-radius); border-left: 4px solid var(--color-info);">
            <div style="font-weight: var(--font-weight-bold); color: var(--color-text); margin-bottom: var(--spacing-sm);">Testing Instructions</div>
            <ol style="margin-left: var(--spacing-lg); color: var(--color-text-secondary); font-size: var(--font-size-sm); line-height: 1.8;">
              <li>The BOOT button is typically located on the ESP32-S3 development board</li>
              <li>Press and hold the BOOT button to test input detection</li>
              <li>The button state should update in real-time above</li>
              <li>During firmware upload, hold BOOT while pressing RESET to enter download mode</li>
              <li>In normal operation, the BOOT button can be used for custom test functions</li>
            </ol>
          </div>
          
          <div style="margin-top: var(--spacing-md); padding: var(--spacing-md); background-color: var(--color-surface); border-radius: var(--border-radius); border-left: 4px solid var(--color-warning);">
            <div style="display: flex; align-items: start; gap: var(--spacing-sm);">
              <span style="font-size: var(--font-size-xl);">‚ö†Ô∏è</span>
              <div>
                <div style="font-weight: var(--font-weight-medium); margin-bottom: var(--spacing-xs); color: var(--color-text);">Note</div>
                <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                  GPIO 0 is a strapping pin. Holding it LOW during boot will put the ESP32-S3 into download mode. 
                  Only use this button for testing when the device is already running.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Security Settings Section -->
    <section class="content-section" id="section-security" hidden>
      <h2 tabindex="-1">Security Settings</h2>
      
      <!-- Current Security Status (Task 10.2) -->
      <div class="status-panel">
        <div class="status-content">
          <div class="status-grid">
            <div class="status-card" id="security-pin-status">
              <span class="status-icon">üîí</span>
              <div class="status-info">
                <span class="status-label">PIN Protection</span>
                <span class="status-value" id="security-pin-enabled">‚ùå Disabled</span>
              </div>
            </div>
            <div class="status-card">
              <span class="status-icon">üî¢</span>
              <div class="status-info">
                <span class="status-label">PIN Code</span>
                <span class="status-value" id="security-pin-code">****</span>
              </div>
            </div>
            <div class="status-card">
              <span class="status-icon">‚è±Ô∏è</span>
              <div class="status-info">
                <span class="status-label">Timeout</span>
                <span class="status-value" id="security-timeout">10000 ms</span>
              </div>
            </div>
            <div class="status-card">
              <span class="status-icon">üîÅ</span>
              <div class="status-info">
                <span class="status-label">Max Attempts</span>
                <span class="status-value" id="security-max-attempts">3</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Admin Password Change Form -->
      <form class="config-form" id="password-change-form" onsubmit="handlePasswordChange(event)">
        <h3>Admin Password</h3>
        <p class="form-help">Change the administrator password for web interface access.</p>
        
        <div class="form-group">
          <label for="current-password">
            Current Password <span class="required">*</span>
          </label>
          <input type="password" 
                 id="current-password" 
                 name="current_password" 
                 required
                 autocomplete="current-password"
                 placeholder="Enter current password"
                 data-error="Current password is required">
          <span class="error-message" hidden></span>
        </div>
        
        <div class="form-group">
          <label for="new-password">
            New Password <span class="required">*</span>
          </label>
          <input type="password" 
                 id="new-password" 
                 name="new_password" 
                 required
                 autocomplete="new-password"
                 minlength="8"
                 placeholder="Enter new password"
                 data-error="Password must be at least 8 characters with uppercase, lowercase, and digit"
                 aria-describedby="password-requirements">
          <span class="error-message" hidden></span>
          <span class="form-help" id="password-requirements">
            Must be at least 8 characters with uppercase, lowercase, and digit
          </span>
        </div>
        
        <div class="form-group">
          <label for="confirm-new-password">
            Confirm New Password <span class="required">*</span>
          </label>
          <input type="password" 
                 id="confirm-new-password" 
                 name="confirm_password" 
                 required
                 autocomplete="new-password"
                 minlength="8"
                 placeholder="Re-enter new password"
                 data-error="Passwords must match">
          <span class="error-message" hidden></span>
        </div>
        
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">
            <span class="btn-text">Change Password</span>
            <span class="btn-spinner" hidden>‚è≥</span>
          </button>
          <button type="reset" class="btn btn-secondary">Clear</button>
        </div>
      </form>
      
      <!-- DTMF Security Configuration Form (Task 10.1) -->
      <form class="config-form" id="security-form" data-api="/api/dtmf/security" data-on-success="onSecuritySaved">
        <h3>DTMF PIN Protection</h3>
        <p class="form-help">Configure PIN protection for DTMF commands to prevent unauthorized access to door opener and other controls.</p>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="security-pin-enable" name="pin_enabled">
            Enable PIN Protection
          </label>
          <span class="form-help">When enabled, DTMF commands will require PIN authentication</span>
        </div>
        
        <div class="form-group">
          <label for="security-pin-input">
            PIN Code <span class="required">*</span>
          </label>
          <input type="text" 
                 id="security-pin-input" 
                 name="pin_code" 
                 required
                 pattern="^\d{1,8}$"
                 minlength="1"
                 maxlength="8"
                 placeholder="Enter 1-8 digit PIN"
                 data-error="PIN must be 1-8 digits only"
                 aria-describedby="pin-help">
          <span class="error-message" hidden></span>
          <span class="form-help" id="pin-help">Enter a numeric PIN code (1-8 digits)</span>
        </div>
        
        <div class="form-group">
          <label for="security-timeout-input">
            Timeout (ms) <span class="required">*</span>
          </label>
          <input type="number" 
                 id="security-timeout-input" 
                 name="timeout_ms" 
                 required
                 min="5000"
                 max="30000"
                 step="1000"
                 placeholder="10000"
                 data-error="Timeout must be between 5000 and 30000 ms"
                 aria-describedby="timeout-help">
          <span class="error-message" hidden></span>
          <span class="form-help" id="timeout-help">Time to wait for PIN entry (5000-30000 ms)</span>
        </div>
        
        <div class="form-group">
          <label for="security-max-attempts-input">
            Max Attempts <span class="required">*</span>
          </label>
          <input type="number" 
                 id="security-max-attempts-input" 
                 name="max_attempts" 
                 required
                 min="1"
                 max="10"
                 step="1"
                 placeholder="3"
                 data-error="Max attempts must be between 1 and 10"
                 aria-describedby="attempts-help">
          <span class="error-message" hidden></span>
          <span class="form-help" id="attempts-help">Maximum number of failed PIN attempts before lockout (1-10)</span>
        </div>
        
        <div class="form-actions">
          <button type="submit" class="btn btn-primary" disabled>
            <span class="btn-text">Save Security Settings</span>
            <span class="btn-spinner" hidden>‚è≥</span>
          </button>
          <button type="reset" class="btn btn-secondary">Reset</button>
        </div>
      </form>
      
      <div class="config-form">
        <h3>Security Information</h3>
        <p>DTMF PIN protection adds an extra layer of security to prevent unauthorized access to door controls during a call.</p>
        <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
          <li><strong>PIN Protection:</strong> When enabled, callers must enter the correct PIN before using DTMF commands</li>
          <li><strong>Timeout:</strong> Maximum time allowed for PIN entry before the system rejects the attempt</li>
          <li><strong>Max Attempts:</strong> Number of failed PIN attempts before the system temporarily locks out further attempts</li>
          <li><strong>Security Best Practices:</strong> Use a PIN that is not easily guessable and change it regularly</li>
        </ul>
      </div>
      
      <!-- Certificate Management Section (Task 18) -->
      <div class="config-form">
        <h3>TLS Certificate Management</h3>
        <p style="margin-bottom: var(--spacing-lg); color: var(--color-text-secondary);">
          Manage HTTPS certificates for secure web interface access. The device can use self-signed certificates or custom certificates from a trusted Certificate Authority.
        </p>
        
        <!-- Certificate Information Display (Task 18: Display current certificate information) -->
        <div id="cert-info-panel" style="padding: var(--spacing-md); background-color: var(--color-bg); border: 1px solid var(--color-border); border-radius: var(--border-radius); margin-bottom: var(--spacing-lg);">
          <h4 style="margin-top: 0; margin-bottom: var(--spacing-md);">Current Certificate</h4>
          
          <!-- Certificate Expiration Warning (Task 18: Display warning when certificate is expiring soon) -->
          <div id="cert-expiry-warning" style="display: none; padding: var(--spacing-md); background-color: rgba(255, 193, 7, 0.1); border: 1px solid var(--color-warning); border-radius: var(--border-radius); margin-bottom: var(--spacing-md);">
            <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
              <span style="font-size: var(--font-size-xl);">‚ö†Ô∏è</span>
              <div>
                <strong style="color: var(--color-warning);">Certificate Expiring Soon</strong>
                <p style="margin: var(--spacing-xs) 0 0 0; font-size: var(--font-size-sm); color: var(--color-text-secondary);" id="cert-expiry-warning-text">
                  Your certificate will expire soon. Please renew or generate a new certificate.
                </p>
              </div>
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md);">
            <div>
              <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">Certificate Type</div>
              <div id="cert-type" style="font-size: var(--font-size-base); font-weight: var(--font-weight-medium); color: var(--color-text);">Loading...</div>
            </div>
            <div>
              <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">Common Name (CN)</div>
              <div id="cert-cn" style="font-size: var(--font-size-base); font-weight: var(--font-weight-medium); color: var(--color-text);">Loading...</div>
            </div>
            <div>
              <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">Issuer</div>
              <div id="cert-issuer" style="font-size: var(--font-size-base); font-weight: var(--font-weight-medium); color: var(--color-text);">Loading...</div>
            </div>
            <div>
              <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">Valid From</div>
              <div id="cert-valid-from" style="font-size: var(--font-size-base); font-weight: var(--font-weight-medium); color: var(--color-text);">Loading...</div>
            </div>
            <div>
              <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">Expires</div>
              <div id="cert-expires" style="font-size: var(--font-size-base); font-weight: var(--font-weight-medium); color: var(--color-text);">Loading...</div>
            </div>
            <div>
              <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">Days Remaining</div>
              <div id="cert-days-remaining" style="font-size: var(--font-size-base); font-weight: var(--font-weight-medium); color: var(--color-text);">Loading...</div>
            </div>
          </div>
          
          <!-- Download Certificate Button (Task 18: Add download button for current certificate) -->
          <div style="margin-top: var(--spacing-md);">
            <button class="btn btn-sm btn-secondary" onclick="downloadCertificate()">
              <span>üíæ</span>
              <span>Download Certificate</span>
            </button>
          </div>
        </div>
        
        <!-- Generate Self-Signed Certificate (Task 18: Add button to generate new self-signed certificate) -->
        <div style="padding: var(--spacing-md); background-color: var(--color-bg); border: 1px solid var(--color-border); border-radius: var(--border-radius); margin-bottom: var(--spacing-lg);">
          <h4 style="margin-top: 0; margin-bottom: var(--spacing-md);">Generate Self-Signed Certificate</h4>
          <p style="margin-bottom: var(--spacing-md); color: var(--color-text-secondary); font-size: var(--font-size-sm);">
            Generate a new self-signed certificate for HTTPS. This is suitable for internal use but will show a security warning in browsers.
          </p>
          
          <div class="form-group" style="margin-bottom: var(--spacing-md);">
            <label for="cert-common-name">
              Common Name (CN)
              <span class="required">*</span>
            </label>
            <input 
              type="text" 
              id="cert-common-name" 
              placeholder="doorstation.local"
              value="doorstation.local"
              style="width: 100%; padding: var(--spacing-sm) var(--spacing-md); border: 1px solid var(--color-border); border-radius: var(--border-radius-sm); background-color: var(--color-surface); color: var(--color-text);">
            <span class="form-help">Hostname or domain name for the certificate</span>
          </div>
          
          <button class="btn btn-primary" onclick="generateSelfSignedCertificate()" id="generate-cert-btn">
            <span class="btn-text">
              <span>üîê</span>
              <span>Generate Certificate</span>
            </span>
            <span class="btn-spinner" hidden>‚è≥</span>
          </button>
        </div>
        
        <!-- Upload Custom Certificate (Task 18: Add file upload interface for custom certificate and private key) -->
        <div style="padding: var(--spacing-md); background-color: var(--color-bg); border: 1px solid var(--color-border); border-radius: var(--border-radius); margin-bottom: var(--spacing-lg);">
          <h4 style="margin-top: 0; margin-bottom: var(--spacing-md);">Upload Custom Certificate</h4>
          <p style="margin-bottom: var(--spacing-md); color: var(--color-text-secondary); font-size: var(--font-size-sm);">
            Upload a custom certificate and private key from a trusted Certificate Authority. Both files must be in PEM format.
          </p>
          
          <div class="form-group" style="margin-bottom: var(--spacing-md);">
            <label for="cert-file-input">
              Certificate File (PEM)
              <span class="required">*</span>
            </label>
            <input 
              type="file" 
              id="cert-file-input" 
              accept=".pem,.crt,.cer"
              style="width: 100%; padding: var(--spacing-sm); border: 1px solid var(--color-border); border-radius: var(--border-radius-sm); background-color: var(--color-surface); color: var(--color-text);">
            <span class="form-help">Select your certificate file (.pem, .crt, or .cer)</span>
          </div>
          
          <div class="form-group" style="margin-bottom: var(--spacing-md);">
            <label for="key-file-input">
              Private Key File (PEM)
              <span class="required">*</span>
            </label>
            <input 
              type="file" 
              id="key-file-input" 
              accept=".pem,.key"
              style="width: 100%; padding: var(--spacing-sm); border: 1px solid var(--color-border); border-radius: var(--border-radius-sm); background-color: var(--color-surface); color: var(--color-text);">
            <span class="form-help">Select your private key file (.pem or .key)</span>
          </div>
          
          <div class="form-group" style="margin-bottom: var(--spacing-md);">
            <label for="chain-file-input">
              Certificate Chain (Optional)
            </label>
            <input 
              type="file" 
              id="chain-file-input" 
              accept=".pem,.crt,.cer"
              style="width: 100%; padding: var(--spacing-sm); border: 1px solid var(--color-border); border-radius: var(--border-radius-sm); background-color: var(--color-surface); color: var(--color-text);">
            <span class="form-help">Optional: Certificate chain for intermediate CAs</span>
          </div>
          
          <button class="btn btn-primary" onclick="uploadCustomCertificate()" id="upload-cert-btn">
            <span class="btn-text">
              <span>üì§</span>
              <span>Upload Certificate</span>
            </span>
            <span class="btn-spinner" hidden>‚è≥</span>
          </button>
        </div>
        
        <!-- Certificate Information -->
        <div style="padding: var(--spacing-md); background-color: rgba(23, 162, 184, 0.1); border: 1px solid var(--color-info); border-radius: var(--border-radius);">
          <h4 style="margin-top: 0; margin-bottom: var(--spacing-md); color: var(--color-info);">‚ÑπÔ∏è Certificate Information</h4>
          <ul style="margin: 0; padding-left: var(--spacing-lg); line-height: 1.8; font-size: var(--font-size-sm);">
            <li><strong>Self-Signed Certificates:</strong> Generated automatically by the device. Browsers will show a security warning, but the connection is still encrypted.</li>
            <li><strong>Custom Certificates:</strong> Obtained from a trusted Certificate Authority (CA) like Let's Encrypt. No browser warnings.</li>
            <li><strong>Certificate Expiration:</strong> Certificates expire after a set period. You'll receive warnings 30 days before expiration.</li>
            <li><strong>PEM Format:</strong> Certificates and keys must be in PEM format (Base64 encoded text starting with -----BEGIN CERTIFICATE-----).</li>
            <li><strong>Security:</strong> Always keep your private key secure. Never share it or store it in an insecure location.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- System Logs Section (Task 11) -->
    <section class="content-section" id="section-logs" hidden>
      <h2 tabindex="-1">System Logs</h2>
      
      <!-- Task 11.1: SIP Connection Log Display -->
      <div class="config-form">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
          <h3 style="margin: 0;">SIP Connection Logs</h3>
          <div style="display: flex; gap: var(--spacing-sm);">
            <label style="display: flex; align-items: center; gap: var(--spacing-xs); cursor: pointer;">
              <input type="checkbox" id="sip-log-auto-refresh" checked>
              <span style="font-size: var(--font-size-sm);">Auto-refresh</span>
            </label>
            <button class="btn btn-sm btn-info" onclick="refreshSIPLogs()" id="sip-log-refresh-btn">
              <span>üîÑ</span>
              <span>Refresh</span>
            </button>
            <button class="btn btn-sm btn-secondary" onclick="clearSIPLogDisplay()">
              <span>üóëÔ∏è</span>
              <span>Clear Display</span>
            </button>
          </div>
        </div>
        
        <!-- Task 11.3: Log Search and Filtering for SIP Logs -->
        <div style="margin-bottom: var(--spacing-md);">
          <div style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm); flex-wrap: wrap;">
            <input 
              type="search" 
              id="sip-log-search" 
              placeholder="Search SIP logs..." 
              style="flex: 1; min-width: 200px; padding: var(--spacing-sm) var(--spacing-md); border: 1px solid var(--color-border); border-radius: var(--border-radius-sm); background-color: var(--color-bg); color: var(--color-text);">
            <div style="display: flex; gap: var(--spacing-xs); flex-wrap: wrap;">
              <button class="btn btn-sm" onclick="filterSIPLogs('all')" data-filter="all" style="background-color: var(--color-text-secondary);">All</button>
              <button class="btn btn-sm" onclick="filterSIPLogs('error')" data-filter="error" style="background-color: var(--color-danger);">Errors</button>
              <button class="btn btn-sm" onclick="filterSIPLogs('info')" data-filter="info" style="background-color: var(--color-info);">Info</button>
              <button class="btn btn-sm" onclick="filterSIPLogs('sent')" data-filter="sent" style="background-color: var(--color-primary);">Sent</button>
              <button class="btn btn-sm" onclick="filterSIPLogs('received')" data-filter="received" style="background-color: var(--color-warning);">Received</button>
            </div>
          </div>
          <div id="sip-log-filter-count" style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">
            Showing all entries
          </div>
        </div>
        
        <!-- SIP Log Container -->
        <div id="sip-log-container" style="position: relative; max-height: 400px; overflow-y: auto; background-color: var(--color-bg); border: 1px solid var(--color-border); border-radius: var(--border-radius); padding: var(--spacing-md); font-family: 'Courier New', monospace; font-size: var(--font-size-sm);">
          <div style="text-align: center; color: var(--color-text-secondary); padding: var(--spacing-lg);">Loading SIP logs...</div>
        </div>
        
        <!-- Task 11.5: Jump to Bottom Button -->
        <button id="sip-log-jump-bottom" class="btn btn-sm btn-info" onclick="jumpToBottomSIPLog()" style="position: absolute; bottom: var(--spacing-lg); right: var(--spacing-lg); display: none; box-shadow: var(--shadow-lg);">
          <span>‚¨áÔ∏è</span>
          <span>Jump to Bottom</span>
        </button>
        
        <!-- Task 11.4: Log Export Functionality -->
        <div style="margin-top: var(--spacing-md); display: flex; justify-content: flex-end;">
          <button class="btn btn-sm btn-secondary" onclick="exportSIPLogs()">
            <span>üíæ</span>
            <span>Export to File</span>
          </button>
        </div>
      </div>
      
      <!-- Task 11.2: DTMF Security Log Display -->
      <div class="config-form" style="margin-top: var(--spacing-lg);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
          <h3 style="margin: 0;">DTMF Security Logs</h3>
          <div style="display: flex; gap: var(--spacing-sm);">
            <label style="display: flex; align-items: center; gap: var(--spacing-xs); cursor: pointer;">
              <input type="checkbox" id="dtmf-log-auto-refresh" checked>
              <span style="font-size: var(--font-size-sm);">Auto-refresh</span>
            </label>
            <button class="btn btn-sm btn-info" onclick="refreshDTMFLogs()" id="dtmf-log-refresh-btn">
              <span>üîÑ</span>
              <span>Refresh</span>
            </button>
            <button class="btn btn-sm btn-secondary" onclick="clearDTMFLogDisplay()">
              <span>üóëÔ∏è</span>
              <span>Clear Display</span>
            </button>
          </div>
        </div>
        
        <!-- Task 11.3: Log Search and Filtering for DTMF Logs -->
        <div style="margin-bottom: var(--spacing-md);">
          <div style="display: flex; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm); flex-wrap: wrap;">
            <input 
              type="search" 
              id="dtmf-log-search" 
              placeholder="Search DTMF logs..." 
              style="flex: 1; min-width: 200px; padding: var(--spacing-sm) var(--spacing-md); border: 1px solid var(--color-border); border-radius: var(--border-radius-sm); background-color: var(--color-bg); color: var(--color-text);">
            <div style="display: flex; gap: var(--spacing-xs); flex-wrap: wrap;">
              <button class="btn btn-sm" onclick="filterDTMFLogs('all')" data-filter="all" style="background-color: var(--color-text-secondary);">All</button>
              <button class="btn btn-sm" onclick="filterDTMFLogs('success')" data-filter="success" style="background-color: var(--color-success);">Success</button>
              <button class="btn btn-sm" onclick="filterDTMFLogs('failed')" data-filter="failed" style="background-color: var(--color-danger);">Failed</button>
            </div>
          </div>
          <div id="dtmf-log-filter-count" style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">
            Showing all entries
          </div>
        </div>
        
        <!-- DTMF Log Container -->
        <div id="dtmf-log-container" style="position: relative; max-height: 400px; overflow-y: auto; background-color: var(--color-bg); border: 1px solid var(--color-border); border-radius: var(--border-radius); padding: var(--spacing-md); font-family: 'Courier New', monospace; font-size: var(--font-size-sm);">
          <div style="text-align: center; color: var(--color-text-secondary); padding: var(--spacing-lg);">Loading DTMF logs...</div>
        </div>
        
        <!-- Task 11.5: Jump to Bottom Button -->
        <button id="dtmf-log-jump-bottom" class="btn btn-sm btn-info" onclick="jumpToBottomDTMFLog()" style="position: absolute; bottom: var(--spacing-lg); right: var(--spacing-lg); display: none; box-shadow: var(--shadow-lg);">
          <span>‚¨áÔ∏è</span>
          <span>Jump to Bottom</span>
        </button>
        
        <!-- Task 11.4: Log Export Functionality -->
        <div style="margin-top: var(--spacing-md); display: flex; justify-content: flex-end;">
          <button class="btn btn-sm btn-secondary" onclick="exportDTMFLogs()">
            <span>üíæ</span>
            <span>Export to File</span>
          </button>
        </div>
      </div>
      
      <!-- Task 20: Login Audit Logs -->
      <div class="config-form" style="margin-top: var(--spacing-lg);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
          <h3 style="margin: 0;">Login Audit Logs</h3>
          <div style="display: flex; gap: var(--spacing-sm);">
            <label style="display: flex; align-items: center; gap: var(--spacing-xs); cursor: pointer;">
              <input type="checkbox" id="login-log-auto-refresh" checked>
              <span style="font-size: var(--font-size-sm);">Auto-refresh</span>
            </label>
            <button class="btn btn-sm btn-info" onclick="refreshLoginLogs()" id="login-log-refresh-btn">
              <span>üîÑ</span>
              <span>Refresh</span>
            </button>
          </div>
        </div>
        
        <p class="form-help">View the last 50 login attempts including successful logins, failed attempts, and blocked IPs.</p>
        
        <!-- Login Log Container -->
        <div id="login-log-container" style="max-height: 400px; overflow-y: auto; background-color: var(--color-bg); border: 1px solid var(--color-border); border-radius: var(--border-radius); padding: var(--spacing-md);">
          <div style="text-align: center; color: var(--color-text-secondary); padding: var(--spacing-lg);">Loading login logs...</div>
        </div>
      </div>
    </section>

    <!-- Hardware Testing Section -->
    <section class="content-section" id="section-testing" hidden>
      <h2 tabindex="-1">Hardware Testing</h2>
      
      <!-- Warning Box -->
      <div class="config-form" style="background-color: rgba(255, 193, 7, 0.1); border-left: 4px solid var(--color-warning);">
        <div style="display: flex; align-items: start; gap: var(--spacing-md);">
          <span style="font-size: var(--font-size-2xl); flex-shrink: 0;">‚ö†Ô∏è</span>
          <div>
            <h3 style="margin: 0 0 var(--spacing-sm) 0; color: var(--color-warning); font-size: var(--font-size-lg);">‚ö†Ô∏è Safety Warning - Read Before Testing</h3>
            <p style="margin: 0 0 var(--spacing-md) 0; color: var(--color-text); font-size: var(--font-size-sm); line-height: 1.6;">
              <strong>Testing will physically activate relays and may trigger SIP calls.</strong>
            </p>
            <div style="margin: 0; color: var(--color-text); font-size: var(--font-size-sm); line-height: 1.8;">
              <strong>Before testing, verify:</strong>
              <ul style="margin: var(--spacing-xs) 0 0 var(--spacing-lg); padding: 0;">
                <li><strong>Proper wiring:</strong> All connections are secure and correct</li>
                <li><strong>Safe operation:</strong> Door mechanisms are safe to activate</li>
                <li><strong>Clear area:</strong> No one is near the door or equipment</li>
                <li><strong>Equipment protection:</strong> Disconnect sensitive equipment if necessary</li>
              </ul>
            </div>
            <p style="margin: var(--spacing-md) 0 0 0; color: var(--color-text); font-size: var(--font-size-sm); line-height: 1.6;">
              <strong>Emergency Stop:</strong> Use the Emergency Stop button below to immediately halt all active tests if needed.
            </p>
          </div>
        </div>
      </div>
      
      <!-- Current Hardware State Display -->
      <div class="config-form">
        <h3 style="margin-top: 0; margin-bottom: var(--spacing-md);">Current Hardware State</h3>
        <div class="state-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md);">
          <div class="state-item" style="padding: var(--spacing-md); background-color: var(--color-bg); border-radius: var(--border-radius); border: 2px solid var(--color-border);" id="hw-door-relay-card">
            <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-xs);">
              <span style="font-size: var(--font-size-xl);">üö™</span>
              <span style="font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-text-secondary);">Door Relay</span>
            </div>
            <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-text);" id="hw-door-relay-state">Inactive</div>
            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: var(--spacing-xs);" id="hw-door-countdown" hidden>
              Remaining: <span id="hw-door-remaining">0</span>s
            </div>
          </div>
          
          <div class="state-item" style="padding: var(--spacing-md); background-color: var(--color-bg); border-radius: var(--border-radius); border: 2px solid var(--color-border);" id="hw-light-relay-card">
            <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-xs);">
              <span style="font-size: var(--font-size-xl);">üí°</span>
              <span style="font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-text-secondary);">Light Relay</span>
            </div>
            <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-text);" id="hw-light-relay-state">Off</div>
          </div>
          
          <div class="state-item" style="padding: var(--spacing-md); background-color: var(--color-bg); border-radius: var(--border-radius); border: 2px solid var(--color-border);" id="hw-bell1-card">
            <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-xs);">
              <span style="font-size: var(--font-size-xl);">üîî</span>
              <span style="font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-text-secondary);">Bell 1</span>
            </div>
            <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-text);" id="hw-bell1-state">Not Pressed</div>
          </div>
          
          <div class="state-item" style="padding: var(--spacing-md); background-color: var(--color-bg); border-radius: var(--border-radius); border: 2px solid var(--color-border);" id="hw-bell2-card">
            <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-xs);">
              <span style="font-size: var(--font-size-xl);">üîî</span>
              <span style="font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-text-secondary);">Bell 2</span>
            </div>
            <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-text);" id="hw-bell2-state">Not Pressed</div>
          </div>
        </div>
      </div>
      
      <!-- Doorbell Button Testing -->
      <div class="config-form">
        <h3 style="margin-top: 0; margin-bottom: var(--spacing-md);">Doorbell Tests</h3>
        <p style="margin-bottom: var(--spacing-lg); color: var(--color-text-secondary); font-size: var(--font-size-sm);">
          Simulate doorbell button presses to test SIP call functionality. This will trigger a SIP call if the system is configured and connected.
        </p>
        
        <div style="display: flex; gap: var(--spacing-md); flex-wrap: wrap;">
          <button type="button" class="btn btn-primary test-btn" id="test-bell1-btn" onclick="testDoorbell(1)">
            <span class="btn-text">üîî Test Doorbell 1</span>
            <span class="btn-spinner" hidden>‚è≥</span>
          </button>
          
          <button type="button" class="btn btn-primary test-btn" id="test-bell2-btn" onclick="testDoorbell(2)">
            <span class="btn-text">üîî Test Doorbell 2</span>
            <span class="btn-spinner" hidden>‚è≥</span>
          </button>
        </div>
      </div>
      
      <!-- Door Opener Relay Testing -->
      <div class="config-form">
        <h3 style="margin-top: 0; margin-bottom: var(--spacing-md);">Door Opener Test</h3>
        <p style="margin-bottom: var(--spacing-lg); color: var(--color-text-secondary); font-size: var(--font-size-sm);">
          Activate the door opener relay for a specified duration to test door mechanism functionality.
        </p>
        
        <div class="form-group">
          <label for="door-duration">
            Duration: <span id="door-duration-value">5</span> seconds
          </label>
          <input type="range" 
                 id="door-duration" 
                 name="duration" 
                 min="1" 
                 max="10" 
                 value="5"
                 oninput="updateDurationDisplay(this.value)"
                 style="width: 100%; max-width: 400px;">
          <span class="form-help">Adjust the duration the relay will remain active (1-10 seconds)</span>
        </div>
        
        <div style="display: flex; gap: var(--spacing-md); flex-wrap: wrap;">
          <button type="button" class="btn btn-warning test-btn" id="test-door-btn" onclick="testDoorOpener()">
            <span class="btn-text">üö™ Activate Door Opener</span>
            <span class="btn-spinner" hidden>‚è≥</span>
          </button>
        </div>
      </div>
      
      <!-- Light Relay Testing -->
      <div class="config-form">
        <h3 style="margin-top: 0; margin-bottom: var(--spacing-md);">Light Relay Test</h3>
        <p style="margin-bottom: var(--spacing-lg); color: var(--color-text-secondary); font-size: var(--font-size-sm);">
          Toggle the light relay on and off to test light control functionality.
        </p>
        
        <div style="display: flex; gap: var(--spacing-md); flex-wrap: wrap;">
          <button type="button" class="btn btn-info test-btn" id="test-light-btn" onclick="testLightToggle()">
            <span class="btn-text">üí° Toggle Light</span>
            <span class="btn-spinner" hidden>‚è≥</span>
          </button>
        </div>
      </div>
      
      <!-- Emergency Stop -->
      <div class="config-form" style="background-color: rgba(220, 53, 69, 0.1); border-left: 4px solid var(--color-danger);">
        <h3 style="margin-top: 0; margin-bottom: var(--spacing-md); color: var(--color-danger);">Emergency Stop</h3>
        <p style="margin-bottom: var(--spacing-lg); color: var(--color-text); font-size: var(--font-size-sm);">
          Immediately deactivate all active hardware tests and relays. Use this if something goes wrong during testing.
        </p>
        
        <button type="button" class="btn btn-danger emergency-btn" id="emergency-stop-btn" onclick="emergencyStop()">
          <span class="btn-text">üõë Emergency Stop All Tests</span>
          <span class="btn-spinner" hidden>‚è≥</span>
        </button>
      </div>
      
      <!-- Test Feedback Area -->
      <div id="test-feedback" class="feedback-area" style="display: none; padding: var(--spacing-md); background-color: var(--color-bg); border-radius: var(--border-radius); border-left: 4px solid var(--color-info); margin-top: var(--spacing-lg);">
        <div style="display: flex; align-items: center; gap: var(--spacing-sm);">
          <span id="test-feedback-icon" style="font-size: var(--font-size-xl);"></span>
          <span id="test-feedback-message" style="font-size: var(--font-size-base); color: var(--color-text);"></span>
        </div>
      </div>
      
    </section>

    <!-- Email Reports Section -->
    <section class="content-section" id="section-email" hidden>
      <h2 tabindex="-1">Email Reports</h2>
      
      <!-- Status Panel: Last Report Status (Task 13.3) -->
      <div class="status-panel">
        <div class="status-content">
          <div style="padding: var(--spacing-lg);">
            <h3 style="font-size: var(--font-size-lg); margin-bottom: var(--spacing-md);">Last Report Status</h3>
            <div id="last-report-status" style="display: flex; gap: var(--spacing-lg); flex-wrap: wrap;">
              <div class="dashboard-info-card" style="flex: 1; min-width: 200px;">
                <div class="dashboard-info-label">Last Send Time</div>
                <div class="dashboard-info-value" id="last-report-time">Never</div>
              </div>
              <div class="dashboard-info-card" style="flex: 1; min-width: 200px;">
                <div class="dashboard-info-label">Status</div>
                <div class="dashboard-info-value" id="last-report-status-value">
                  <span style="color: var(--color-text-secondary);">No reports sent</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- SMTP Configuration Form (Task 13.1) -->
      <form class="config-form" id="email-smtp-form" data-api="/api/email/config">
        <h3 style="font-size: var(--font-size-lg); margin-bottom: var(--spacing-md);">SMTP Server Configuration</h3>
        
        <div class="form-group">
          <label for="smtp-server">SMTP Server <span class="required">*</span></label>
          <input type="text" 
                 id="smtp-server" 
                 name="smtp_server" 
                 required
                 placeholder="smtp.gmail.com"
                 data-error="Please enter a valid SMTP server address">
          <span class="error-message" hidden></span>
          <span class="form-help">SMTP server hostname or IP address</span>
        </div>
        
        <div class="form-group">
          <label for="smtp-port">SMTP Port <span class="required">*</span></label>
          <input type="number" 
                 id="smtp-port" 
                 name="smtp_port" 
                 required
                 min="1"
                 max="65535"
                 value="587"
                 placeholder="587"
                 data-error="Please enter a valid port number (1-65535)">
          <span class="error-message" hidden></span>
          <span class="form-help">Common ports: 25 (unencrypted), 587 (STARTTLS), 465 (SSL)</span>
        </div>
        
        <div class="form-group">
          <label for="smtp-username">SMTP Username <span class="required">*</span></label>
          <input type="email" 
                 id="smtp-username" 
                 name="smtp_username" 
                 required
                 placeholder="user@example.com"
                 data-error="Please enter your SMTP username">
          <span class="error-message" hidden></span>
          <span class="form-help">Usually your email address</span>
        </div>
        
        <div class="form-group">
          <label for="smtp-password">SMTP Password <span class="required">*</span></label>
          <input type="password" 
                 id="smtp-password" 
                 name="smtp_password" 
                 required
                 placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                 data-error="Please enter your SMTP password">
          <span class="error-message" hidden></span>
          <span class="form-help">Your SMTP password or app-specific password</span>
        </div>
        
        <div class="form-group">
          <label for="smtp-sender">Sender Email <span class="required">*</span></label>
          <input type="email" 
                 id="smtp-sender" 
                 name="smtp_sender" 
                 required
                 placeholder="doorstation@example.com"
                 data-error="Please enter a valid email address">
          <span class="error-message" hidden></span>
          <span class="form-help">Email address that will appear as sender</span>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn btn-info" id="test-email-btn" onclick="handleTestEmail()">
            <span class="btn-text">Send Test Email</span>
            <span class="btn-spinner" hidden>‚è≥</span>
          </button>
          <button type="submit" class="btn btn-primary" disabled>
            <span class="btn-text">Save SMTP Configuration</span>
            <span class="btn-spinner" hidden>‚è≥</span>
          </button>
          <button type="reset" class="btn btn-secondary">Reset</button>
        </div>
      </form>
      
      <!-- Report Configuration Form (Task 13.2) -->
      <form class="config-form" id="email-report-form" data-api="/api/email/config">
        <h3 style="font-size: var(--font-size-lg); margin-bottom: var(--spacing-md);">Report Configuration</h3>
        
        <div class="form-group">
          <label>
            <input type="checkbox" id="reports-enabled" name="reports_enabled" checked>
            Enable Automated Reports
          </label>
          <span class="form-help">Automatically send scheduled reports via email</span>
        </div>
        
        <div id="report-config-fields">
          <div class="form-group">
            <label for="report-recipient">Recipient Email <span class="required">*</span></label>
            <input type="email" 
                   id="report-recipient" 
                   name="report_recipient" 
                   required
                   placeholder="admin@example.com"
                   data-error="Please enter a valid email address">
            <span class="error-message" hidden></span>
            <span class="form-help">Email address to receive reports</span>
          </div>
          
          <div class="form-group">
            <label for="report-schedule">Report Schedule <span class="required">*</span></label>
            <select id="report-schedule" name="report_schedule" required>
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="monthly">Monthly</option>
            </select>
            <span class="error-message" hidden></span>
          </div>
          
          <div class="form-group">
            <label for="report-time">Report Time <span class="required">*</span></label>
            <input type="time" 
                   id="report-time" 
                   name="report_time" 
                   required
                   value="08:00"
                   data-error="Please select a time">
            <span class="error-message" hidden></span>
            <span class="form-help">Time to send the report (24-hour format)</span>
          </div>
          
          <div class="form-group">
            <label for="report-day">Day of Week (for Weekly)</label>
            <select id="report-day" name="report_day">
              <option value="1">Monday</option>
              <option value="2">Tuesday</option>
              <option value="3">Wednesday</option>
              <option value="4">Thursday</option>
              <option value="5">Friday</option>
              <option value="6">Saturday</option>
              <option value="0">Sunday</option>
            </select>
            <span class="form-help">Only applies to weekly reports</span>
          </div>
          
          <div class="form-group">
            <label for="report-day-of-month">Day of Month (for Monthly)</label>
            <input type="number" 
                   id="report-day-of-month" 
                   name="report_day_of_month" 
                   min="1"
                   max="31"
                   value="1"
                   placeholder="1">
            <span class="form-help">Only applies to monthly reports (1-31)</span>
          </div>
          
          <div class="form-group">
            <label style="font-weight: var(--font-weight-medium); margin-bottom: var(--spacing-sm); display: block;">Report Content</label>
            <div style="display: flex; flex-direction: column; gap: var(--spacing-sm);">
              <label>
                <input type="checkbox" id="include-status" name="include_status" checked>
                Include System Status Summary
              </label>
              <label>
                <input type="checkbox" id="include-logs" name="include_logs" checked>
                Include Activity Logs
              </label>
              <label>
                <input type="checkbox" id="include-backup" name="include_backup" checked>
                Include Configuration Backup
              </label>
            </div>
            <span class="form-help">Select what to include in the report</span>
          </div>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn btn-success" id="send-report-now-btn" onclick="handleSendReportNow()">
            <span class="btn-text">Send Report Now</span>
            <span class="btn-spinner" hidden>‚è≥</span>
          </button>
          <button type="submit" class="btn btn-primary" disabled>
            <span class="btn-text">Save Report Configuration</span>
            <span class="btn-spinner" hidden>‚è≥</span>
          </button>
          <button type="reset" class="btn btn-secondary">Reset</button>
        </div>
      </form>
      
    </section>

    <!-- OTA Update Section (Task 14) -->
    <section class="content-section" id="section-ota" hidden>
      <h2 tabindex="-1">OTA Update</h2>
      
      <!-- Task 14.1: Display Current Firmware Information -->
      <div class="config-form">
        <h3 style="margin-bottom: var(--spacing-md);">Current Firmware Information</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md);">
          <div style="padding: var(--spacing-md); background-color: var(--color-bg); border-radius: var(--border-radius); border: 1px solid var(--color-border);">
            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">Version</div>
            <div id="ota-current-version" style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-text);">Loading...</div>
          </div>
          <div style="padding: var(--spacing-md); background-color: var(--color-bg); border-radius: var(--border-radius); border: 1px solid var(--color-border);">
            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">Build Date</div>
            <div id="ota-build-date" style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-text);">Loading...</div>
          </div>
          <div style="padding: var(--spacing-md); background-color: var(--color-bg); border-radius: var(--border-radius); border: 1px solid var(--color-border);">
            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">Chip Model</div>
            <div id="ota-chip-model" style="font-size: var(--font-size-lg); font-weight: var(--font-weight-bold); color: var(--color-text);">Loading...</div>
          </div>
        </div>
      </div>
      
      <!-- Task 14.2: File Upload Interface -->
      <div class="config-form">
        <h3 style="margin-bottom: var(--spacing-md);">Upload Firmware</h3>
        <p style="margin-bottom: var(--spacing-lg); color: var(--color-text-secondary);">
          Select a firmware binary file (.bin) to upload. Maximum file size: 5MB.
        </p>
        
        <!-- Drag and Drop Area -->
        <div id="ota-drop-zone" style="border: 2px dashed var(--color-border); border-radius: var(--border-radius); padding: var(--spacing-xl); text-align: center; background-color: var(--color-bg); cursor: pointer; transition: border-color var(--transition-fast), background-color var(--transition-fast);">
          <div style="font-size: 48px; margin-bottom: var(--spacing-md);">üì¶</div>
          <div style="font-size: var(--font-size-lg); font-weight: var(--font-weight-medium); color: var(--color-text); margin-bottom: var(--spacing-sm);">
            Drag and drop firmware file here
          </div>
          <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-md);">
            or click to browse
          </div>
          <button type="button" class="btn btn-primary" onclick="document.getElementById('ota-file-input').click()">
            <span>üìÇ</span>
            <span>Select File</span>
          </button>
          <input type="file" id="ota-file-input" accept=".bin" style="display: none;">
        </div>
        
        <!-- Selected File Display -->
        <div id="ota-file-info" style="display: none; margin-top: var(--spacing-lg); padding: var(--spacing-md); background-color: var(--color-bg); border-radius: var(--border-radius); border: 1px solid var(--color-border);">
          <div style="display: flex; align-items: center; justify-content: space-between; gap: var(--spacing-md);">
            <div style="flex: 1;">
              <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: var(--spacing-xs);">Selected File</div>
              <div id="ota-file-name" style="font-size: var(--font-size-base); font-weight: var(--font-weight-medium); color: var(--color-text); word-break: break-all;"></div>
              <div id="ota-file-size" style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: var(--spacing-xs);"></div>
            </div>
            <button type="button" class="btn btn-secondary btn-sm" onclick="clearOTAFile()">
              <span>‚úï</span>
              <span>Clear</span>
            </button>
          </div>
        </div>
        
        <!-- Task 14.3: Upload Progress Tracking -->
        <div id="ota-progress-container" style="display: none; margin-top: var(--spacing-lg);">
          <div style="margin-bottom: var(--spacing-sm);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-xs);">
              <span style="font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-text);">Upload Progress</span>
              <span id="ota-progress-percent" style="font-size: var(--font-size-sm); font-weight: var(--font-weight-bold); color: var(--color-primary);">0%</span>
            </div>
            <div style="width: 100%; height: 24px; background-color: var(--color-bg); border: 1px solid var(--color-border); border-radius: var(--border-radius); overflow: hidden;">
              <div id="ota-progress-bar" style="height: 100%; width: 0%; background-color: var(--color-primary); transition: width 0.3s ease;"></div>
            </div>
          </div>
          <div style="display: flex; justify-content: space-between; font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: var(--spacing-sm);">
            <span id="ota-upload-speed">Speed: --</span>
            <span id="ota-time-remaining">Time remaining: --</span>
          </div>
          <div id="ota-upload-status" style="margin-top: var(--spacing-md); padding: var(--spacing-sm); background-color: var(--color-bg); border-radius: var(--border-radius); border: 1px solid var(--color-border); font-size: var(--font-size-sm); color: var(--color-text);"></div>
        </div>
        
        <!-- Upload Button -->
        <div style="margin-top: var(--spacing-lg);">
          <button type="button" class="btn btn-success btn-lg" id="ota-upload-btn" onclick="handleOTAUpload()" disabled>
            <span class="btn-text">
              <span>‚¨ÜÔ∏è</span>
              <span>Upload Firmware</span>
            </span>
            <span class="btn-spinner" hidden>‚è≥</span>
          </button>
        </div>
      </div>
      
      <!-- Task 14.4: Update Confirmation and Warnings -->
      <div class="config-form" id="ota-apply-section" style="display: none;">
        <h3 style="margin-bottom: var(--spacing-md);">Apply Update</h3>
        
        <!-- Warning Messages -->
        <div style="padding: var(--spacing-md); background-color: rgba(255, 193, 7, 0.1); border: 2px solid var(--color-warning); border-radius: var(--border-radius); margin-bottom: var(--spacing-lg);">
          <div style="display: flex; align-items: start; gap: var(--spacing-md);">
            <span style="font-size: var(--font-size-2xl); flex-shrink: 0;">‚ö†Ô∏è</span>
            <div>
              <div style="font-size: var(--font-size-base); font-weight: var(--font-weight-bold); color: var(--color-text); margin-bottom: var(--spacing-sm);">Important Warnings</div>
              <ul style="margin: 0; padding-left: var(--spacing-lg); font-size: var(--font-size-sm); color: var(--color-text); line-height: 1.6;">
                <li>Do not disconnect power during the update process</li>
                <li>The device will restart automatically after applying the update</li>
                <li>The update process may take 1-2 minutes</li>
                <li>You will lose connection temporarily during the restart</li>
                <li>Make sure you have a backup of your configuration</li>
              </ul>
            </div>
          </div>
        </div>
        
        <button type="button" class="btn btn-danger btn-lg" onclick="handleOTAApply()">
          <span>üîÑ</span>
          <span>Apply Update and Restart</span>
        </button>
      </div>
      
      <!-- Task 14.5: Update Status Display -->
      <div class="config-form" id="ota-status-section" style="display: none;">
        <h3 style="margin-bottom: var(--spacing-md);">Update Status</h3>
        
        <div style="padding: var(--spacing-lg); background-color: var(--color-bg); border-radius: var(--border-radius); border: 1px solid var(--color-border); text-align: center;">
          <div id="ota-status-icon" style="font-size: 64px; margin-bottom: var(--spacing-md);">‚è≥</div>
          <div id="ota-status-message" style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--color-text); margin-bottom: var(--spacing-md);">Processing...</div>
          <div id="ota-status-detail" style="font-size: var(--font-size-base); color: var(--color-text-secondary);"></div>
        </div>
        
        <!-- Update Log -->
        <div style="margin-top: var(--spacing-lg);">
          <h4 style="font-size: var(--font-size-base); font-weight: var(--font-weight-medium); margin-bottom: var(--spacing-md);">Update Log</h4>
          <div id="ota-update-log" style="max-height: 300px; overflow-y: auto; background-color: var(--color-bg); border: 1px solid var(--color-border); border-radius: var(--border-radius); padding: var(--spacing-md); font-family: monospace; font-size: var(--font-size-sm); color: var(--color-text); line-height: 1.6;">
            <!-- Log entries will be added here -->
          </div>
        </div>
      </div>
      
      <!-- Task 14.6: Automatic Page Reload After Update -->
      <div class="config-form" id="ota-reload-section" style="display: none;">
        <h3 style="margin-bottom: var(--spacing-md);">Update Complete</h3>
        
        <div style="padding: var(--spacing-lg); background-color: rgba(40, 167, 69, 0.1); border: 2px solid var(--color-success); border-radius: var(--border-radius); text-align: center;">
          <div style="font-size: 64px; margin-bottom: var(--spacing-md);">‚úÖ</div>
          <div style="font-size: var(--font-size-xl); font-weight: var(--font-weight-bold); color: var(--color-text); margin-bottom: var(--spacing-md);">Update Successful!</div>
          <div style="font-size: var(--font-size-base); color: var(--color-text-secondary); margin-bottom: var(--spacing-lg);">
            Waiting for device to come back online...
          </div>
          <div style="font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold); color: var(--color-primary);">
            <span id="ota-reload-countdown">30</span>s
          </div>
          <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: var(--spacing-sm);">
            Page will reload automatically when device is ready
          </div>
        </div>
        
        <div style="margin-top: var(--spacing-lg); text-align: center;">
          <button type="button" class="btn btn-primary" onclick="location.reload()">
            <span>üîÑ</span>
            <span>Reload Now</span>
          </button>
        </div>
      </div>
      
    </section>

    <!-- Documentation Section (Task 15) -->
    <section class="content-section" id="section-docs" hidden>
      <h2 tabindex="-1">Documentation</h2>
      
      <!-- Documentation content will be loaded here -->
      <div id="documentation-container">
        <p style="text-align: center; padding: var(--spacing-xl); color: var(--color-text-secondary);">
          üìö Loading documentation...
        </p>
      </div>
    </section>

  </main>

  <!-- Toast Notification Container -->
  <div class="toast-container" id="toast-container" aria-live="polite" aria-atomic="true"></div>

  <!-- Search Results Dropdown -->
  <div class="search-results" id="search-results" hidden role="listbox"></div>

  <script>
    // ===== Task 3: Core JavaScript Functionality =====
    
    // ===== Task 3.1: Navigation System =====
    
    /**
     * Navigate to a specific section
     * @param {string} sectionId - The section identifier (e.g., 'dashboard', 'sip')
     */
    function navigateToSection(sectionId) {
      // Stop hardware state polling if leaving testing section
      const currentSection = sessionStorage.getItem('activeSection');
      if (currentSection === 'testing' && sectionId !== 'testing') {
        stopHardwareStatePolling();
      }
      
      // Stop login log auto-refresh if leaving logs section
      if (currentSection === 'logs' && sectionId !== 'logs') {
        stopLoginLogAutoRefresh();
      }
      
      // Hide all sections
      document.querySelectorAll('.content-section').forEach(section => {
        section.hidden = true;
        section.classList.remove('active');
      });
      
      // Show selected section with fade-in
      const targetSection = document.getElementById(`section-${sectionId}`);
      if (targetSection) {
        targetSection.hidden = false;
        // Small delay to trigger CSS transition
        setTimeout(() => targetSection.classList.add('active'), 10);
        
        // Scroll to top of main content
        document.getElementById('main-content').scrollTop = 0;
        
        // Set focus to section heading for accessibility
        const heading = targetSection.querySelector('h2');
        if (heading) {
          heading.focus();
        }
      }
      
      // Update sidebar active state
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.section === sectionId);
        item.setAttribute('aria-current', item.dataset.section === sectionId ? 'page' : 'false');
      });
      
      // Save to sessionStorage for persistence
      sessionStorage.setItem('activeSection', sectionId);
      
      // Close mobile sidebar after navigation
      if (window.innerWidth < 768) {
        closeMobileSidebar();
      }
      
      // Section-specific initialization (Task 7.3, 7.4, Task 8.4, Task 9, Task 10, Task 11)
      if (sectionId === 'sip') {
        // Load SIP configuration from server (Task 7.4)
        loadSIPConfiguration();
        // Update SIP connection status and button states
        updateSIPConnectionStatus();
      } else if (sectionId === 'network') {
        // Initialize Network Settings section (Task 8.4)
        initNetworkSettings();
      } else if (sectionId === 'hardware') {
        // Update Hardware Settings section (Task 9)
        updateHardwareInfo();
        updateHardwareStatus();
      } else if (sectionId === 'security') {
        // Load Security Settings (Task 10.4)
        loadSecurityConfiguration();
        // Load Certificate Information (Task 18)
        loadCertificateInfo();
      } else if (sectionId === 'logs') {
        // Initialize System Logs section (Task 11)
        initLogsSection();
        // Load Login Audit Logs (Task 20)
        initLoginLogs();
      } else if (sectionId === 'testing') {
        // Start hardware state polling for testing section
        startHardwareStatePolling();
      } else if (sectionId === 'email') {
        // Load Email Reports configuration (Task 13.5)
        loadEmailConfiguration();
      } else if (sectionId === 'ota') {
        // Load OTA firmware information (Task 14.1)
        loadOTAFirmwareInfo();
      } else if (sectionId === 'docs') {
        // Ensure documentation is loaded (Task 15)
        if (!document.getElementById('documentation-container').querySelector('.docs-section')) {
          loadDocumentation();
        }
      }
    }
    
    /**
     * Initialize navigation system
     */
    function initNavigation() {
      // Add click handlers to nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
          const section = item.dataset.section;
          if (section) {
            navigateToSection(section);
          }
        });
        
        // Keyboard navigation support
        item.setAttribute('tabindex', '0');
        item.setAttribute('role', 'button');
        item.setAttribute('aria-current', 'false');
        
        item.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            const section = item.dataset.section;
            if (section) {
              navigateToSection(section);
            }
          }
        });
      });
      
      // Arrow key navigation in sidebar
      const navItems = Array.from(document.querySelectorAll('.nav-item'));
      navItems.forEach((item, index) => {
        item.addEventListener('keydown', (e) => {
          let targetIndex = -1;
          
          if (e.key === 'ArrowDown') {
            e.preventDefault();
            targetIndex = (index + 1) % navItems.length;
          } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            targetIndex = (index - 1 + navItems.length) % navItems.length;
          }
          
          if (targetIndex >= 0) {
            navItems[targetIndex].focus();
          }
        });
      });
      
      // Restore last active section from sessionStorage
      const savedSection = sessionStorage.getItem('activeSection');
      if (savedSection) {
        navigateToSection(savedSection);
      }
    }
    
    /**
     * Close mobile sidebar
     */
    function closeMobileSidebar() {
      const sidebar = document.getElementById('sidebar');
      const menuToggle = document.querySelector('.menu-toggle');
      sidebar.classList.remove('open');
      if (menuToggle) {
        menuToggle.setAttribute('aria-expanded', 'false');
      }
    }
    
    /**
     * Toggle mobile sidebar
     */
    function toggleMobileSidebar() {
      const sidebar = document.getElementById('sidebar');
      const menuToggle = document.querySelector('.menu-toggle');
      const isOpen = sidebar.classList.toggle('open');
      if (menuToggle) {
        menuToggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      }
    }
    
    /**
     * Open mobile sidebar
     */
    function openMobileSidebar() {
      const sidebar = document.getElementById('sidebar');
      const menuToggle = document.querySelector('.menu-toggle');
      sidebar.classList.add('open');
      if (menuToggle) {
        menuToggle.setAttribute('aria-expanded', 'true');
      }
    }
    
    // ===== Task 16.2: Touch Gesture Support =====
    
    /**
     * Initialize touch gesture support for mobile sidebar
     */
    function initTouchGestures() {
      let touchStartX = 0;
      let touchStartY = 0;
      let touchEndX = 0;
      let touchEndY = 0;
      let isSwiping = false;
      
      const minSwipeDistance = 50; // Minimum distance for a swipe
      const maxVerticalDistance = 100; // Maximum vertical movement to still count as horizontal swipe
      const edgeThreshold = 30; // Distance from edge to trigger swipe-to-open
      
      // Handle touch start
      document.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
        isSwiping = false;
      }, { passive: true });
      
      // Handle touch move
      document.addEventListener('touchmove', (e) => {
        if (!isSwiping) {
          const currentX = e.changedTouches[0].screenX;
          const currentY = e.changedTouches[0].screenY;
          const deltaX = Math.abs(currentX - touchStartX);
          const deltaY = Math.abs(currentY - touchStartY);
          
          // Check if this is a horizontal swipe
          if (deltaX > deltaY && deltaX > 10) {
            isSwiping = true;
          }
        }
      }, { passive: true });
      
      // Handle touch end
      document.addEventListener('touchend', (e) => {
        if (!isSwiping) return;
        
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        
        const deltaX = touchEndX - touchStartX;
        const deltaY = Math.abs(touchEndY - touchStartY);
        
        // Only process if vertical movement is minimal (horizontal swipe)
        if (deltaY > maxVerticalDistance) return;
        
        const sidebar = document.getElementById('sidebar');
        const isSidebarOpen = sidebar.classList.contains('open');
        
        // Swipe right to open (from left edge)
        if (deltaX > minSwipeDistance && touchStartX < edgeThreshold && !isSidebarOpen) {
          openMobileSidebar();
        }
        
        // Swipe left to close (when sidebar is open)
        if (deltaX < -minSwipeDistance && isSidebarOpen) {
          closeMobileSidebar();
        }
        
        isSwiping = false;
      }, { passive: true });
    }
    
    // ===== Task 3.2: Theme Toggle Functionality =====
    
    /**
     * Initialize theme system
     */
    function initTheme() {
      // Check localStorage first
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        document.documentElement.setAttribute('data-theme', savedTheme);
        updateThemeIcon(savedTheme);
        return;
      }
      
      // Check system preference
      if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.documentElement.setAttribute('data-theme', 'dark');
        updateThemeIcon('dark');
      } else {
        updateThemeIcon('light');
      }
    }
    
    /**
     * Toggle between light and dark theme
     */
    function toggleTheme() {
      const currentTheme = document.documentElement.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeIcon(newTheme);
    }
    
    /**
     * Update theme toggle button icon
     * @param {string} theme - Current theme ('light' or 'dark')
     */
    function updateThemeIcon(theme) {
      const themeToggle = document.getElementById('theme-toggle');
      if (themeToggle) {
        themeToggle.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        themeToggle.setAttribute('aria-label', `Switch to ${theme === 'dark' ? 'light' : 'dark'} theme`);
      }
    }
    
    // ===== Task 3.3: Status Panel Functionality =====
    
    /**
     * Toggle status panel collapse/expand
     */
    function toggleStatusPanel() {
      const panel = document.getElementById('status-panel');
      const toggle = panel.querySelector('.status-toggle');
      const isCollapsed = panel.classList.toggle('collapsed');
      
      // Update ARIA attributes
      toggle.setAttribute('aria-expanded', !isCollapsed);
      
      // Save state to localStorage
      localStorage.setItem('statusPanelCollapsed', isCollapsed);
    }
    
    /**
     * Initialize status panel
     */
    function initStatusPanel() {
      // Restore collapsed state from localStorage
      const isCollapsed = localStorage.getItem('statusPanelCollapsed') === 'true';
      const panel = document.getElementById('status-panel');
      const toggle = panel.querySelector('.status-toggle');
      
      if (isCollapsed) {
        panel.classList.add('collapsed');
        toggle.setAttribute('aria-expanded', 'false');
      }
      
      // Add click handler
      toggle.addEventListener('click', toggleStatusPanel);
      
      // Start auto-refresh
      updateAllStatus();
      setInterval(updateAllStatus, 10000); // Update every 10 seconds
    }
    
    /**
     * Update all status cards
     */
    async function updateAllStatus() {
      try {
        await Promise.all([
          updateWiFiStatus(),
          updateSIPStatus(),
          updateDoorStatus(),
          updateLightStatus()
        ]);
      } catch (error) {
        console.error('Error updating status:', error);
      }
    }
    
    /**
     * Update WiFi status card
     */
    async function updateWiFiStatus() {
      try {
        const response = await apiRequest('/api/wifi/status');
        console.log('WiFi status response:', response);
        const card = document.getElementById('wifi-status');
        const valueSpan = card.querySelector('.status-value');
        
        // Normalize status to lowercase for comparison
        const status = response && response.status ? response.status.toLowerCase() : '';
        
        if (status === 'connected' || response.connected === true) {
          card.setAttribute('data-status', 'connected');
          valueSpan.textContent = `Connected (${response.ip_address || response.ip || 'N/A'})`;
        } else if (status === 'connecting') {
          card.setAttribute('data-status', 'connecting');
          valueSpan.textContent = 'Connecting...';
        } else {
          card.setAttribute('data-status', 'disconnected');
          valueSpan.textContent = response && response.ssid ? `Disconnected (${response.ssid})` : 'Disconnected';
        }
      } catch (error) {
        console.error('WiFi status error:', error);
        const card = document.getElementById('wifi-status');
        card.setAttribute('data-status', 'disconnected');
        card.querySelector('.status-value').textContent = 'Error';
      }
    }
    
    /**
     * Update SIP status card
     */
    async function updateSIPStatus() {
      try {
        const response = await apiRequest('/api/sip/status');
        const card = document.getElementById('sip-status');
        const valueSpan = card.querySelector('.status-value');
        
        // API returns capitalized status values like "Registered", "Connecting", etc.
        const status = response.status ? response.status.toLowerCase() : '';
        
        if (status === 'registered') {
          card.setAttribute('data-status', 'registered');
          valueSpan.textContent = `Registered (${response.state || 'IDLE'})`;
        } else if (status === 'connecting') {
          card.setAttribute('data-status', 'connecting');
          valueSpan.textContent = 'Connecting...';
        } else {
          card.setAttribute('data-status', 'disconnected');
          valueSpan.textContent = response.status || 'Disconnected';
        }
      } catch (error) {
        const card = document.getElementById('sip-status');
        card.setAttribute('data-status', 'disconnected');
        card.querySelector('.status-value').textContent = 'Error';
      }
    }
    
    /**
     * Update door status card
     */
    async function updateDoorStatus() {
      try {
        const response = await apiRequest('/api/hardware/status');
        const card = document.getElementById('door-status');
        const valueSpan = card.querySelector('.status-value');
        
        if (response.door && response.door.status === 'open') {
          card.setAttribute('data-status', 'open');
          valueSpan.textContent = 'Open';
        } else {
          card.setAttribute('data-status', 'closed');
          valueSpan.textContent = 'Closed';
        }
      } catch (error) {
        const card = document.getElementById('door-status');
        card.setAttribute('data-status', 'closed');
        card.querySelector('.status-value').textContent = 'Closed';
      }
    }
    
    /**
     * Update light status card
     */
    async function updateLightStatus() {
      try {
        const response = await apiRequest('/api/hardware/status');
        const card = document.getElementById('light-status');
        const valueSpan = card.querySelector('.status-value');
        
        if (response.light && response.light.status === 'on') {
          card.setAttribute('data-status', 'on');
          valueSpan.textContent = 'On';
        } else {
          card.setAttribute('data-status', 'off');
          valueSpan.textContent = 'Off';
        }
      } catch (error) {
        const card = document.getElementById('light-status');
        card.setAttribute('data-status', 'off');
        card.querySelector('.status-value').textContent = 'Off';
      }
    }
    
    // ===== Task 3.4: Toast Notification System =====
    
    let toastQueue = [];
    let isShowingToast = false;
    
    /**
     * Show a toast notification
     * @param {string} message - The message to display
     * @param {string} type - Toast type: 'success', 'error', 'warning', 'info'
     * @param {number} duration - Duration in milliseconds (default: 3000)
     */
    function showToast(message, type = 'info', duration = 3000) {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      
      const iconMap = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: '‚ÑπÔ∏è'
      };
      const icon = iconMap[type] || iconMap.info;
      
      toast.innerHTML = `
        <span class="toast-icon">${icon}</span>
        <span class="toast-message">${message}</span>
        <button class="toast-close" aria-label="Close notification">√ó</button>
      `;
      
      const container = document.getElementById('toast-container');
      container.appendChild(toast);
      
      // Animate in
      setTimeout(() => toast.classList.add('show'), 10);
      
      // Auto-remove
      const autoRemoveTimeout = setTimeout(() => {
        removeToast(toast);
      }, duration);
      
      // Manual close
      const closeBtn = toast.querySelector('.toast-close');
      closeBtn.addEventListener('click', () => {
        clearTimeout(autoRemoveTimeout);
        removeToast(toast);
      });
    }
    
    /**
     * Remove a toast notification
     * @param {HTMLElement} toast - The toast element to remove
     */
    function removeToast(toast) {
      toast.classList.remove('show');
      setTimeout(() => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 300);
    }
    
    /**
     * Queue a toast notification
     * @param {string} message - The message to display
     * @param {string} type - Toast type
     * @param {number} duration - Duration in milliseconds
     */
    function queueToast(message, type = 'info', duration = 3000) {
      toastQueue.push({ message, type, duration });
      if (!isShowingToast) {
        processToastQueue();
      }
    }
    
    /**
     * Process the toast queue
     */
    function processToastQueue() {
      if (toastQueue.length === 0) {
        isShowingToast = false;
        return;
      }
      
      isShowingToast = true;
      const { message, type, duration } = toastQueue.shift();
      showToast(message, type, duration);
      
      setTimeout(processToastQueue, duration + 500);
    }
    
    // ===== Task 3.5: API Request Wrapper =====
    
    /**
     * Make an API request with error handling and timeout
     * @param {string} endpoint - API endpoint URL
     * @param {Object} options - Fetch options
     * @param {number} timeout - Request timeout in milliseconds (default: 10000)
     * @returns {Promise<Object>} Response data
     */
    async function apiRequest(endpoint, options = {}, timeout = 10000) {
      const silentError = options.silentError || false;
      delete options.silentError; // Remove custom option before fetch
      
      const defaultOptions = {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      };
      
      const config = { ...defaultOptions, ...options };
      
      try {
        // Create timeout promise
        const timeoutPromise = new Promise((_, reject) => {
          setTimeout(() => reject(new Error('Request timeout')), timeout);
        });
        
        // Race between fetch and timeout
        const response = await Promise.race([
          fetch(endpoint, config),
          timeoutPromise
        ]);
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
        }
        
        return await response.json();
      } catch (error) {
        console.error(`API Error [${endpoint}]:`, error);
        
        // Show user-friendly error messages (unless silentError is true)
        if (!silentError) {
          if (error.message === 'Request timeout') {
            showToast('Request timed out. Please try again.', 'error');
          } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
            showToast('Connection error. Please check your network.', 'error');
          } else {
            showToast(error.message, 'error');
          }
        }
        
        throw error;
      }
    }
    
    /**
     * Show loading state on an element
     * @param {HTMLElement} element - Element to show loading state on
     * @param {boolean} isLoading - Whether to show or hide loading state
     */
    function setLoadingState(element, isLoading) {
      if (isLoading) {
        element.disabled = true;
        element.classList.add('loading');
        const spinner = element.querySelector('.btn-spinner');
        const text = element.querySelector('.btn-text');
        if (spinner) spinner.hidden = false;
        if (text) text.hidden = true;
      } else {
        element.disabled = false;
        element.classList.remove('loading');
        const spinner = element.querySelector('.btn-spinner');
        const text = element.querySelector('.btn-text');
        if (spinner) spinner.hidden = true;
        if (text) text.hidden = false;
      }
    }
    
    // ===== Task 4: Form Handling and Validation =====
    
    // Store initial form states for change tracking
    let formInitialStates = {};
    
    // ===== Task 4.1: Form Validation System =====
    
    /**
     * Validate a form using HTML5 validation
     * @param {HTMLFormElement} form - The form to validate
     * @returns {boolean} True if form is valid, false otherwise
     */
    function validateForm(form) {
      let isValid = true;
      const inputs = form.querySelectorAll('input[required], select[required], textarea[required]');
      
      inputs.forEach(input => {
        const errorSpan = input.parentElement.querySelector('.error-message');
        
        // Check HTML5 validity
        if (!input.validity.valid) {
          isValid = false;
          
          // Get custom error message or use default
          let errorMessage = input.dataset.error || 'This field is required';
          
          // Provide specific error messages based on validity state
          if (input.validity.valueMissing) {
            errorMessage = input.dataset.error || 'This field is required';
          } else if (input.validity.typeMismatch) {
            errorMessage = `Please enter a valid ${input.type}`;
          } else if (input.validity.patternMismatch) {
            errorMessage = input.dataset.error || 'Please match the requested format';
          } else if (input.validity.tooShort) {
            errorMessage = `Minimum length is ${input.minLength} characters`;
          } else if (input.validity.tooLong) {
            errorMessage = `Maximum length is ${input.maxLength} characters`;
          } else if (input.validity.rangeUnderflow) {
            errorMessage = `Minimum value is ${input.min}`;
          } else if (input.validity.rangeOverflow) {
            errorMessage = `Maximum value is ${input.max}`;
          }
          
          if (errorSpan) {
            errorSpan.textContent = errorMessage;
            errorSpan.hidden = false;
          }
          input.classList.add('invalid');
          input.setAttribute('aria-invalid', 'true');
        } else {
          if (errorSpan) {
            errorSpan.hidden = true;
          }
          input.classList.remove('invalid');
          input.setAttribute('aria-invalid', 'false');
        }
      });
      
      return isValid;
    }
    
    /**
     * Clear validation errors from a form
     * @param {HTMLFormElement} form - The form to clear errors from
     */
    function clearValidationErrors(form) {
      const inputs = form.querySelectorAll('input, select, textarea');
      inputs.forEach(input => {
        const errorSpan = input.parentElement.querySelector('.error-message');
        if (errorSpan) {
          errorSpan.hidden = true;
        }
        input.classList.remove('invalid');
        input.setAttribute('aria-invalid', 'false');
      });
    }
    
    /**
     * Setup real-time validation for form inputs
     * @param {HTMLFormElement} form - The form to setup validation for
     */
    function setupFormValidation(form) {
      const inputs = form.querySelectorAll('input[required], select[required], textarea[required]');
      
      inputs.forEach(input => {
        // Validate on blur
        input.addEventListener('blur', () => {
          if (input.value) {
            validateForm(form);
          }
        });
        
        // Clear error on input
        input.addEventListener('input', () => {
          if (input.classList.contains('invalid')) {
            const errorSpan = input.parentElement.querySelector('.error-message');
            if (input.validity.valid) {
              if (errorSpan) {
                errorSpan.hidden = true;
              }
              input.classList.remove('invalid');
              input.setAttribute('aria-invalid', 'false');
            }
          }
        });
      });
    }
    
    // ===== Task 4.2: Unsaved Changes Tracking =====
    
    /**
     * Get form data as an object
     * @param {HTMLFormElement} form - The form to get data from
     * @returns {Object} Form data as key-value pairs
     */
    function getFormData(form) {
      const formData = new FormData(form);
      const data = {};
      
      for (const [key, value] of formData.entries()) {
        // Handle checkboxes
        const input = form.elements[key];
        if (input && input.type === 'checkbox') {
          data[key] = input.checked;
        } else {
          data[key] = value;
        }
      }
      
      return data;
    }
    
    /**
     * Track form changes and update UI accordingly
     * @param {HTMLFormElement} form - The form to track changes for
     */
    function trackFormChanges(form) {
      const formId = form.id;
      if (!formId) return;
      
      const currentState = getFormData(form);
      const initialState = formInitialStates[formId] || {};
      
      // Compare current state with initial state
      const hasChanges = JSON.stringify(currentState) !== JSON.stringify(initialState);
      
      // Enable/disable save button
      const saveButton = form.querySelector('button[type="submit"]');
      if (saveButton) {
        saveButton.disabled = !hasChanges;
      }
      
      // Show/hide unsaved indicator in sidebar
      const section = form.closest('.content-section');
      if (section) {
        const sectionId = section.id.replace('section-', '');
        const navItem = document.querySelector(`.nav-item[data-section="${sectionId}"]`);
        if (navItem) {
          const indicator = navItem.querySelector('.unsaved-indicator');
          if (indicator) {
            indicator.hidden = !hasChanges;
          }
        }
      }
    }
    
    /**
     * Save initial form state for change tracking
     * @param {HTMLFormElement} form - The form to save state for
     */
    function saveFormInitialState(form) {
      const formId = form.id;
      if (!formId) return;
      
      formInitialStates[formId] = getFormData(form);
    }
    
    /**
     * Setup change tracking for a form
     * @param {HTMLFormElement} form - The form to setup tracking for
     */
    function setupFormChangeTracking(form) {
      // Save initial state
      saveFormInitialState(form);
      
      // Track changes on input
      form.addEventListener('input', () => {
        trackFormChanges(form);
      });
      
      // Track changes on change (for select, checkbox, radio)
      form.addEventListener('change', () => {
        trackFormChanges(form);
      });
    }
    
    // ===== Task 4.3: Form Submission Handler =====
    
    /**
     * Handle form submission with loading states and error handling
     * @param {Event} event - The submit event
     */
    async function handleFormSubmit(event) {
      event.preventDefault();
      const form = event.target;
      
      // Validate form
      if (!validateForm(form)) {
        showToast('Please fix the errors in the form', 'error');
        // Focus on first invalid input
        const firstInvalid = form.querySelector('.invalid');
        if (firstInvalid) {
          firstInvalid.focus();
        }
        return;
      }
      
      // Get API endpoint from form data attribute
      const endpoint = form.dataset.api;
      if (!endpoint) {
        console.error('Form missing data-api attribute');
        showToast('Configuration error. Please contact support.', 'error');
        return;
      }
      
      // Get submit button
      const submitBtn = form.querySelector('button[type="submit"]');
      if (!submitBtn) return;
      
      // Show loading state
      setLoadingState(submitBtn, true);
      
      try {
        // Get form data
        const formData = getFormData(form);
        
        // Make API request
        const response = await apiRequest(endpoint, {
          method: 'POST',
          body: JSON.stringify(formData)
        });
        
        // Show success message
        showToast(response.message || 'Configuration saved successfully!', 'success');
        
        // Update initial state to current state
        saveFormInitialState(form);
        trackFormChanges(form);
        
        // Call custom success handler if defined
        if (form.dataset.onSuccess) {
          const handlerName = form.dataset.onSuccess;
          if (typeof window[handlerName] === 'function') {
            window[handlerName](response);
          }
        }
        
      } catch (error) {
        // Error already shown by apiRequest
        console.error('Form submission error:', error);
      } finally {
        // Reset button state
        setLoadingState(submitBtn, false);
      }
    }
    
    /**
     * Setup form submission handler
     * @param {HTMLFormElement} form - The form to setup handler for
     */
    function setupFormSubmission(form) {
      form.addEventListener('submit', handleFormSubmit);
      
      // Prevent default form submission
      form.setAttribute('novalidate', 'true');
      
      // Setup reset button
      const resetBtn = form.querySelector('button[type="reset"]');
      if (resetBtn) {
        resetBtn.addEventListener('click', (e) => {
          e.preventDefault();
          
          // Reset form to initial state
          const formId = form.id;
          const initialState = formInitialStates[formId];
          
          if (initialState) {
            // Restore initial values
            Object.keys(initialState).forEach(key => {
              const input = form.elements[key];
              if (input) {
                if (input.type === 'checkbox') {
                  input.checked = initialState[key];
                } else {
                  input.value = initialState[key];
                }
              }
            });
          } else {
            // Just reset the form
            form.reset();
          }
          
          // Clear validation errors
          clearValidationErrors(form);
          
          // Update change tracking
          trackFormChanges(form);
        });
      }
    }
    
    // ===== Task 4.4: Confirmation Dialogs for Destructive Actions =====
    
    /**
     * Show a confirmation dialog
     * @param {string} title - Dialog title
     * @param {string} message - Dialog message
     * @param {string} confirmText - Confirm button text (default: 'Confirm')
     * @param {string} cancelText - Cancel button text (default: 'Cancel')
     * @param {string} type - Dialog type: 'warning', 'danger' (default: 'warning')
     * @returns {Promise<boolean>} True if confirmed, false if cancelled
     */
    function showConfirmDialog(title, message, confirmText = 'Confirm', cancelText = 'Cancel', type = 'warning') {
      return new Promise((resolve) => {
        // Create dialog overlay
        const overlay = document.createElement('div');
        overlay.className = 'dialog-overlay';
        overlay.setAttribute('role', 'dialog');
        overlay.setAttribute('aria-modal', 'true');
        overlay.setAttribute('aria-labelledby', 'dialog-title');
        overlay.setAttribute('aria-describedby', 'dialog-message');
        
        // Create dialog
        const dialog = document.createElement('div');
        dialog.className = `dialog dialog-${type}`;
        
        const iconMap = {
          warning: '‚ö†Ô∏è',
          danger: 'üö®'
        };
        const icon = iconMap[type] || iconMap.warning;
        
        dialog.innerHTML = `
          <div class="dialog-header">
            <span class="dialog-icon">${icon}</span>
            <h3 class="dialog-title" id="dialog-title">${title}</h3>
          </div>
          <div class="dialog-body">
            <p class="dialog-message" id="dialog-message">${message}</p>
          </div>
          <div class="dialog-footer">
            <button class="btn btn-secondary dialog-cancel">${cancelText}</button>
            <button class="btn btn-${type === 'danger' ? 'danger' : 'primary'} dialog-confirm">${confirmText}</button>
          </div>
        `;
        
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);
        
        // Animate in
        setTimeout(() => overlay.classList.add('show'), 10);
        
        // Focus confirm button
        const confirmBtn = dialog.querySelector('.dialog-confirm');
        setTimeout(() => confirmBtn.focus(), 100);
        
        // Handle confirm
        confirmBtn.addEventListener('click', () => {
          closeDialog(overlay);
          resolve(true);
        });
        
        // Handle cancel
        const cancelBtn = dialog.querySelector('.dialog-cancel');
        cancelBtn.addEventListener('click', () => {
          closeDialog(overlay);
          resolve(false);
        });
        
        // Handle escape key
        const handleEscape = (e) => {
          if (e.key === 'Escape') {
            closeDialog(overlay);
            resolve(false);
            document.removeEventListener('keydown', handleEscape);
          }
        };
        document.addEventListener('keydown', handleEscape);
        
        // Handle overlay click
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            closeDialog(overlay);
            resolve(false);
          }
        });
      });
    }
    
    /**
     * Close a dialog
     * @param {HTMLElement} overlay - The dialog overlay element
     */
    function closeDialog(overlay) {
      overlay.classList.remove('show');
      setTimeout(() => {
        if (overlay.parentNode) {
          overlay.parentNode.removeChild(overlay);
        }
      }, 300);
    }
    
    /**
     * Confirm system restart
     * @returns {Promise<boolean>} True if confirmed
     */
    async function confirmSystemRestart() {
      return await showConfirmDialog(
        'Restart System',
        'Are you sure you want to restart the system? This will temporarily interrupt all services.',
        'Restart',
        'Cancel',
        'warning'
      );
    }
    
    /**
     * Confirm factory reset
     * @returns {Promise<boolean>} True if confirmed
     */
    async function confirmFactoryReset() {
      return await showConfirmDialog(
        'Factory Reset',
        'WARNING: This will erase ALL configuration settings and restart the device. This action cannot be undone. Are you absolutely sure?',
        'Yes, Reset Everything',
        'Cancel',
        'danger'
      );
    }
    
    /**
     * Confirm SIP disconnect
     * @returns {Promise<boolean>} True if confirmed
     */
    async function confirmSIPDisconnect() {
      return await showConfirmDialog(
        'Disconnect SIP',
        'Are you sure you want to disconnect from the SIP server? You will not be able to receive calls until reconnected.',
        'Disconnect',
        'Cancel',
        'warning'
      );
    }
    
    /**
     * Initialize all forms on the page
     */
    function initForms() {
      const forms = document.querySelectorAll('form.config-form');
      
      forms.forEach(form => {
        setupFormValidation(form);
        setupFormChangeTracking(form);
        setupFormSubmission(form);
      });
    }
    
    // ===== Task 5.1: Global Search Index =====
    
    /**
     * Search index containing all searchable settings
     * Each entry includes: label, section, field (element ID), and keywords for matching
     */
    const searchIndex = [
      // Dashboard Section
      { label: 'System Restart', section: 'dashboard', field: 'system-restart-btn', keywords: ['restart', 'reboot', 'system', 'reset'] },
      { label: 'Factory Reset', section: 'dashboard', field: 'factory-reset-btn', keywords: ['factory', 'reset', 'erase', 'default', 'clear'] },
      { label: 'Quick Actions', section: 'dashboard', field: 'quick-actions', keywords: ['actions', 'quick', 'dashboard'] },
      
      // SIP Settings Section
      { label: 'SIP Server', section: 'sip', field: 'sip-server', keywords: ['sip', 'server', 'domain', 'host', 'address', 'voip'] },
      { label: 'SIP Username', section: 'sip', field: 'sip-username', keywords: ['sip', 'username', 'user', 'login', 'account', 'auth'] },
      { label: 'SIP Password', section: 'sip', field: 'sip-password', keywords: ['sip', 'password', 'pass', 'auth', 'authentication', 'credentials'] },
      { label: 'SIP Target 1', section: 'sip', field: 'sip-target1', keywords: ['sip', 'target', 'apartment', 'destination', 'call', 'uri', 'apartment1'] },
      { label: 'SIP Target 2', section: 'sip', field: 'sip-target2', keywords: ['sip', 'target', 'apartment', 'destination', 'call', 'uri', 'apartment2'] },
      { label: 'SIP Connection', section: 'sip', field: 'sip-connection', keywords: ['sip', 'connect', 'disconnect', 'connection', 'register'] },
      { label: 'Test SIP Configuration', section: 'sip', field: 'sip-test', keywords: ['sip', 'test', 'verify', 'check', 'configuration'] },
      
      // Network Settings Section
      { label: 'WiFi SSID', section: 'network', field: 'wifi-ssid', keywords: ['wifi', 'ssid', 'network', 'wireless', 'name'] },
      { label: 'WiFi Password', section: 'network', field: 'wifi-password', keywords: ['wifi', 'password', 'pass', 'wireless', 'key'] },
      { label: 'WiFi Scan', section: 'network', field: 'wifi-scan', keywords: ['wifi', 'scan', 'search', 'networks', 'available'] },
      { label: 'IP Configuration', section: 'network', field: 'ip-config', keywords: ['ip', 'address', 'network', 'configuration', 'dhcp', 'static'] },
      { label: 'DHCP Mode', section: 'network', field: 'dhcp-mode', keywords: ['dhcp', 'automatic', 'dynamic', 'ip', 'mode'] },
      { label: 'Static IP Address', section: 'network', field: 'static-ip', keywords: ['static', 'ip', 'address', 'manual', 'fixed'] },
      { label: 'Subnet Mask', section: 'network', field: 'subnet-mask', keywords: ['subnet', 'mask', 'netmask', 'network'] },
      { label: 'Gateway', section: 'network', field: 'gateway', keywords: ['gateway', 'router', 'default', 'route'] },
      { label: 'DNS Server', section: 'network', field: 'dns-server', keywords: ['dns', 'server', 'nameserver', 'resolver'] },
      { label: 'NTP Server', section: 'network', field: 'ntp-server', keywords: ['ntp', 'time', 'server', 'sync', 'clock'] },
      { label: 'Timezone', section: 'network', field: 'timezone', keywords: ['timezone', 'time', 'zone', 'region', 'location'] },
      { label: 'NTP Sync', section: 'network', field: 'ntp-sync', keywords: ['ntp', 'sync', 'synchronize', 'time', 'update'] },
      
      // Hardware Settings Section
      { label: 'Hardware Information', section: 'hardware', field: 'hardware-info', keywords: ['hardware', 'info', 'chip', 'esp32', 'model', 'specs'] },
      { label: 'Chip Model', section: 'hardware', field: 'chip-model', keywords: ['chip', 'model', 'esp32', 'processor', 'cpu'] },
      { label: 'Flash Size', section: 'hardware', field: 'flash-size', keywords: ['flash', 'storage', 'memory', 'size'] },
      { label: 'Free Heap', section: 'hardware', field: 'free-heap', keywords: ['heap', 'memory', 'ram', 'free', 'available'] },
      { label: 'GPIO Pins', section: 'hardware', field: 'gpio-pins', keywords: ['gpio', 'pins', 'io', 'input', 'output'] },
      { label: 'Doorbell Button', section: 'hardware', field: 'doorbell-button', keywords: ['doorbell', 'button', 'bell', 'input', 'gpio'] },
      { label: 'Door Relay', section: 'hardware', field: 'door-relay', keywords: ['door', 'relay', 'opener', 'output', 'gpio'] },
      { label: 'Light Relay', section: 'hardware', field: 'light-relay', keywords: ['light', 'relay', 'output', 'gpio', 'lamp'] },
      { label: 'DTMF Codes', section: 'hardware', field: 'dtmf-codes', keywords: ['dtmf', 'codes', 'tones', 'commands', 'control'] },
      { label: 'BOOT Button', section: 'hardware', field: 'boot-button', keywords: ['boot', 'button', 'gpio0', 'programming'] },
      
      // Security Settings Section
      { label: 'DTMF PIN', section: 'security', field: 'dtmf-pin', keywords: ['dtmf', 'pin', 'code', 'security', 'password', 'access'] },
      { label: 'PIN Enable', section: 'security', field: 'pin-enable', keywords: ['pin', 'enable', 'security', 'protection', 'dtmf'] },
      { label: 'PIN Timeout', section: 'security', field: 'pin-timeout', keywords: ['pin', 'timeout', 'duration', 'time', 'security'] },
      { label: 'Max PIN Attempts', section: 'security', field: 'max-attempts', keywords: ['pin', 'attempts', 'tries', 'maximum', 'security', 'lockout'] },
      { label: 'Security Configuration', section: 'security', field: 'security-config', keywords: ['security', 'config', 'settings', 'protection'] },
      
      // System Logs Section
      { label: 'SIP Logs', section: 'logs', field: 'sip-logs', keywords: ['sip', 'logs', 'history', 'messages', 'connection'] },
      { label: 'DTMF Logs', section: 'logs', field: 'dtmf-logs', keywords: ['dtmf', 'logs', 'security', 'history', 'events'] },
      { label: 'Log Filter', section: 'logs', field: 'log-filter', keywords: ['log', 'filter', 'search', 'find'] },
      { label: 'Log Export', section: 'logs', field: 'log-export', keywords: ['log', 'export', 'download', 'save'] },
      { label: 'Clear Logs', section: 'logs', field: 'clear-logs', keywords: ['log', 'clear', 'delete', 'remove'] },
      { label: 'Auto Refresh Logs', section: 'logs', field: 'auto-refresh', keywords: ['log', 'auto', 'refresh', 'update', 'automatic'] },
      
      // Hardware Testing Section
      { label: 'Test Doorbell', section: 'testing', field: 'test-doorbell', keywords: ['test', 'doorbell', 'button', 'bell', 'simulate'] },
      { label: 'Test Door Opener', section: 'testing', field: 'test-door', keywords: ['test', 'door', 'opener', 'relay', 'trigger'] },
      { label: 'Test Light', section: 'testing', field: 'test-light', keywords: ['test', 'light', 'relay', 'toggle', 'lamp'] },
      { label: 'Hardware Testing', section: 'testing', field: 'hardware-testing', keywords: ['test', 'hardware', 'testing', 'diagnostic'] },
      
      // Email Reports Section
      { label: 'SMTP Server', section: 'email', field: 'smtp-server', keywords: ['smtp', 'server', 'email', 'mail', 'host'] },
      { label: 'SMTP Port', section: 'email', field: 'smtp-port', keywords: ['smtp', 'port', 'email', 'mail'] },
      { label: 'SMTP Username', section: 'email', field: 'smtp-username', keywords: ['smtp', 'username', 'email', 'mail', 'login'] },
      { label: 'SMTP Password', section: 'email', field: 'smtp-password', keywords: ['smtp', 'password', 'email', 'mail', 'auth'] },
      { label: 'Email Sender', section: 'email', field: 'email-sender', keywords: ['email', 'sender', 'from', 'address'] },
      { label: 'Email Recipient', section: 'email', field: 'email-recipient', keywords: ['email', 'recipient', 'to', 'address', 'destination'] },
      { label: 'Report Schedule', section: 'email', field: 'report-schedule', keywords: ['report', 'schedule', 'frequency', 'daily', 'weekly', 'monthly'] },
      { label: 'Test Email', section: 'email', field: 'test-email', keywords: ['test', 'email', 'send', 'verify'] },
      { label: 'Send Report Now', section: 'email', field: 'send-report', keywords: ['send', 'report', 'email', 'now', 'manual'] },
      
      // OTA Update Section
      { label: 'Firmware Version', section: 'ota', field: 'firmware-version', keywords: ['firmware', 'version', 'build', 'software'] },
      { label: 'OTA Update', section: 'ota', field: 'ota-update', keywords: ['ota', 'update', 'upgrade', 'firmware', 'flash'] },
      { label: 'Upload Firmware', section: 'ota', field: 'upload-firmware', keywords: ['upload', 'firmware', 'file', 'binary', 'bin'] },
      { label: 'Update Progress', section: 'ota', field: 'update-progress', keywords: ['update', 'progress', 'status', 'uploading'] },
      
      // Documentation Section
      { label: 'Quick Start Guide', section: 'docs', field: 'quick-start', keywords: ['quick', 'start', 'guide', 'setup', 'getting started', 'help'] },
      { label: 'Hardware Reference', section: 'docs', field: 'hardware-ref', keywords: ['hardware', 'reference', 'pinout', 'wiring', 'specs'] },
      { label: 'SIP Configuration Guide', section: 'docs', field: 'sip-guide', keywords: ['sip', 'guide', 'configuration', 'setup', 'help'] },
      { label: 'DTMF Commands', section: 'docs', field: 'dtmf-commands', keywords: ['dtmf', 'commands', 'codes', 'reference', 'control'] },
      { label: 'Network Guide', section: 'docs', field: 'network-guide', keywords: ['network', 'guide', 'wifi', 'setup', 'help'] },
      { label: 'API Reference', section: 'docs', field: 'api-reference', keywords: ['api', 'reference', 'endpoints', 'rest', 'integration'] },
      { label: 'Troubleshooting', section: 'docs', field: 'troubleshooting', keywords: ['troubleshooting', 'problems', 'issues', 'help', 'fix'] },
      { label: 'FAQ', section: 'docs', field: 'faq', keywords: ['faq', 'questions', 'answers', 'help'] },
      { label: 'Documentation', section: 'docs', field: 'documentation', keywords: ['documentation', 'docs', 'help', 'manual', 'guide'] }
    ];
    
    // ===== Task 5.2: Implement Search Functionality =====
    
    let selectedSearchResultIndex = -1;
    let currentSearchResults = [];
    
    /**
     * Perform search across all settings
     * @param {string} query - Search query string
     * @returns {Array} Array of matching search results
     */
    function performSearch(query) {
      if (!query || query.trim().length === 0) {
        return [];
      }
      
      const searchText = query.toLowerCase().trim();
      const results = [];
      
      // Search through index
      searchIndex.forEach(item => {
        let score = 0;
        
        // Check label (highest priority)
        if (item.label.toLowerCase().includes(searchText)) {
          score += 10;
        }
        
        // Check keywords
        const matchingKeywords = item.keywords.filter(kw => kw.includes(searchText));
        score += matchingKeywords.length * 5;
        
        // Check section name
        if (item.section.toLowerCase().includes(searchText)) {
          score += 3;
        }
        
        // If any match found, add to results
        if (score > 0) {
          results.push({ ...item, score });
        }
      });
      
      // Sort by score (highest first)
      results.sort((a, b) => b.score - a.score);
      
      // Limit to top 10 results
      return results.slice(0, 10);
    }
    
    /**
     * Display search results in dropdown
     * @param {Array} results - Array of search results
     */
    function displaySearchResults(results) {
      const resultsContainer = document.getElementById('search-results');
      
      if (results.length === 0) {
        resultsContainer.innerHTML = '<div class="search-no-results">No results found</div>';
        resultsContainer.hidden = false;
        return;
      }
      
      resultsContainer.innerHTML = '';
      
      results.forEach((result, index) => {
        const resultElement = document.createElement('div');
        resultElement.className = 'search-result';
        resultElement.setAttribute('role', 'option');
        resultElement.setAttribute('data-index', index);
        resultElement.setAttribute('data-section', result.section);
        resultElement.setAttribute('data-field', result.field);
        
        // Get section display name
        const sectionNames = {
          'dashboard': 'Dashboard',
          'sip': 'SIP Settings',
          'network': 'Network',
          'hardware': 'Hardware',
          'security': 'Security',
          'logs': 'System Logs',
          'testing': 'Hardware Testing',
          'email': 'Email Reports',
          'ota': 'OTA Update',
          'docs': 'Documentation'
        };
        
        resultElement.innerHTML = `
          <span class="result-label">${result.label}</span>
          <span class="result-section">${sectionNames[result.section] || result.section}</span>
        `;
        
        // Click handler
        resultElement.addEventListener('click', () => {
          navigateToSearchResult(result.section, result.field);
          hideSearchResults();
        });
        
        resultsContainer.appendChild(resultElement);
      });
      
      resultsContainer.hidden = false;
      currentSearchResults = results;
      selectedSearchResultIndex = -1;
    }
    
    /**
     * Hide search results dropdown
     */
    function hideSearchResults() {
      const resultsContainer = document.getElementById('search-results');
      resultsContainer.hidden = true;
      resultsContainer.innerHTML = '';
      currentSearchResults = [];
      selectedSearchResultIndex = -1;
    }
    
    /**
     * Select a search result by index
     * @param {number} index - Index of result to select
     */
    function selectSearchResult(index) {
      const resultsContainer = document.getElementById('search-results');
      const resultElements = resultsContainer.querySelectorAll('.search-result');
      
      // Remove previous selection
      resultElements.forEach(el => el.classList.remove('selected'));
      
      // Add selection to new index
      if (index >= 0 && index < resultElements.length) {
        resultElements[index].classList.add('selected');
        resultElements[index].scrollIntoView({ block: 'nearest' });
        selectedSearchResultIndex = index;
      }
    }
    
    /**
     * Initialize global search functionality
     */
    function initGlobalSearch() {
      const searchInput = document.getElementById('global-search');
      if (!searchInput) return;
      
      // Search on input
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value;
        
        if (query.trim().length === 0) {
          hideSearchResults();
          return;
        }
        
        const results = performSearch(query);
        displaySearchResults(results);
      });
      
      // Keyboard navigation in search input
      searchInput.addEventListener('keydown', (e) => {
        const resultsContainer = document.getElementById('search-results');
        
        if (resultsContainer.hidden) {
          // Ctrl+K or / to focus search (handled globally below)
          return;
        }
        
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          const nextIndex = selectedSearchResultIndex + 1;
          if (nextIndex < currentSearchResults.length) {
            selectSearchResult(nextIndex);
          }
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          const prevIndex = selectedSearchResultIndex - 1;
          if (prevIndex >= 0) {
            selectSearchResult(prevIndex);
          }
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (selectedSearchResultIndex >= 0 && selectedSearchResultIndex < currentSearchResults.length) {
            const result = currentSearchResults[selectedSearchResultIndex];
            navigateToSearchResult(result.section, result.field);
            hideSearchResults();
            searchInput.blur();
          }
        } else if (e.key === 'Escape') {
          e.preventDefault();
          hideSearchResults();
          searchInput.blur();
        }
      });
      
      // Close search results when clicking outside
      document.addEventListener('click', (e) => {
        const resultsContainer = document.getElementById('search-results');
        if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
          hideSearchResults();
        }
      });
      
      // Global keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        // Ctrl+K or / to focus search
        if ((e.ctrlKey && e.key === 'k') || e.key === '/') {
          // Don't trigger if user is typing in an input
          if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            if (e.key === '/') return; // Allow / in inputs
          }
          
          e.preventDefault();
          searchInput.focus();
          searchInput.select();
        }
        
        // Escape to close search
        if (e.key === 'Escape') {
          const resultsContainer = document.getElementById('search-results');
          if (!resultsContainer.hidden) {
            hideSearchResults();
          }
        }
      });
    }
    
    // ===== Task 5.3: Implement Navigation to Search Results =====
    
    /**
     * Navigate to a search result and highlight the target element
     * @param {string} section - Section ID to navigate to
     * @param {string} field - Field ID to highlight
     */
    function navigateToSearchResult(section, field) {
      // Navigate to the section
      navigateToSection(section);
      
      // Wait for section to render and transition
      setTimeout(() => {
        const element = document.getElementById(field);
        
        if (element) {
          // Scroll element into view
          element.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
          // Add highlight class
          element.classList.add('search-highlight');
          
          // Focus the element if it's focusable
          if (element.tagName === 'INPUT' || 
              element.tagName === 'SELECT' || 
              element.tagName === 'TEXTAREA' || 
              element.tagName === 'BUTTON') {
            element.focus();
          }
          
          // Remove highlight after 2 seconds
          setTimeout(() => {
            element.classList.remove('search-highlight');
          }, 2000);
        } else {
          // If specific field not found, just navigate to section
          console.warn(`Field "${field}" not found in section "${section}"`);
        }
      }, 300);
    }
    
    // ===== Example Action Handlers (demonstrating confirmation dialogs) =====
    
    /**
     * Handle SIP connect action
     */
    async function handleSIPConnect() {
      try {
        showToast('Connecting to SIP server...', 'info');
        const response = await apiRequest('/api/sip/connect', { method: 'POST' });
        showToast(response.message || 'Connected to SIP server successfully!', 'success');
      } catch (error) {
        // Error already shown by apiRequest
      }
    }
    
    /**
     * Handle SIP disconnect action (with confirmation)
     */
    async function handleSIPDisconnect() {
      const confirmed = await confirmSIPDisconnect();
      if (!confirmed) return;
      
      try {
        showToast('Disconnecting from SIP server...', 'info');
        const response = await apiRequest('/api/sip/disconnect', { method: 'POST' });
        showToast(response.message || 'Disconnected from SIP server', 'success');
      } catch (error) {
        // Error already shown by apiRequest
      }
    }
    
    /**
     * Handle SIP test action
     */
    async function handleSIPTest() {
      try {
        showToast('Testing SIP configuration...', 'info');
        const response = await apiRequest('/api/sip/test', { method: 'POST' });
        showToast(response.message || 'SIP configuration test successful!', 'success');
      } catch (error) {
        // Error already shown by apiRequest
      }
    }
    
    /**
     * Handle system restart action (with confirmation)
     */
    async function handleSystemRestart() {
      const confirmed = await confirmSystemRestart();
      if (!confirmed) return;
      
      try {
        showToast('Restarting system...', 'info');
        await apiRequest('/api/system/restart', { method: 'POST' });
        showToast('System is restarting. Page will reload automatically.', 'info', 5000);
        
        // Reload page after delay
        setTimeout(() => {
          window.location.reload();
        }, 5000);
      } catch (error) {
        // Error already shown by apiRequest
      }
    }
    
    /**
     * Handle factory reset action (with confirmation)
     */
    async function handleFactoryReset() {
      const confirmed = await confirmFactoryReset();
      if (!confirmed) return;
      
      try {
        showToast('Performing factory reset...', 'warning');
        await apiRequest('/api/system/factory-reset', { method: 'POST' });
        showToast('Factory reset complete. Device is restarting.', 'info', 5000);
        
        // Reload page after delay
        setTimeout(() => {
          window.location.reload();
        }, 5000);
      } catch (error) {
        // Error already shown by apiRequest
      }
    }
    
    // ===== Task 6: Dashboard Section Functions =====
    
    // ===== Task 6.1: System Information Display =====
    
    /**
     * Update system information display
     */
    async function updateSystemInfo() {
      try {
        const response = await apiRequest('/api/system/status');
        
        // Update uptime
        const uptimeElement = document.getElementById('system-uptime');
        if (uptimeElement && response.uptime !== undefined) {
          uptimeElement.textContent = formatUptime(response.uptime);
        }
        
        // Update free heap
        const heapElement = document.getElementById('system-heap');
        if (heapElement && response.free_heap !== undefined) {
          heapElement.textContent = formatBytes(response.free_heap);
        }
        
        // Update IP address
        const ipElement = document.getElementById('system-ip');
        if (ipElement) {
          // Try to get IP from system status or WiFi status
          const ip = response.ip || response.network?.wifi?.ip || 'N/A';
          ipElement.textContent = ip;
        }
        
        // Update firmware version
        const versionElement = document.getElementById('system-version');
        if (versionElement && response.firmware_version) {
          versionElement.textContent = response.firmware_version;
        }
        
      } catch (error) {
        console.error('Error updating system info:', error);
        // Set error state
        const elements = ['system-uptime', 'system-heap', 'system-ip', 'system-version'];
        elements.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.textContent = 'Error';
        });
      }
    }
    
    /**
     * Format uptime in milliseconds to human-readable string
     * @param {number} uptimeMs - Uptime in milliseconds
     * @returns {string} Formatted uptime string
     */
    function formatUptime(uptimeMs) {
      const seconds = Math.floor(uptimeMs / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);
      
      if (days > 0) {
        return `${days}d ${hours % 24}h ${minutes % 60}m`;
      } else if (hours > 0) {
        return `${hours}h ${minutes % 60}m`;
      } else if (minutes > 0) {
        return `${minutes}m ${seconds % 60}s`;
      } else {
        return `${seconds}s`;
      }
    }
    
    /**
     * Format bytes to human-readable string
     * @param {number} bytes - Number of bytes
     * @returns {string} Formatted bytes string
     */
    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      
      return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
    }
    
    /**
     * Initialize system information display with auto-refresh
     */
    function initSystemInfo() {
      // Initial update
      updateSystemInfo();
      
      // Auto-refresh every 10 seconds
      setInterval(updateSystemInfo, 10000);
    }
    
    // ===== Task 6.3: NTP Sync Status Display =====
    
    /**
     * Update NTP sync status display
     */
    async function updateNTPStatus() {
      try {
        const response = await apiRequest('/api/ntp/status');
        
        const indicatorElement = document.getElementById('ntp-sync-indicator');
        const textElement = document.getElementById('ntp-sync-text');
        const timeElement = document.getElementById('ntp-current-time');
        
        if (response.synced) {
          if (indicatorElement) indicatorElement.textContent = '‚úÖ';
          if (textElement) {
            textElement.textContent = 'Synchronized';
            textElement.style.color = 'var(--color-success)';
          }
        } else {
          if (indicatorElement) indicatorElement.textContent = '‚ùå';
          if (textElement) {
            textElement.textContent = 'Not Synchronized';
            textElement.style.color = 'var(--color-danger)';
          }
        }
        
        if (timeElement && response.current_time) {
          timeElement.textContent = response.current_time;
        }
        
      } catch (error) {
        console.error('Error updating NTP status:', error);
        const indicatorElement = document.getElementById('ntp-sync-indicator');
        const textElement = document.getElementById('ntp-sync-text');
        const timeElement = document.getElementById('ntp-current-time');
        
        if (indicatorElement) indicatorElement.textContent = '‚ùå';
        if (textElement) {
          textElement.textContent = 'Error';
          textElement.style.color = 'var(--color-danger)';
        }
        if (timeElement) timeElement.textContent = 'N/A';
      }
    }
    
    /**
     * Initialize NTP status display with auto-refresh
     */
    function initNTPStatus() {
      // Initial update
      updateNTPStatus();
      
      // Auto-refresh every 10 seconds
      setInterval(updateNTPStatus, 10000);
    }
    
    // ===== Task 6.4: Recent Activity Summary =====
    
    /**
     * Update recent activity display
     */
    async function updateRecentActivity() {
      try {
        const response = await apiRequest('/api/sip/log?limit=10');
        
        const activityContainer = document.getElementById('recent-activity');
        if (!activityContainer) return;
        
        if (!response.entries || response.entries.length === 0) {
          activityContainer.innerHTML = '<div style="text-align: center; color: var(--color-text-secondary); padding: var(--spacing-lg);">No recent activity</div>';
          return;
        }
        
        // Build activity list
        let html = '';
        response.entries.forEach(entry => {
          const typeColor = getLogTypeColor(entry.type);
          const timestamp = formatTimestamp(entry.timestamp);
          
          html += `
            <div style="padding: var(--spacing-sm); border-bottom: 1px solid var(--color-border-light); display: flex; gap: var(--spacing-sm); align-items: start;">
              <span style="color: ${typeColor}; font-weight: var(--font-weight-bold); min-width: 60px; font-size: var(--font-size-sm);">${entry.type || 'INFO'}</span>
              <span style="color: var(--color-text-secondary); font-size: var(--font-size-sm); min-width: 80px;">${timestamp}</span>
              <span style="flex: 1; color: var(--color-text); font-size: var(--font-size-sm);">${escapeHtml(entry.message || '')}</span>
            </div>
          `;
        });
        
        activityContainer.innerHTML = html;
        
      } catch (error) {
        console.error('Error updating recent activity:', error);
        const activityContainer = document.getElementById('recent-activity');
        if (activityContainer) {
          activityContainer.innerHTML = '<div style="text-align: center; color: var(--color-danger); padding: var(--spacing-lg);">Error loading activity</div>';
        }
      }
    }
    
    /**
     * Get color for log type
     * @param {string} type - Log type
     * @returns {string} CSS color value
     */
    function getLogTypeColor(type) {
      const typeUpper = (type || '').toUpperCase();
      switch (typeUpper) {
        case 'ERROR':
          return 'var(--color-danger)';
        case 'WARNING':
        case 'WARN':
          return 'var(--color-warning)';
        case 'SUCCESS':
          return 'var(--color-success)';
        case 'INFO':
          return 'var(--color-info)';
        case 'SENT':
          return 'var(--color-primary)';
        case 'RECEIVED':
          return 'var(--color-info)';
        default:
          return 'var(--color-text-secondary)';
      }
    }
    
    /**
     * Format timestamp to readable string
     * @param {number|string} timestamp - Unix timestamp or ISO string
     * @returns {string} Formatted time string
     */
    function formatTimestamp(timestamp) {
      try {
        const date = new Date(timestamp);
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        return `${hours}:${minutes}:${seconds}`;
      } catch (error) {
        return 'N/A';
      }
    }
    
    /**
     * Escape HTML to prevent XSS
     * @param {string} text - Text to escape
     * @returns {string} Escaped text
     */
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    /**
     * Initialize recent activity display with auto-refresh
     */
    function initRecentActivity() {
      // Initial update
      updateRecentActivity();
      
      // Auto-refresh every 10 seconds
      setInterval(updateRecentActivity, 10000);
    }
    
    // ===== Task 6.5: Backup/Restore Functionality =====
    
    /**
     * Handle configuration backup download
     */
    async function handleBackupConfig() {
      try {
        showToast('Generating configuration backup...', 'info');
        
        const includePasswords = document.getElementById('backup-include-passwords')?.checked ?? true;
        
        // Fetch configuration backup
        const response = await apiRequest(`/api/config/backup?include_passwords=${includePasswords}`);
        
        // Create backup object with metadata
        const backup = {
          version: '1.0',
          timestamp: new Date().toISOString(),
          firmware_version: response.firmware_version || 'unknown',
          include_passwords: includePasswords,
          config: response
        };
        
        // Convert to JSON
        const jsonString = JSON.stringify(backup, null, 2);
        
        // Create blob and download
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        // Create download link
        const a = document.createElement('a');
        a.href = url;
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
        a.download = `esp32-doorstation-backup-${timestamp}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast('Configuration backup downloaded successfully!', 'success');
        
      } catch (error) {
        console.error('Error creating backup:', error);
        // Error already shown by apiRequest
      }
    }
    
    /**
     * Handle restore file selection
     * @param {Event} event - File input change event
     */
    function handleRestoreFileSelected(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // Validate file type
      if (!file.name.endsWith('.json')) {
        showToast('Please select a valid JSON backup file', 'error');
        event.target.value = '';
        return;
      }
      
      // Read file
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const jsonString = e.target.result;
          const backup = JSON.parse(jsonString);
          
          // Validate backup format
          if (!backup.config) {
            throw new Error('Invalid backup file format: missing config data');
          }
          
          // Show preview and confirmation
          await showRestorePreview(backup);
          
        } catch (error) {
          console.error('Error reading backup file:', error);
          showToast('Invalid backup file: ' + error.message, 'error');
        }
        
        // Reset file input
        event.target.value = '';
      };
      
      reader.onerror = () => {
        showToast('Error reading file', 'error');
        event.target.value = '';
      };
      
      reader.readAsText(file);
    }
    
    /**
     * Show restore preview dialog
     * @param {Object} backup - Backup object
     */
    async function showRestorePreview(backup) {
      // Create preview message
      let previewHtml = '<div style="margin-bottom: var(--spacing-md);">';
      previewHtml += '<p style="margin-bottom: var(--spacing-sm);"><strong>Backup Information:</strong></p>';
      previewHtml += '<ul style="margin-left: var(--spacing-lg); margin-bottom: var(--spacing-md);">';
      previewHtml += `<li>Created: ${new Date(backup.timestamp).toLocaleString()}</li>`;
      previewHtml += `<li>Firmware Version: ${backup.firmware_version || 'unknown'}</li>`;
      previewHtml += `<li>Includes Passwords: ${backup.include_passwords ? 'Yes' : 'No'}</li>`;
      previewHtml += '</ul>';
      previewHtml += '<p style="color: var(--color-warning);"><strong>Warning:</strong> This will overwrite your current configuration. The device will restart after restore.</p>';
      previewHtml += '</div>';
      
      // Create custom dialog
      const confirmed = await showCustomDialog(
        'Restore Configuration',
        previewHtml,
        'Restore & Restart',
        'Cancel',
        'warning'
      );
      
      if (confirmed) {
        await performRestore(backup);
      }
    }
    
    /**
     * Show custom dialog with HTML content
     * @param {string} title - Dialog title
     * @param {string} htmlContent - HTML content for dialog body
     * @param {string} confirmText - Confirm button text
     * @param {string} cancelText - Cancel button text
     * @param {string} type - Dialog type
     * @returns {Promise<boolean>} True if confirmed
     */
    function showCustomDialog(title, htmlContent, confirmText = 'Confirm', cancelText = 'Cancel', type = 'warning') {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.className = 'dialog-overlay';
        overlay.setAttribute('role', 'dialog');
        overlay.setAttribute('aria-modal', 'true');
        overlay.setAttribute('aria-labelledby', 'dialog-title');
        
        const dialog = document.createElement('div');
        dialog.className = `dialog dialog-${type}`;
        
        const iconMap = {
          warning: '‚ö†Ô∏è',
          danger: 'üö®',
          info: '‚ÑπÔ∏è'
        };
        const icon = iconMap[type] || iconMap.warning;
        
        dialog.innerHTML = `
          <div class="dialog-header">
            <span class="dialog-icon">${icon}</span>
            <h3 class="dialog-title" id="dialog-title">${title}</h3>
          </div>
          <div class="dialog-body">
            ${htmlContent}
          </div>
          <div class="dialog-footer">
            <button class="btn btn-secondary dialog-cancel">${cancelText}</button>
            <button class="btn btn-${type === 'danger' ? 'danger' : 'primary'} dialog-confirm">${confirmText}</button>
          </div>
        `;
        
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);
        
        setTimeout(() => overlay.classList.add('show'), 10);
        
        const confirmBtn = dialog.querySelector('.dialog-confirm');
        setTimeout(() => confirmBtn.focus(), 100);
        
        confirmBtn.addEventListener('click', () => {
          closeDialog(overlay);
          resolve(true);
        });
        
        const cancelBtn = dialog.querySelector('.dialog-cancel');
        cancelBtn.addEventListener('click', () => {
          closeDialog(overlay);
          resolve(false);
        });
        
        const handleEscape = (e) => {
          if (e.key === 'Escape') {
            closeDialog(overlay);
            resolve(false);
            document.removeEventListener('keydown', handleEscape);
          }
        };
        document.addEventListener('keydown', handleEscape);
        
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) {
            closeDialog(overlay);
            resolve(false);
          }
        });
      });
    }
    
    /**
     * Perform configuration restore
     * @param {Object} backup - Backup object
     */
    async function performRestore(backup) {
      try {
        showToast('Restoring configuration...', 'info');
        
        // Send restore request
        const response = await apiRequest('/api/config/restore', {
          method: 'POST',
          body: JSON.stringify({
            config: backup.config,
            include_passwords: backup.include_passwords
          })
        });
        
        showToast('Configuration restored successfully! Device is restarting...', 'success', 5000);
        
        // Reload page after delay
        setTimeout(() => {
          window.location.reload();
        }, 5000);
        
      } catch (error) {
        console.error('Error restoring configuration:', error);
        // Error already shown by apiRequest
      }
    }
    
    /**
     * Initialize Dashboard section
     */
    function initDashboard() {
      initSystemInfo();
      initNTPStatus();
      initRecentActivity();
      checkCertificateExpiration();
    }
    
    /**
     * Check certificate expiration and display warnings (Task 22)
     */
    async function checkCertificateExpiration() {
      try {
        const response = await apiRequest('/api/cert/info', { method: 'GET' });
        
        // Hide all warning banners initially
        document.getElementById('cert-expiry-warning-banner').style.display = 'none';
        document.getElementById('cert-expiry-critical-banner').style.display = 'none';
        document.getElementById('cert-expired-banner').style.display = 'none';
        
        if (!response || !response.exists) {
          // No certificate found - this is handled elsewhere
          return;
        }
        
        const daysUntilExpiry = response.days_until_expiry;
        const isExpired = response.is_expired;
        
        if (isExpired) {
          // Certificate has expired - show error banner
          document.getElementById('cert-expired-banner').style.display = 'block';
        } else if (daysUntilExpiry < 7) {
          // Certificate expires within 7 days - show critical warning
          const criticalBanner = document.getElementById('cert-expiry-critical-banner');
          const criticalText = document.getElementById('cert-expiry-critical-text');
          criticalBanner.style.display = 'block';
          criticalText.textContent = `Your TLS certificate will expire in ${daysUntilExpiry} day${daysUntilExpiry !== 1 ? 's' : ''}! Immediate action required to prevent loss of secure access.`;
        } else if (daysUntilExpiry < 30) {
          // Certificate expires within 30 days - show warning
          const warningBanner = document.getElementById('cert-expiry-warning-banner');
          const warningText = document.getElementById('cert-expiry-warning-text');
          warningBanner.style.display = 'block';
          warningText.textContent = `Your TLS certificate will expire in ${daysUntilExpiry} days. Please renew or generate a new certificate to maintain secure access.`;
        }
        
      } catch (error) {
        // Silently fail - certificate info might not be available
        console.warn('Failed to check certificate expiration:', error);
      }
    }
    
    /**
     * Quick generate self-signed certificate from dashboard warning (Task 22)
     */
    async function generateSelfSignedCertificateQuick() {
      if (!confirm('Generate a new self-signed certificate? This will replace the current certificate and may require you to accept a new security warning in your browser.')) {
        return;
      }
      
      try {
        showToast('Generating new self-signed certificate...', 'info');
        
        const response = await apiRequest('/api/cert/generate', {
          method: 'POST',
          body: JSON.stringify({
            common_name: 'doorstation.local',
            validity_days: 3650
          })
        });
        
        showToast('Certificate generated successfully! The page will reload in 3 seconds...', 'success');
        
        // Reload page after 3 seconds to apply new certificate
        setTimeout(() => {
          window.location.reload();
        }, 3000);
        
      } catch (error) {
        showToast(error.message || 'Failed to generate certificate', 'error');
      }
    }
    
    /**
     * Scroll to a specific element on the page (Task 22)
     */
    function scrollToElement(elementId) {
      setTimeout(() => {
        const element = document.getElementById(elementId);
        if (element) {
          element.scrollIntoView({ behavior: 'smooth', block: 'start' });
          // Add highlight effect
          element.style.transition = 'box-shadow 0.3s ease';
          element.style.boxShadow = '0 0 0 4px rgba(76, 175, 80, 0.3)';
          setTimeout(() => {
            element.style.boxShadow = '';
          }, 2000);
        }
      }, 300);
    }
    
    // ===== Task 7: SIP Settings Section Functions =====
    
    // ===== Task 7.2: Test Call Buttons =====
    
    /**
     * Handle test call to a specific target
     * @param {number} targetNumber - Target number (1 or 2)
     */
    async function handleTestCall(targetNumber) {
      const buttonId = `test-call-target${targetNumber}`;
      const button = document.getElementById(buttonId);
      if (!button) return;
      
      // Get target value from form
      const targetInput = document.getElementById(`sip-target${targetNumber}`);
      if (!targetInput || !targetInput.value) {
        showToast(`Please configure Target ${targetNumber} first`, 'warning');
        return;
      }
      
      const target = targetInput.value;
      
      // Show loading state
      setLoadingState(button, true);
      
      // Show feedback area
      const feedbackDiv = document.getElementById('test-call-feedback');
      const feedbackIcon = document.getElementById('test-call-icon');
      const feedbackMessage = document.getElementById('test-call-message');
      
      if (feedbackDiv) {
        feedbackDiv.style.display = 'block';
        if (feedbackIcon) feedbackIcon.textContent = '‚è≥';
        if (feedbackMessage) feedbackMessage.textContent = `Initiating test call to ${target}...`;
      }
      
      try {
        showToast(`Initiating test call to Target ${targetNumber}...`, 'info');
        
        const response = await apiRequest('/api/sip/testcall', {
          method: 'POST',
          body: JSON.stringify({ target: target })
        });
        
        // Show success feedback
        if (feedbackIcon) feedbackIcon.textContent = '‚úÖ';
        if (feedbackMessage) {
          feedbackMessage.textContent = response.message || `Test call to ${target} initiated successfully!`;
          feedbackMessage.style.color = 'var(--color-success)';
        }
        
        showToast(response.message || `Test call to Target ${targetNumber} successful!`, 'success');
        
      } catch (error) {
        // Show error feedback
        if (feedbackIcon) feedbackIcon.textContent = '‚ùå';
        if (feedbackMessage) {
          feedbackMessage.textContent = error.message || `Test call to ${target} failed`;
          feedbackMessage.style.color = 'var(--color-danger)';
        }
        // Error already shown by apiRequest
      } finally {
        // Reset button state
        setLoadingState(button, false);
        
        // Hide feedback after 5 seconds
        setTimeout(() => {
          if (feedbackDiv) {
            feedbackDiv.style.display = 'none';
          }
        }, 5000);
      }
    }
    
    // ===== Task 7.3: Connection Management =====
    
    /**
     * Update SIP connection status display
     */
    async function updateSIPConnectionStatus() {
      try {
        const response = await apiRequest('/api/sip/status');
        
        const iconElement = document.getElementById('sip-connection-icon');
        const statusElement = document.getElementById('sip-connection-status');
        const connectBtn = document.getElementById('sip-connect-btn');
        const disconnectBtn = document.getElementById('sip-disconnect-btn');
        
        // API returns capitalized status values like "Registered", "Connecting", etc.
        const status = response.status ? response.status.toLowerCase() : '';
        
        if (status === 'registered') {
          if (iconElement) iconElement.textContent = '‚úÖ';
          if (statusElement) {
            statusElement.textContent = `Registered (${response.state || 'IDLE'})`;
            statusElement.style.color = 'var(--color-success)';
          }
          // Enable disconnect, disable connect
          if (connectBtn) connectBtn.disabled = true;
          if (disconnectBtn) disconnectBtn.disabled = false;
          
        } else if (status === 'connecting') {
          if (iconElement) iconElement.textContent = '‚è≥';
          if (statusElement) {
            statusElement.textContent = 'Connecting...';
            statusElement.style.color = 'var(--color-warning)';
          }
          // Disable both buttons while connecting
          if (connectBtn) connectBtn.disabled = true;
          if (disconnectBtn) disconnectBtn.disabled = true;
          
        } else {
          if (iconElement) iconElement.textContent = '‚ùå';
          if (statusElement) {
            statusElement.textContent = response.status || 'Disconnected';
            statusElement.style.color = 'var(--color-danger)';
          }
          // Enable connect, disable disconnect
          if (connectBtn) connectBtn.disabled = false;
          if (disconnectBtn) disconnectBtn.disabled = true;
        }
        
      } catch (error) {
        console.error('Error updating SIP connection status:', error);
        const iconElement = document.getElementById('sip-connection-icon');
        const statusElement = document.getElementById('sip-connection-status');
        const connectBtn = document.getElementById('sip-connect-btn');
        const disconnectBtn = document.getElementById('sip-disconnect-btn');
        
        if (iconElement) iconElement.textContent = '‚ùå';
        if (statusElement) {
          statusElement.textContent = 'Error';
          statusElement.style.color = 'var(--color-danger)';
        }
        // On error, enable connect button, disable disconnect
        if (connectBtn) connectBtn.disabled = false;
        if (disconnectBtn) disconnectBtn.disabled = true;
      }
    }
    
    /**
     * Enhanced SIP connect handler with status update
     */
    async function handleSIPConnectEnhanced() {
      const button = document.getElementById('sip-connect-btn');
      if (button) setLoadingState(button, true);
      
      try {
        showToast('Connecting to SIP server...', 'info');
        const response = await apiRequest('/api/sip/connect', { method: 'POST' });
        showToast(response.message || 'Connected to SIP server successfully!', 'success');
        
        // Update connection status
        await updateSIPConnectionStatus();
        
      } catch (error) {
        // Error already shown by apiRequest
      } finally {
        if (button) setLoadingState(button, false);
      }
    }
    
    /**
     * Enhanced SIP disconnect handler with status update
     */
    async function handleSIPDisconnectEnhanced() {
      const confirmed = await confirmSIPDisconnect();
      if (!confirmed) return;
      
      const button = document.getElementById('sip-disconnect-btn');
      if (button) setLoadingState(button, true);
      
      try {
        showToast('Disconnecting from SIP server...', 'info');
        const response = await apiRequest('/api/sip/disconnect', { method: 'POST' });
        showToast(response.message || 'Disconnected from SIP server', 'success');
        
        // Update connection status
        await updateSIPConnectionStatus();
        
      } catch (error) {
        // Error already shown by apiRequest
      } finally {
        if (button) setLoadingState(button, false);
      }
    }
    
    /**
     * Enhanced SIP test handler with loading state
     */
    async function handleSIPTestEnhanced() {
      const button = document.getElementById('sip-test-btn');
      if (button) setLoadingState(button, true);
      
      try {
        showToast('Testing SIP configuration...', 'info');
        const response = await apiRequest('/api/sip/test', { method: 'POST' });
        showToast(response.message || 'SIP configuration test successful!', 'success');
      } catch (error) {
        // Error already shown by apiRequest
      } finally {
        if (button) setLoadingState(button, false);
      }
    }
    
    // ===== Task 7.4: Load Existing SIP Configuration =====
    
    /**
     * Load SIP configuration from server and populate form
     */
    async function loadSIPConfiguration() {
      try {
        const response = await apiRequest('/api/sip/config');
        
        // Populate form fields
        const serverInput = document.getElementById('sip-server');
        const usernameInput = document.getElementById('sip-username');
        const passwordInput = document.getElementById('sip-password');
        const target1Input = document.getElementById('sip-target1');
        const target2Input = document.getElementById('sip-target2');
        
        if (serverInput && response.server) serverInput.value = response.server;
        if (usernameInput && response.username) usernameInput.value = response.username;
        if (passwordInput && response.password) passwordInput.value = response.password;
        if (target1Input && response.target1) target1Input.value = response.target1;
        if (target2Input && response.target2) target2Input.value = response.target2;
        
        // Save initial state for change tracking
        const form = document.getElementById('sip-form');
        if (form) {
          saveFormInitialState(form);
          trackFormChanges(form);
        }
        
        console.log('SIP configuration loaded successfully');
        
      } catch (error) {
        console.error('Error loading SIP configuration:', error);
        // Don't show error toast on initial load - config might not exist yet
      }
    }
    
    /**
     * Initialize SIP Settings section
     */
    function initSIPSettings() {
      // Load existing configuration
      loadSIPConfiguration();
      
      // Update connection status
      updateSIPConnectionStatus();
      
      // Auto-refresh connection status every 10 seconds
      setInterval(updateSIPConnectionStatus, 10000);
    }
    
    /**
     * Override global SIP handlers to use enhanced versions
     * This ensures the handlers work from both Dashboard and SIP Settings sections
     */
    window.handleSIPConnect = handleSIPConnectEnhanced;
    window.handleSIPDisconnect = handleSIPDisconnectEnhanced;
    window.handleSIPTest = handleSIPTestEnhanced;
    
    // ===== Task 8: Network Settings Section Functions =====
    
    // ===== Task 8.1: WiFi Configuration =====
    
    /**
     * Handle WiFi network scan
     */
    async function handleWiFiScan() {
      const button = document.getElementById('wifi-scan-btn');
      if (button) setLoadingState(button, true);
      
      try {
        showToast('Scanning for WiFi networks...', 'info');
        const response = await apiRequest('/api/wifi/scan', { method: 'POST' });
        
        if (response.networks && response.networks.length > 0) {
          displayWiFiNetworks(response.networks);
          showToast(`Found ${response.networks.length} network(s)`, 'success');
        } else {
          showToast('No networks found', 'warning');
          document.getElementById('wifi-network-list').style.display = 'none';
        }
        
      } catch (error) {
        // Error already shown by apiRequest
        document.getElementById('wifi-network-list').style.display = 'none';
      } finally {
        if (button) setLoadingState(button, false);
      }
    }
    
    /**
     * Display WiFi networks in the list
     * @param {Array} networks - Array of network objects with ssid and rssi
     */
    function displayWiFiNetworks(networks) {
      const listContainer = document.getElementById('wifi-network-list');
      const networksContainer = document.getElementById('wifi-networks');
      
      if (!networksContainer) return;
      
      // Sort networks by signal strength (RSSI)
      networks.sort((a, b) => b.rssi - a.rssi);
      
      // Build network list HTML
      let html = '';
      networks.forEach(network => {
        const signalStrength = getSignalStrength(network.rssi);
        const signalIcon = getSignalIcon(network.rssi);
        const isSecure = network.auth !== 'OPEN';
        
        html += `
          <div style="display: flex; align-items: center; gap: var(--spacing-md); padding: var(--spacing-md); border-bottom: 1px solid var(--color-border-light); cursor: pointer; transition: background-color var(--transition-fast);" 
               onmouseover="this.style.backgroundColor='var(--color-hover)'" 
               onmouseout="this.style.backgroundColor='transparent'"
               onclick="selectWiFiNetwork('${escapeHtml(network.ssid)}')">
            <span style="font-size: var(--font-size-xl);">${signalIcon}</span>
            <div style="flex: 1;">
              <div style="font-weight: var(--font-weight-medium); color: var(--color-text);">${escapeHtml(network.ssid)}</div>
              <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                ${signalStrength} ‚Ä¢ ${isSecure ? 'üîí Secured' : 'üîì Open'}
              </div>
            </div>
            <span style="color: var(--color-text-secondary); font-size: var(--font-size-sm);">${network.rssi} dBm</span>
          </div>
        `;
      });
      
      networksContainer.innerHTML = html;
      listContainer.style.display = 'block';
    }
    
    /**
     * Get signal strength description from RSSI
     * @param {number} rssi - Signal strength in dBm
     * @returns {string} Signal strength description
     */
    function getSignalStrength(rssi) {
      if (rssi >= -50) return 'Excellent';
      if (rssi >= -60) return 'Good';
      if (rssi >= -70) return 'Fair';
      if (rssi >= -80) return 'Weak';
      return 'Very Weak';
    }
    
    /**
     * Get signal icon from RSSI
     * @param {number} rssi - Signal strength in dBm
     * @returns {string} Signal icon emoji
     */
    function getSignalIcon(rssi) {
      if (rssi >= -50) return 'üì∂';
      if (rssi >= -60) return 'üì∂';
      if (rssi >= -70) return 'üì°';
      if (rssi >= -80) return 'üì°';
      return 'üìâ';
    }
    
    /**
     * Select a WiFi network from the scan results
     * @param {string} ssid - Network SSID
     */
    function selectWiFiNetwork(ssid) {
      const ssidInput = document.getElementById('wifi-ssid');
      const passwordInput = document.getElementById('wifi-password');
      
      if (ssidInput) {
        ssidInput.value = ssid;
        // Trigger change event to update form tracking
        ssidInput.dispatchEvent(new Event('input', { bubbles: true }));
      }
      
      // Focus password field
      if (passwordInput) {
        passwordInput.focus();
      }
      
      showToast(`Selected network: ${ssid}`, 'info', 2000);
    }
    
    /**
     * Load existing WiFi configuration
     */
    async function loadWiFiConfiguration() {
      try {
        const response = await apiRequest('/api/wifi/config');
        
        const ssidInput = document.getElementById('wifi-ssid');
        
        if (ssidInput && response.ssid) {
          ssidInput.value = response.ssid;
        }
        
        // Save initial state for change tracking
        const form = document.getElementById('wifi-form');
        if (form) {
          saveFormInitialState(form);
          trackFormChanges(form);
        }
        
        console.log('WiFi configuration loaded successfully');
        
      } catch (error) {
        console.error('Error loading WiFi configuration:', error);
        // Don't show error toast on initial load
      }
    }
    
    // ===== Task 8.2: IP Configuration =====
    
    /**
     * Toggle IP mode between DHCP and Static
     */
    function toggleIPMode() {
      const dhcpRadio = document.getElementById('ip-mode-dhcp');
      const staticFields = document.getElementById('static-ip-fields');
      const staticInputs = staticFields.querySelectorAll('input');
      
      if (dhcpRadio.checked) {
        // Hide static IP fields
        staticFields.style.display = 'none';
        // Remove required attribute from static IP inputs
        staticInputs.forEach(input => {
          input.removeAttribute('required');
        });
      } else {
        // Show static IP fields
        staticFields.style.display = 'block';
        // Add required attribute to static IP inputs (except dns2)
        staticInputs.forEach(input => {
          if (input.id !== 'dns2') {
            input.setAttribute('required', 'required');
          }
        });
      }
      
      // Trigger form change tracking
      const form = document.getElementById('ip-config-form');
      if (form) {
        trackFormChanges(form);
      }
    }
    
    /**
     * Load existing IP configuration
     */
    async function loadIPConfiguration() {
      try {
        const response = await apiRequest('/api/network/ip');
        
        // Update current IP display
        const currentIPElement = document.getElementById('current-ip');
        const currentModeElement = document.getElementById('current-mode');
        
        if (currentIPElement && response.ip) {
          currentIPElement.textContent = response.ip;
        }
        
        if (currentModeElement && response.mode) {
          currentModeElement.textContent = response.mode.toUpperCase();
        }
        
        // Set mode radio buttons
        const dhcpRadio = document.getElementById('ip-mode-dhcp');
        const staticRadio = document.getElementById('ip-mode-static');
        
        if (response.mode === 'static') {
          if (staticRadio) staticRadio.checked = true;
          toggleIPMode();
          
          // Populate static IP fields
          const ipInput = document.getElementById('static-ip');
          const subnetInput = document.getElementById('subnet-mask');
          const gatewayInput = document.getElementById('gateway');
          const dns1Input = document.getElementById('dns1');
          const dns2Input = document.getElementById('dns2');
          
          if (ipInput && response.ip) ipInput.value = response.ip;
          if (subnetInput && response.subnet) subnetInput.value = response.subnet;
          if (gatewayInput && response.gateway) gatewayInput.value = response.gateway;
          if (dns1Input && response.dns1) dns1Input.value = response.dns1;
          if (dns2Input && response.dns2) dns2Input.value = response.dns2;
        } else {
          if (dhcpRadio) dhcpRadio.checked = true;
          toggleIPMode();
        }
        
        // Save initial state for change tracking
        const form = document.getElementById('ip-config-form');
        if (form) {
          saveFormInitialState(form);
          trackFormChanges(form);
        }
        
        console.log('IP configuration loaded successfully');
        
      } catch (error) {
        console.error('Error loading IP configuration:', error);
        // Set error state
        const currentIPElement = document.getElementById('current-ip');
        const currentModeElement = document.getElementById('current-mode');
        if (currentIPElement) currentIPElement.textContent = 'Error';
        if (currentModeElement) currentModeElement.textContent = 'Error';
      }
    }
    
    // ===== Task 8.3: NTP Configuration =====
    
    /**
     * Load existing NTP configuration
     */
    async function loadNTPConfiguration() {
      try {
        const response = await apiRequest('/api/ntp/config');
        
        const serverInput = document.getElementById('ntp-server');
        const timezoneSelect = document.getElementById('timezone');
        
        if (serverInput && response.server) {
          serverInput.value = response.server;
        }
        
        if (timezoneSelect && response.timezone) {
          timezoneSelect.value = response.timezone;
        }
        
        // Save initial state for change tracking
        const form = document.getElementById('ntp-config-form');
        if (form) {
          saveFormInitialState(form);
          trackFormChanges(form);
        }
        
        console.log('NTP configuration loaded successfully');
        
      } catch (error) {
        console.error('Error loading NTP configuration:', error);
        // Don't show error toast on initial load
      }
    }
    
    /**
     * Update NTP status display in Network Settings section
     */
    async function updateNTPStatusInNetworkSection() {
      try {
        const response = await apiRequest('/api/ntp/status');
        
        const iconElement = document.getElementById('ntp-status-icon');
        const textElement = document.getElementById('ntp-status-text');
        const timeElement = document.getElementById('ntp-status-time');
        
        if (response.synced) {
          if (iconElement) iconElement.textContent = '‚úÖ';
          if (textElement) {
            textElement.textContent = 'Synchronized';
            textElement.style.color = 'var(--color-success)';
          }
        } else {
          if (iconElement) iconElement.textContent = '‚ùå';
          if (textElement) {
            textElement.textContent = 'Not Synchronized';
            textElement.style.color = 'var(--color-danger)';
          }
        }
        
        if (timeElement && response.current_time) {
          timeElement.textContent = response.current_time;
        }
        
      } catch (error) {
        console.error('Error updating NTP status:', error);
        const iconElement = document.getElementById('ntp-status-icon');
        const textElement = document.getElementById('ntp-status-text');
        const timeElement = document.getElementById('ntp-status-time');
        
        if (iconElement) iconElement.textContent = '‚ùå';
        if (textElement) {
          textElement.textContent = 'Error';
          textElement.style.color = 'var(--color-danger)';
        }
        if (timeElement) timeElement.textContent = 'N/A';
      }
    }
    
    /**
     * Handle NTP force sync
     */
    async function handleNTPForceSync() {
      const button = event.target.closest('button');
      if (button) setLoadingState(button, true);
      
      try {
        showToast('Forcing NTP synchronization...', 'info');
        const response = await apiRequest('/api/ntp/sync', { method: 'POST' });
        showToast(response.message || 'NTP sync initiated successfully!', 'success');
        
        // Update status after a short delay
        setTimeout(() => {
          updateNTPStatusInNetworkSection();
        }, 2000);
        
      } catch (error) {
        // Error already shown by apiRequest
      } finally {
        if (button) setLoadingState(button, false);
      }
    }
    
    // ===== Task 8.4: Load Existing Network Configuration =====
    
    /**
     * Initialize Network Settings section
     */
    function initNetworkSettings() {
      // Load existing configurations
      loadWiFiConfiguration();
      loadIPConfiguration();
      loadNTPConfiguration();
      
      // Update NTP status
      updateNTPStatusInNetworkSection();
      
      // Auto-refresh NTP status every 10 seconds
      setInterval(updateNTPStatusInNetworkSection, 10000);
    }
    
    // ===== Task 9: Hardware Settings Functions =====
    
    /**
     * Task 9.1: Fetch and display hardware information
     */
    async function updateHardwareInfo() {
      try {
        const response = await apiRequest('/api/system/status');
        
        if (response) {
          // Update chip information
          document.getElementById('hw-chip-model').textContent = response.chip_model || 'ESP32-S3';
          document.getElementById('hw-chip-revision').textContent = response.chip_revision ? `Rev ${response.chip_revision}` : 'Unknown';
          
          // Update flash information
          if (response.flash_size) {
            document.getElementById('hw-flash-size').textContent = formatBytes(response.flash_size);
          }
          if (response.flash_free !== undefined) {
            document.getElementById('hw-flash-free').textContent = formatBytes(response.flash_free);
          }
          
          // Update PSRAM information
          if (response.psram_size) {
            document.getElementById('hw-psram-size').textContent = formatBytes(response.psram_size);
            document.getElementById('hw-psram-free').textContent = formatBytes(response.psram_free || 0);
          } else {
            document.getElementById('hw-psram-size').textContent = 'Not Available';
            document.getElementById('hw-psram-free').textContent = 'N/A';
          }
          
          // Update heap information
          if (response.free_heap !== undefined) {
            document.getElementById('hw-free-heap').textContent = formatBytes(response.free_heap);
          }
          if (response.min_free_heap !== undefined) {
            document.getElementById('hw-min-heap').textContent = formatBytes(response.min_free_heap);
          }
        }
      } catch (error) {
        console.error('Failed to fetch hardware info:', error);
        // Set error state for all fields
        const fields = ['hw-chip-model', 'hw-chip-revision', 'hw-flash-size', 'hw-flash-free', 
                       'hw-psram-size', 'hw-psram-free', 'hw-free-heap', 'hw-min-heap'];
        fields.forEach(id => {
          const element = document.getElementById(id);
          if (element) element.textContent = 'Error';
        });
      }
    }
    
    /**
     * Task 9.2 & 9.4: Update GPIO states and relay information
     * Note: This endpoint may not be implemented yet, so we fail silently
     */
    async function updateHardwareStatus() {
      try {
        // Try to get hardware status, but don't show errors if endpoint doesn't exist
        const response = await apiRequest('/api/hardware/status', { silentError: true }, 5000);
        
        if (response) {
          // Update GPIO states (Task 9.2)
          updateGPIOState(21, response.buttons?.bell1_active || false);
          updateGPIOState(4, response.buttons?.bell2_active || false);
          updateGPIOState(5, response.door?.status === 'open');
          updateGPIOState(6, response.light?.status === 'on');
          updateGPIOState(0, response.boot_button?.pressed || false);
          
          // Update button last press times (Task 9.4)
          if (response.buttons?.bell1_last_press) {
            document.getElementById('bell1-last-press').textContent = 
              formatRelativeTime(response.buttons.bell1_last_press);
          }
          if (response.buttons?.bell2_last_press) {
            document.getElementById('bell2-last-press').textContent = 
              formatRelativeTime(response.buttons.bell2_last_press);
          }
          
          // Update relay states (Task 9.4)
          updateRelayState('door', response.door?.status === 'open');
          updateRelayState('light', response.light?.status === 'on');
          
          // Update relay last activation times
          if (response.door?.last_activation) {
            document.getElementById('door-last-activation').textContent = 
              formatRelativeTime(response.door.last_activation);
          }
          if (response.light?.last_toggle) {
            document.getElementById('light-last-toggle').textContent = 
              formatRelativeTime(response.light.last_toggle);
          }
          
          // Update BOOT button state (Task 9.5)
          const bootPressed = response.boot_button?.pressed || false;
          const bootIndicator = document.getElementById('boot-button-indicator');
          const bootState = document.getElementById('boot-button-state');
          if (bootIndicator && bootState) {
            bootIndicator.style.backgroundColor = bootPressed ? 
              'var(--color-status-connected)' : 'var(--color-status-inactive)';
            bootState.textContent = bootPressed ? 'Pressed' : 'Not Pressed';
          }
        }
      } catch (error) {
        console.error('Failed to fetch hardware status:', error);
      }
    }
    
    /**
     * Update GPIO state indicator
     * @param {number} gpio - GPIO pin number
     * @param {boolean} active - Whether the GPIO is active
     */
    function updateGPIOState(gpio, active) {
      const stateElement = document.getElementById(`gpio-${gpio}-state`);
      if (stateElement) {
        stateElement.textContent = active ? 'Active' : 'Inactive';
        stateElement.style.backgroundColor = active ? 
          'var(--color-status-connected)' : 'var(--color-status-inactive)';
      }
    }
    
    /**
     * Update relay state indicator
     * @param {string} relay - Relay name ('door' or 'light')
     * @param {boolean} active - Whether the relay is active
     */
    function updateRelayState(relay, active) {
      const indicator = document.getElementById(`${relay}-relay-indicator`);
      const state = document.getElementById(`${relay}-relay-state`);
      
      if (indicator && state) {
        indicator.style.backgroundColor = active ? 
          'var(--color-status-connected)' : 'var(--color-status-inactive)';
        
        if (relay === 'door') {
          state.textContent = active ? 'Active' : 'Inactive';
        } else if (relay === 'light') {
          state.textContent = active ? 'On' : 'Off';
        }
      }
    }
    
    /**
     * Format timestamp to relative time string
     * @param {number} timestamp - Unix timestamp in milliseconds
     * @returns {string} Formatted relative timestamp
     */
    function formatRelativeTime(timestamp) {
      if (!timestamp || timestamp === 0) return 'Never';
      
      const date = new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffSecs = Math.floor(diffMs / 1000);
      const diffMins = Math.floor(diffSecs / 60);
      const diffHours = Math.floor(diffMins / 60);
      const diffDays = Math.floor(diffHours / 24);
      
      // If less than 1 minute ago
      if (diffSecs < 60) {
        return `${diffSecs} second${diffSecs !== 1 ? 's' : ''} ago`;
      }
      // If less than 1 hour ago
      if (diffMins < 60) {
        return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
      }
      // If less than 24 hours ago
      if (diffHours < 24) {
        return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
      }
      // If less than 7 days ago
      if (diffDays < 7) {
        return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
      }
      // Otherwise show full date
      return date.toLocaleString();
    }
    
    /**
     * Initialize Hardware Settings section
     */
    function initHardwareSettings() {
      // Initial load
      updateHardwareInfo();
      updateHardwareStatus();
      
      // Auto-refresh every 10 seconds (Task 9.1 requirement)
      setInterval(() => {
        updateHardwareInfo();
        updateHardwareStatus();
      }, 10000);
    }
    
    // ===== Task 10: Security Settings Functions =====
    
    /**
     * Task 10.4: Load security configuration from server and populate form
     */
    async function loadSecurityConfiguration() {
      try {
        const response = await apiRequest('/api/dtmf/security', { silentError: true });
        
        if (response) {
          // Populate form fields (Task 10.4)
          const pinEnableCheckbox = document.getElementById('security-pin-enable');
          const pinInput = document.getElementById('security-pin-input');
          const timeoutInput = document.getElementById('security-timeout-input');
          const maxAttemptsInput = document.getElementById('security-max-attempts-input');
          
          if (pinEnableCheckbox) pinEnableCheckbox.checked = response.pin_enabled || false;
          if (pinInput && response.pin_code) pinInput.value = response.pin_code;
          if (timeoutInput && response.timeout_ms) timeoutInput.value = response.timeout_ms;
          if (maxAttemptsInput && response.max_attempts) maxAttemptsInput.value = response.max_attempts;
          
          // Update status display (Task 10.2)
          updateSecurityStatus(response);
          
          // Save initial state for change tracking
          const form = document.getElementById('security-form');
          if (form) {
            saveFormInitialState(form);
            trackFormChanges(form);
          }
          
          console.log('Security configuration loaded successfully');
        }
      } catch (error) {
        console.error('Error loading security configuration:', error);
        // Set default values if config doesn't exist
        const pinInput = document.getElementById('security-pin-input');
        const timeoutInput = document.getElementById('security-timeout-input');
        const maxAttemptsInput = document.getElementById('security-max-attempts-input');
        
        if (pinInput && !pinInput.value) pinInput.value = '1234';
        if (timeoutInput && !timeoutInput.value) timeoutInput.value = '10000';
        if (maxAttemptsInput && !maxAttemptsInput.value) maxAttemptsInput.value = '3';
        
        // Save initial state
        const form = document.getElementById('security-form');
        if (form) {
          saveFormInitialState(form);
          trackFormChanges(form);
        }
      }
    }
    
    /**
     * Task 10.2: Update security status display
     * @param {Object} config - Security configuration object
     */
    function updateSecurityStatus(config) {
      // Update PIN enabled status
      const pinEnabledElement = document.getElementById('security-pin-enabled');
      const pinStatusCard = document.getElementById('security-pin-status');
      if (pinEnabledElement) {
        const isEnabled = config.pin_enabled || false;
        pinEnabledElement.textContent = isEnabled ? '‚úÖ Enabled' : '‚ùå Disabled';
        
        // Update status card color
        if (pinStatusCard) {
          pinStatusCard.setAttribute('data-status', isEnabled ? 'connected' : 'disconnected');
        }
      }
      
      // Update PIN code (masked)
      const pinCodeElement = document.getElementById('security-pin-code');
      if (pinCodeElement && config.pin_code) {
        pinCodeElement.textContent = '****';
      }
      
      // Update timeout
      const timeoutElement = document.getElementById('security-timeout');
      if (timeoutElement && config.timeout_ms) {
        timeoutElement.textContent = `${config.timeout_ms} ms`;
      }
      
      // Update max attempts
      const maxAttemptsElement = document.getElementById('security-max-attempts');
      if (maxAttemptsElement && config.max_attempts) {
        maxAttemptsElement.textContent = config.max_attempts;
      }
    }
    
    /**
     * Task 10.3: Handle successful security configuration save
     * @param {Object} response - API response
     */
    function onSecuritySaved(response) {
      // Reload configuration to update status display
      loadSecurityConfiguration();
      
      console.log('Security configuration saved and status updated');
    }
    
    /**
     * Handle admin password change
     * @param {Event} event - Form submit event
     */
    async function handlePasswordChange(event) {
      event.preventDefault();
      
      const form = event.target;
      const submitButton = form.querySelector('button[type="submit"]');
      const btnText = submitButton.querySelector('.btn-text');
      const btnSpinner = submitButton.querySelector('.btn-spinner');
      
      // Get form values
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-new-password').value;
      
      // Clear previous error messages
      form.querySelectorAll('.error-message').forEach(el => {
        el.hidden = true;
        el.textContent = '';
      });
      form.querySelectorAll('input').forEach(input => input.classList.remove('invalid'));
      
      // Validate passwords match
      if (newPassword !== confirmPassword) {
        const confirmInput = document.getElementById('confirm-new-password');
        const errorMsg = confirmInput.nextElementSibling;
        if (errorMsg && errorMsg.classList.contains('error-message')) {
          errorMsg.textContent = 'Passwords do not match';
          errorMsg.hidden = false;
        }
        confirmInput.classList.add('invalid');
        showToast('Passwords do not match', 'error');
        return;
      }
      
      // Validate password strength
      const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{8,}$/;
      if (!passwordRegex.test(newPassword)) {
        const newPasswordInput = document.getElementById('new-password');
        const errorMsg = newPasswordInput.nextElementSibling;
        if (errorMsg && errorMsg.classList.contains('error-message')) {
          errorMsg.textContent = 'Password must be at least 8 characters with uppercase, lowercase, and digit';
          errorMsg.hidden = false;
        }
        newPasswordInput.classList.add('invalid');
        showToast('Password does not meet security requirements', 'error');
        return;
      }
      
      // Set loading state
      submitButton.disabled = true;
      btnText.textContent = 'Changing Password...';
      btnSpinner.hidden = false;
      
      try {
        const response = await apiRequest('/api/auth/change-password', {
          method: 'POST',
          body: JSON.stringify({
            current_password: currentPassword,
            new_password: newPassword
          })
        });
        
        if (response && response.success) {
          showToast('Password changed successfully. You will be logged out.', 'success');
          
          // Clear form
          form.reset();
          
          // Redirect to login page after 2 seconds
          setTimeout(() => {
            window.location.href = '/login.html';
          }, 2000);
        } else {
          const errorMessage = response?.error || 'Failed to change password';
          showToast(errorMessage, 'error');
          
          // Highlight current password field if it's wrong
          if (errorMessage.toLowerCase().includes('current password')) {
            const currentPasswordInput = document.getElementById('current-password');
            currentPasswordInput.classList.add('invalid');
            const errorMsg = currentPasswordInput.nextElementSibling;
            if (errorMsg && errorMsg.classList.contains('error-message')) {
              errorMsg.textContent = 'Current password is incorrect';
              errorMsg.hidden = false;
            }
          }
        }
      } catch (error) {
        console.error('Password change error:', error);
        showToast('Failed to change password. Please try again.', 'error');
      } finally {
        // Reset button state
        submitButton.disabled = false;
        btnText.textContent = 'Change Password';
        btnSpinner.hidden = true;
      }
    }
    
    /**
     * Task 20: Load and display login audit logs
     */
    async function refreshLoginLogs() {
      const container = document.getElementById('login-log-container');
      
      try {
        console.log('Fetching login logs...');
        const response = await apiRequest('/api/auth/logs', { silentError: true });
        console.log('Login logs response:', response);
        
        if (response) {
          // Display logs even if empty array
          displayLoginLogs(response.logs || []);
        } else {
          // No response - show error
          console.error('No response from login logs API');
          if (container) {
            container.innerHTML = '<div style="text-align: center; color: var(--color-danger); padding: var(--spacing-lg);">Failed to load login logs</div>';
          }
        }
      } catch (error) {
        console.error('Error loading login logs:', error);
        if (container) {
          container.innerHTML = '<div style="text-align: center; color: var(--color-danger); padding: var(--spacing-lg);">Failed to load login logs</div>';
        }
      }
    }
    
    /**
     * Task 20: Display login audit logs in the UI
     */
    function displayLoginLogs(logs) {
      const container = document.getElementById('login-log-container');
      if (!container) return;
      
      if (!logs || logs.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--color-text-secondary); padding: var(--spacing-lg);">No login attempts recorded</div>';
        return;
      }
      
      let html = '<table style="width: 100%; border-collapse: collapse; font-size: var(--font-size-sm);">';
      html += '<thead><tr style="border-bottom: 2px solid var(--color-border); text-align: left;">';
      html += '<th style="padding: var(--spacing-sm);">Timestamp</th>';
      html += '<th style="padding: var(--spacing-sm);">Username</th>';
      html += '<th style="padding: var(--spacing-sm);">IP Address</th>';
      html += '<th style="padding: var(--spacing-sm);">Result</th>';
      html += '<th style="padding: var(--spacing-sm);">Status</th>';
      html += '</tr></thead><tbody>';
      
      logs.forEach(log => {
        const date = new Date(log.timestamp * 1000);
        const formattedDate = date.toLocaleString();
        const statusColor = log.success ? 'var(--color-success)' : 'var(--color-danger)';
        const statusIcon = log.success ? '‚úÖ' : '‚ùå';
        
        html += `<tr style="border-bottom: 1px solid var(--color-border);">`;
        html += `<td style="padding: var(--spacing-sm);">${formattedDate}</td>`;
        html += `<td style="padding: var(--spacing-sm);">${escapeHtml(log.username)}</td>`;
        html += `<td style="padding: var(--spacing-sm); font-family: monospace;">${escapeHtml(log.ip_address)}</td>`;
        html += `<td style="padding: var(--spacing-sm);">${escapeHtml(log.result)}</td>`;
        html += `<td style="padding: var(--spacing-sm); color: ${statusColor};">${statusIcon} ${log.success ? 'Success' : 'Failed'}</td>`;
        html += `</tr>`;
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }
    
    /**
     * Helper function to escape HTML
     */
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    /**
     * Task 20: Initialize login logs auto-refresh
     */
    function initLoginLogs() {
      console.log('Initializing login logs...');
      
      // Prevent duplicate initialization
      if (loginLogInitialized) {
        console.log('Login logs already initialized, refreshing...');
        refreshLoginLogs();
        return;
      }
      
      // Load initial logs
      refreshLoginLogs();
      
      // Setup auto-refresh
      const autoRefreshCheckbox = document.getElementById('login-log-auto-refresh');
      if (autoRefreshCheckbox) {
        console.log('Setting up login log auto-refresh, checkbox checked:', autoRefreshCheckbox.checked);
        autoRefreshCheckbox.addEventListener('change', (e) => {
          if (e.target.checked) {
            startLoginLogAutoRefresh();
          } else {
            stopLoginLogAutoRefresh();
          }
        });
        
        // Start auto-refresh if checked
        if (autoRefreshCheckbox.checked) {
          startLoginLogAutoRefresh();
        }
        
        loginLogInitialized = true;
      } else {
        console.error('Login log auto-refresh checkbox not found');
      }
    }
    
    /**
     * Task 20: Start login log auto-refresh
     */
    function startLoginLogAutoRefresh() {
      console.log('Starting login log auto-refresh');
      if (loginLogAutoRefreshInterval) {
        clearInterval(loginLogAutoRefreshInterval);
      }
      loginLogAutoRefreshInterval = setInterval(() => {
        console.log('Auto-refreshing login logs...');
        refreshLoginLogs();
      }, 10000); // Refresh every 10 seconds
    }
    
    /**
     * Task 20: Stop login log auto-refresh
     */
    function stopLoginLogAutoRefresh() {
      console.log('Stopping login log auto-refresh');
      if (loginLogAutoRefreshInterval) {
        clearInterval(loginLogAutoRefreshInterval);
        loginLogAutoRefreshInterval = null;
      }
    }
    
    /**
     * Task 18: Load certificate information and display
     */
    async function loadCertificateInfo() {
      try {
        const response = await apiRequest('/api/cert/info', { silentError: true });
        
        if (response) {
          // Update certificate type
          const certTypeElement = document.getElementById('cert-type');
          if (certTypeElement) {
            certTypeElement.textContent = response.is_self_signed ? 'Self-Signed' : 'CA-Signed';
          }
          
          // Update common name
          const certCNElement = document.getElementById('cert-cn');
          if (certCNElement) {
            certCNElement.textContent = response.common_name || 'N/A';
          }
          
          // Update issuer
          const certIssuerElement = document.getElementById('cert-issuer');
          if (certIssuerElement) {
            certIssuerElement.textContent = response.issuer || 'N/A';
          }
          
          // Update valid from
          const certValidFromElement = document.getElementById('cert-valid-from');
          if (certValidFromElement) {
            certValidFromElement.textContent = response.not_before || 'N/A';
          }
          
          // Update expires
          const certExpiresElement = document.getElementById('cert-expires');
          if (certExpiresElement) {
            certExpiresElement.textContent = response.not_after || 'N/A';
          }
          
          // Update days remaining
          const certDaysRemainingElement = document.getElementById('cert-days-remaining');
          if (certDaysRemainingElement) {
            const daysRemaining = response.days_until_expiry || 0;
            certDaysRemainingElement.textContent = daysRemaining > 0 ? `${daysRemaining} days` : 'Expired';
            
            // Color code based on days remaining
            if (daysRemaining < 0) {
              certDaysRemainingElement.style.color = 'var(--color-danger)';
            } else if (daysRemaining < 30) {
              certDaysRemainingElement.style.color = 'var(--color-warning)';
            } else {
              certDaysRemainingElement.style.color = 'var(--color-success)';
            }
          }
          
          // Show expiration warning if needed
          const warningElement = document.getElementById('cert-expiry-warning');
          const warningTextElement = document.getElementById('cert-expiry-warning-text');
          if (warningElement && warningTextElement) {
            const daysRemaining = response.days_until_expiry || 0;
            if (response.is_expiring_soon || daysRemaining < 30) {
              warningElement.style.display = 'block';
              if (daysRemaining < 0) {
                warningTextElement.textContent = 'Your certificate has expired! Please generate a new certificate or upload a valid one.';
                warningElement.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
                warningElement.style.borderColor = 'var(--color-danger)';
              } else if (daysRemaining < 7) {
                warningTextElement.textContent = `Your certificate will expire in ${daysRemaining} days. Please renew it soon.`;
                warningElement.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
                warningElement.style.borderColor = 'var(--color-danger)';
              } else {
                warningTextElement.textContent = `Your certificate will expire in ${daysRemaining} days. Consider renewing it.`;
              }
            } else {
              warningElement.style.display = 'none';
            }
          }
          
          console.log('Certificate information loaded successfully');
        }
      } catch (error) {
        console.error('Error loading certificate information:', error);
        // Set default values if cert info doesn't exist
        const certTypeElement = document.getElementById('cert-type');
        if (certTypeElement) certTypeElement.textContent = 'Not Available';
      }
    }
    
    /**
     * Task 18: Generate self-signed certificate
     */
    async function generateSelfSignedCertificate() {
      const button = document.getElementById('generate-cert-btn');
      const commonNameInput = document.getElementById('cert-common-name');
      
      if (!commonNameInput || !commonNameInput.value.trim()) {
        showToast('Please enter a common name for the certificate', 'error');
        return;
      }
      
      const commonName = commonNameInput.value.trim();
      
      // Confirm action
      const confirmed = await showConfirmDialog(
        'Generate Self-Signed Certificate',
        `This will generate a new self-signed certificate for "${commonName}". The web server will restart and you may need to reconnect. Continue?`,
        'warning'
      );
      
      if (!confirmed) return;
      
      if (button) setLoadingState(button, true);
      
      try {
        showToast('Generating self-signed certificate...', 'info');
        
        const response = await apiRequest('/api/cert/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ common_name: commonName })
        });
        
        if (response && response.success) {
          showToast('Certificate generated successfully! Web server will restart...', 'success');
          
          // Reload certificate info after a delay
          setTimeout(() => {
            loadCertificateInfo();
          }, 3000);
        } else {
          showToast(response?.message || 'Failed to generate certificate', 'error');
        }
      } catch (error) {
        console.error('Error generating certificate:', error);
        showToast('Error generating certificate: ' + error.message, 'error');
      } finally {
        if (button) setLoadingState(button, false);
      }
    }
    
    /**
     * Task 18: Upload custom certificate
     */
    async function uploadCustomCertificate() {
      const button = document.getElementById('upload-cert-btn');
      const certFileInput = document.getElementById('cert-file-input');
      const keyFileInput = document.getElementById('key-file-input');
      const chainFileInput = document.getElementById('chain-file-input');
      
      if (!certFileInput || !certFileInput.files || certFileInput.files.length === 0) {
        showToast('Please select a certificate file', 'error');
        return;
      }
      
      if (!keyFileInput || !keyFileInput.files || keyFileInput.files.length === 0) {
        showToast('Please select a private key file', 'error');
        return;
      }
      
      // Confirm action
      const confirmed = await showConfirmDialog(
        'Upload Custom Certificate',
        'This will replace the current certificate. The web server will restart and you may need to reconnect. Continue?',
        'warning'
      );
      
      if (!confirmed) return;
      
      if (button) setLoadingState(button, true);
      
      try {
        showToast('Uploading certificate...', 'info');
        
        // Read files as text
        const certPem = await readFileAsText(certFileInput.files[0]);
        const keyPem = await readFileAsText(keyFileInput.files[0]);
        const chainPem = chainFileInput && chainFileInput.files && chainFileInput.files.length > 0 
          ? await readFileAsText(chainFileInput.files[0]) 
          : null;
        
        // Validate PEM format
        if (!certPem.includes('-----BEGIN CERTIFICATE-----')) {
          showToast('Invalid certificate file format. Must be PEM format.', 'error');
          if (button) setLoadingState(button, false);
          return;
        }
        
        if (!keyPem.includes('-----BEGIN') || !keyPem.includes('PRIVATE KEY-----')) {
          showToast('Invalid private key file format. Must be PEM format.', 'error');
          if (button) setLoadingState(button, false);
          return;
        }
        
        // Upload certificate
        const response = await apiRequest('/api/cert/upload', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            cert_pem: certPem,
            key_pem: keyPem,
            chain_pem: chainPem
          })
        });
        
        if (response && response.success) {
          showToast('Certificate uploaded successfully! Web server will restart...', 'success');
          
          // Clear file inputs
          certFileInput.value = '';
          keyFileInput.value = '';
          if (chainFileInput) chainFileInput.value = '';
          
          // Reload certificate info after a delay
          setTimeout(() => {
            loadCertificateInfo();
          }, 3000);
        } else {
          showToast(response?.message || 'Failed to upload certificate', 'error');
        }
      } catch (error) {
        console.error('Error uploading certificate:', error);
        showToast('Error uploading certificate: ' + error.message, 'error');
      } finally {
        if (button) setLoadingState(button, false);
      }
    }
    
    /**
     * Task 18: Download current certificate
     */
    async function downloadCertificate() {
      try {
        showToast('Downloading certificate...', 'info');
        
        const response = await apiRequest('/api/cert/download');
        
        if (response && response.cert_pem) {
          // Create a blob and download
          const blob = new Blob([response.cert_pem], { type: 'application/x-pem-file' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'certificate.pem';
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
          
          showToast('Certificate downloaded successfully', 'success');
        } else {
          showToast('Failed to download certificate', 'error');
        }
      } catch (error) {
        console.error('Error downloading certificate:', error);
        showToast('Error downloading certificate: ' + error.message, 'error');
      }
    }
    
    /**
     * Helper function to read file as text
     * @param {File} file - File to read
     * @returns {Promise<string>} File content as text
     */
    function readFileAsText(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = (e) => reject(new Error('Failed to read file'));
        reader.readAsText(file);
      });
    }
    
    /**
     * Initialize Security Settings section
     */
    function initSecuritySettings() {
      // Load existing configuration
      loadSecurityConfiguration();
      // Load certificate information (Task 18)
      loadCertificateInfo();
      // Note: initLoginLogs() is called when navigating to security section
    }
    
    // ===== Task 11: System Logs Section Functions =====
    
    // Log storage
    let sipLogEntries = [];
    let dtmfLogEntries = [];
    let sipLogLastTimestamp = 0;
    let dtmfLogLastTimestamp = 0;
    let sipLogAutoRefreshInterval = null;
    let dtmfLogAutoRefreshInterval = null;
    let loginLogAutoRefreshInterval = null;
    let loginLogInitialized = false;
    let sipLogCurrentFilter = 'all';
    let dtmfLogCurrentFilter = 'all';
    
    // ===== Task 11.1: SIP Connection Log Display =====
    
    /**
     * Initialize SIP logs section
     */
    function initSIPLogs() {
      // Load initial logs
      refreshSIPLogs();
      
      // Setup auto-refresh
      const autoRefreshCheckbox = document.getElementById('sip-log-auto-refresh');
      if (autoRefreshCheckbox) {
        autoRefreshCheckbox.addEventListener('change', (e) => {
          if (e.target.checked) {
            startSIPLogAutoRefresh();
          } else {
            stopSIPLogAutoRefresh();
          }
        });
        
        // Start auto-refresh if checked
        if (autoRefreshCheckbox.checked) {
          startSIPLogAutoRefresh();
        }
      }
      
      // Setup search input
      const searchInput = document.getElementById('sip-log-search');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          filterAndDisplaySIPLogs();
        });
      }
      
      // Setup scroll detection for jump to bottom button
      const container = document.getElementById('sip-log-container');
      if (container) {
        container.addEventListener('scroll', () => {
          updateSIPLogJumpButton();
        });
      }
    }
    
    /**
     * Start SIP log auto-refresh
     */
    function startSIPLogAutoRefresh() {
      if (sipLogAutoRefreshInterval) {
        clearInterval(sipLogAutoRefreshInterval);
      }
      sipLogAutoRefreshInterval = setInterval(() => {
        refreshSIPLogs(true); // Silent refresh
      }, 10000); // Refresh every 10 seconds
    }
    
    /**
     * Stop SIP log auto-refresh
     */
    function stopSIPLogAutoRefresh() {
      if (sipLogAutoRefreshInterval) {
        clearInterval(sipLogAutoRefreshInterval);
        sipLogAutoRefreshInterval = null;
      }
    }
    
    /**
     * Refresh SIP logs from server
     * @param {boolean} silent - If true, don't show loading message
     */
    async function refreshSIPLogs(silent = false) {
      try {
        // Fetch logs since last timestamp (incremental)
        const endpoint = sipLogLastTimestamp > 0 
          ? `/api/sip/log?since=${sipLogLastTimestamp}`
          : '/api/sip/log';
        
        const response = await apiRequest(endpoint, { silentError: silent });
        
        if (response && response.entries && Array.isArray(response.entries)) {
          // Append new entries
          if (response.entries.length > 0) {
            sipLogEntries = sipLogEntries.concat(response.entries);
            
            // Update last timestamp
            const timestamps = response.entries.map(e => e.timestamp || 0);
            sipLogLastTimestamp = Math.max(...timestamps, sipLogLastTimestamp);
            
            // Keep only last 1000 entries to prevent memory issues
            if (sipLogEntries.length > 1000) {
              sipLogEntries = sipLogEntries.slice(-1000);
            }
          }
        }
        
        // Display logs
        filterAndDisplaySIPLogs();
        
      } catch (error) {
        if (!silent) {
          console.error('Error refreshing SIP logs:', error);
          const container = document.getElementById('sip-log-container');
          container.innerHTML = '<div style="text-align: center; color: var(--color-danger); padding: var(--spacing-lg);">Error loading SIP logs</div>';
        }
      }
    }
    
    /**
     * Filter and display SIP logs based on current filter and search
     */
    function filterAndDisplaySIPLogs() {
      const searchQuery = document.getElementById('sip-log-search')?.value.toLowerCase() || '';
      
      // Filter by type
      let filtered = sipLogEntries;
      if (sipLogCurrentFilter !== 'all') {
        filtered = filtered.filter(entry => {
          const type = (entry.type || '').toLowerCase();
          return type === sipLogCurrentFilter;
        });
      }
      
      // Filter by search query
      if (searchQuery) {
        filtered = filtered.filter(entry => {
          const message = (entry.message || '').toLowerCase();
          const type = (entry.type || '').toLowerCase();
          return message.includes(searchQuery) || type.includes(searchQuery);
        });
      }
      
      // Update filter count
      const countElement = document.getElementById('sip-log-filter-count');
      if (countElement) {
        if (filtered.length === sipLogEntries.length) {
          countElement.textContent = `Showing all ${sipLogEntries.length} entries`;
        } else {
          countElement.textContent = `Showing ${filtered.length} of ${sipLogEntries.length} entries`;
        }
      }
      
      // Display logs
      displaySIPLogs(filtered, searchQuery);
    }
    
    /**
     * Display SIP logs in the container
     * @param {Array} logs - Array of log entries to display
     * @param {string} searchQuery - Search query for highlighting
     */
    function displaySIPLogs(logs, searchQuery = '') {
      const container = document.getElementById('sip-log-container');
      if (!container) return;
      
      if (logs.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--color-text-secondary); padding: var(--spacing-lg);">No log entries</div>';
        return;
      }
      
      // Remember scroll position
      const wasAtBottom = isScrolledToBottom(container);
      
      // Build HTML
      let html = '';
      logs.forEach(entry => {
        const timestamp = formatTimestamp(entry.timestamp);
        const type = entry.type || 'info';
        const message = entry.message || '';
        
        // Color coding by type
        let color = 'var(--color-text)';
        if (type.toLowerCase() === 'error') {
          color = 'var(--color-danger)';
        } else if (type.toLowerCase() === 'sent') {
          color = 'var(--color-primary)';
        } else if (type.toLowerCase() === 'received') {
          color = 'var(--color-warning)';
        } else if (type.toLowerCase() === 'info') {
          color = 'var(--color-info)';
        }
        
        // Highlight search terms
        let displayMessage = message;
        if (searchQuery) {
          const regex = new RegExp(`(${escapeRegex(searchQuery)})`, 'gi');
          displayMessage = message.replace(regex, '<mark style="background-color: var(--color-warning); padding: 2px 4px; border-radius: 2px;">$1</mark>');
        }
        
        html += `<div style="margin-bottom: var(--spacing-xs); padding: var(--spacing-xs); border-left: 3px solid ${color}; padding-left: var(--spacing-sm);">`;
        html += `<span style="color: var(--color-text-secondary);">[${timestamp}]</span> `;
        html += `<span style="color: ${color}; font-weight: var(--font-weight-bold);">[${type.toUpperCase()}]</span> `;
        html += `<span style="color: var(--color-text);">${displayMessage}</span>`;
        html += `</div>`;
      });
      
      container.innerHTML = html;
      
      // Scroll to bottom if was at bottom before
      if (wasAtBottom) {
        container.scrollTop = container.scrollHeight;
      }
      
      // Update jump button visibility
      updateSIPLogJumpButton();
    }
    
    /**
     * Filter SIP logs by type
     * @param {string} type - Log type to filter ('all', 'error', 'info', 'sent', 'received')
     */
    function filterSIPLogs(type) {
      sipLogCurrentFilter = type;
      
      // Update button states
      const buttons = document.querySelectorAll('#section-logs button[data-filter]');
      buttons.forEach(btn => {
        if (btn.dataset.filter === type) {
          btn.style.opacity = '1';
          btn.style.transform = 'scale(1.05)';
        } else {
          btn.style.opacity = '0.7';
          btn.style.transform = 'scale(1)';
        }
      });
      
      filterAndDisplaySIPLogs();
    }
    
    /**
     * Clear SIP log display
     */
    function clearSIPLogDisplay() {
      sipLogEntries = [];
      sipLogLastTimestamp = 0;
      const container = document.getElementById('sip-log-container');
      if (container) {
        container.innerHTML = '<div style="text-align: center; color: var(--color-text-secondary); padding: var(--spacing-lg);">Log display cleared</div>';
      }
      const countElement = document.getElementById('sip-log-filter-count');
      if (countElement) {
        countElement.textContent = 'Showing 0 entries';
      }
    }
    
    /**
     * Update jump to bottom button visibility for SIP logs
     */
    function updateSIPLogJumpButton() {
      const container = document.getElementById('sip-log-container');
      const button = document.getElementById('sip-log-jump-bottom');
      if (!container || !button) return;
      
      const isAtBottom = isScrolledToBottom(container);
      button.style.display = isAtBottom ? 'none' : 'inline-flex';
    }
    
    /**
     * Jump to bottom of SIP log
     */
    function jumpToBottomSIPLog() {
      const container = document.getElementById('sip-log-container');
      if (container) {
        container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
      }
    }
    
    /**
     * Export SIP logs to text file
     */
    function exportSIPLogs() {
      if (sipLogEntries.length === 0) {
        showToast('No logs to export', 'warning');
        return;
      }
      
      // Get filtered logs
      const searchQuery = document.getElementById('sip-log-search')?.value.toLowerCase() || '';
      let filtered = sipLogEntries;
      
      if (sipLogCurrentFilter !== 'all') {
        filtered = filtered.filter(entry => {
          const type = (entry.type || '').toLowerCase();
          return type === sipLogCurrentFilter;
        });
      }
      
      if (searchQuery) {
        filtered = filtered.filter(entry => {
          const message = (entry.message || '').toLowerCase();
          const type = (entry.type || '').toLowerCase();
          return message.includes(searchQuery) || type.includes(searchQuery);
        });
      }
      
      // Build text content
      let content = 'ESP32 SIP Door Station - SIP Connection Logs\n';
      content += `Exported: ${new Date().toISOString()}\n`;
      content += `Total Entries: ${filtered.length}\n`;
      content += '='.repeat(80) + '\n\n';
      
      filtered.forEach(entry => {
        const timestamp = formatTimestamp(entry.timestamp);
        const type = entry.type || 'info';
        const message = entry.message || '';
        content += `[${timestamp}] [${type.toUpperCase()}] ${message}\n`;
      });
      
      // Create and download file
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `sip-logs-${Date.now()}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showToast(`Exported ${filtered.length} log entries`, 'success');
    }
    
    // ===== Task 11.2: DTMF Security Log Display =====
    
    /**
     * Initialize DTMF logs section
     */
    function initDTMFLogs() {
      // Load initial logs
      refreshDTMFLogs();
      
      // Setup auto-refresh
      const autoRefreshCheckbox = document.getElementById('dtmf-log-auto-refresh');
      if (autoRefreshCheckbox) {
        autoRefreshCheckbox.addEventListener('change', (e) => {
          if (e.target.checked) {
            startDTMFLogAutoRefresh();
          } else {
            stopDTMFLogAutoRefresh();
          }
        });
        
        // Start auto-refresh if checked
        if (autoRefreshCheckbox.checked) {
          startDTMFLogAutoRefresh();
        }
      }
      
      // Setup search input
      const searchInput = document.getElementById('dtmf-log-search');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          filterAndDisplayDTMFLogs();
        });
      }
      
      // Setup scroll detection for jump to bottom button
      const container = document.getElementById('dtmf-log-container');
      if (container) {
        container.addEventListener('scroll', () => {
          updateDTMFLogJumpButton();
        });
      }
    }
    
    /**
     * Start DTMF log auto-refresh
     */
    function startDTMFLogAutoRefresh() {
      if (dtmfLogAutoRefreshInterval) {
        clearInterval(dtmfLogAutoRefreshInterval);
      }
      dtmfLogAutoRefreshInterval = setInterval(() => {
        refreshDTMFLogs(true); // Silent refresh
      }, 10000); // Refresh every 10 seconds
    }
    
    /**
     * Stop DTMF log auto-refresh
     */
    function stopDTMFLogAutoRefresh() {
      if (dtmfLogAutoRefreshInterval) {
        clearInterval(dtmfLogAutoRefreshInterval);
        dtmfLogAutoRefreshInterval = null;
      }
    }
    
    /**
     * Refresh DTMF logs from server
     * @param {boolean} silent - If true, don't show loading message
     */
    async function refreshDTMFLogs(silent = false) {
      try {
        // Fetch logs since last timestamp (incremental)
        const endpoint = dtmfLogLastTimestamp > 0 
          ? `/api/dtmf/logs?since=${dtmfLogLastTimestamp}`
          : '/api/dtmf/logs';
        
        const response = await apiRequest(endpoint, { silentError: silent });
        
        if (response && response.logs && Array.isArray(response.logs)) {
          // Append new entries
          if (response.logs.length > 0) {
            dtmfLogEntries = dtmfLogEntries.concat(response.logs);
            
            // Update last timestamp
            const timestamps = response.logs.map(e => e.timestamp || 0);
            dtmfLogLastTimestamp = Math.max(...timestamps, dtmfLogLastTimestamp);
            
            // Keep only last 1000 entries to prevent memory issues
            if (dtmfLogEntries.length > 1000) {
              dtmfLogEntries = dtmfLogEntries.slice(-1000);
            }
          }
        }
        
        // Display logs
        filterAndDisplayDTMFLogs();
        
      } catch (error) {
        if (!silent) {
          console.error('Error refreshing DTMF logs:', error);
          const container = document.getElementById('dtmf-log-container');
          container.innerHTML = '<div style="text-align: center; color: var(--color-danger); padding: var(--spacing-lg);">Error loading DTMF logs</div>';
        }
      }
    }
    
    /**
     * Filter and display DTMF logs based on current filter and search
     */
    function filterAndDisplayDTMFLogs() {
      const searchQuery = document.getElementById('dtmf-log-search')?.value.toLowerCase() || '';
      
      // Filter by type
      let filtered = dtmfLogEntries;
      if (dtmfLogCurrentFilter !== 'all') {
        filtered = filtered.filter(entry => {
          const success = entry.success === true || entry.success === 'true';
          if (dtmfLogCurrentFilter === 'success') {
            return success;
          } else if (dtmfLogCurrentFilter === 'failed') {
            return !success;
          }
          return true;
        });
      }
      
      // Filter by search query
      if (searchQuery) {
        filtered = filtered.filter(entry => {
          const command = (entry.command || '').toLowerCase();
          const type = (entry.type || '').toLowerCase();
          return command.includes(searchQuery) || type.includes(searchQuery);
        });
      }
      
      // Update filter count
      const countElement = document.getElementById('dtmf-log-filter-count');
      if (countElement) {
        if (filtered.length === dtmfLogEntries.length) {
          countElement.textContent = `Showing all ${dtmfLogEntries.length} entries`;
        } else {
          countElement.textContent = `Showing ${filtered.length} of ${dtmfLogEntries.length} entries`;
        }
      }
      
      // Display logs
      displayDTMFLogs(filtered, searchQuery);
    }
    
    /**
     * Display DTMF logs in the container
     * @param {Array} logs - Array of log entries to display
     * @param {string} searchQuery - Search query for highlighting
     */
    function displayDTMFLogs(logs, searchQuery = '') {
      const container = document.getElementById('dtmf-log-container');
      if (!container) return;
      
      if (logs.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--color-text-secondary); padding: var(--spacing-lg);">No log entries</div>';
        return;
      }
      
      // Remember scroll position
      const wasAtBottom = isScrolledToBottom(container);
      
      // Build HTML
      let html = '';
      logs.forEach(entry => {
        const timestamp = formatTimestamp(entry.timestamp);
        const command = entry.command || '';
        const type = entry.type || '';
        const success = entry.success === true || entry.success === 'true';
        
        // Color coding and icon
        const icon = success ? '‚úÖ' : '‚ùå';
        const color = success ? 'var(--color-success)' : 'var(--color-danger)';
        
        // Highlight search terms
        let displayCommand = command;
        if (searchQuery) {
          const regex = new RegExp(`(${escapeRegex(searchQuery)})`, 'gi');
          displayCommand = command.replace(regex, '<mark style="background-color: var(--color-warning); padding: 2px 4px; border-radius: 2px;">$1</mark>');
        }
        
        html += `<div style="margin-bottom: var(--spacing-xs); padding: var(--spacing-xs); border-left: 3px solid ${color}; padding-left: var(--spacing-sm);">`;
        html += `<span style="color: var(--color-text-secondary);">[${timestamp}]</span> `;
        html += `<span style="font-size: var(--font-size-lg);">${icon}</span> `;
        html += `<span style="color: ${color}; font-weight: var(--font-weight-bold);">[${type.toUpperCase()}]</span> `;
        html += `<span style="color: var(--color-text);">Command: ${displayCommand}</span>`;
        html += `</div>`;
      });
      
      container.innerHTML = html;
      
      // Scroll to bottom if was at bottom before
      if (wasAtBottom) {
        container.scrollTop = container.scrollHeight;
      }
      
      // Update jump button visibility
      updateDTMFLogJumpButton();
    }
    
    /**
     * Filter DTMF logs by type
     * @param {string} type - Log type to filter ('all', 'success', 'failed')
     */
    function filterDTMFLogs(type) {
      dtmfLogCurrentFilter = type;
      
      // Update button states
      const buttons = document.querySelectorAll('#section-logs button[data-filter]');
      buttons.forEach(btn => {
        if (btn.dataset.filter === type) {
          btn.style.opacity = '1';
          btn.style.transform = 'scale(1.05)';
        } else {
          btn.style.opacity = '0.7';
          btn.style.transform = 'scale(1)';
        }
      });
      
      filterAndDisplayDTMFLogs();
    }
    
    /**
     * Clear DTMF log display
     */
    function clearDTMFLogDisplay() {
      dtmfLogEntries = [];
      dtmfLogLastTimestamp = 0;
      const container = document.getElementById('dtmf-log-container');
      if (container) {
        container.innerHTML = '<div style="text-align: center; color: var(--color-text-secondary); padding: var(--spacing-lg);">Log display cleared</div>';
      }
      const countElement = document.getElementById('dtmf-log-filter-count');
      if (countElement) {
        countElement.textContent = 'Showing 0 entries';
      }
    }
    
    /**
     * Update jump to bottom button visibility for DTMF logs
     */
    function updateDTMFLogJumpButton() {
      const container = document.getElementById('dtmf-log-container');
      const button = document.getElementById('dtmf-log-jump-bottom');
      if (!container || !button) return;
      
      const isAtBottom = isScrolledToBottom(container);
      button.style.display = isAtBottom ? 'none' : 'inline-flex';
    }
    
    /**
     * Jump to bottom of DTMF log
     */
    function jumpToBottomDTMFLog() {
      const container = document.getElementById('dtmf-log-container');
      if (container) {
        container.scrollTo({ top: container.scrollHeight, behavior: 'smooth' });
      }
    }
    
    /**
     * Export DTMF logs to text file
     */
    function exportDTMFLogs() {
      if (dtmfLogEntries.length === 0) {
        showToast('No logs to export', 'warning');
        return;
      }
      
      // Get filtered logs
      const searchQuery = document.getElementById('dtmf-log-search')?.value.toLowerCase() || '';
      let filtered = dtmfLogEntries;
      
      if (dtmfLogCurrentFilter !== 'all') {
        filtered = filtered.filter(entry => {
          const success = entry.success === true || entry.success === 'true';
          if (dtmfLogCurrentFilter === 'success') {
            return success;
          } else if (dtmfLogCurrentFilter === 'failed') {
            return !success;
          }
          return true;
        });
      }
      
      if (searchQuery) {
        filtered = filtered.filter(entry => {
          const command = (entry.command || '').toLowerCase();
          const type = (entry.type || '').toLowerCase();
          return command.includes(searchQuery) || type.includes(searchQuery);
        });
      }
      
      // Build text content
      let content = 'ESP32 SIP Door Station - DTMF Security Logs\n';
      content += `Exported: ${new Date().toISOString()}\n`;
      content += `Total Entries: ${filtered.length}\n`;
      content += '='.repeat(80) + '\n\n';
      
      filtered.forEach(entry => {
        const timestamp = formatTimestamp(entry.timestamp);
        const command = entry.command || '';
        const type = entry.type || '';
        const success = entry.success === true || entry.success === 'true';
        const status = success ? 'SUCCESS' : 'FAILED';
        content += `[${timestamp}] [${status}] [${type.toUpperCase()}] Command: ${command}\n`;
      });
      
      // Create and download file
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `dtmf-logs-${Date.now()}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showToast(`Exported ${filtered.length} log entries`, 'success');
    }
    
    // ===== Helper Functions for Logs =====
    
    /**
     * Check if container is scrolled to bottom
     * @param {HTMLElement} container - Container element
     * @returns {boolean} True if scrolled to bottom
     */
    function isScrolledToBottom(container) {
      if (!container) return true;
      const threshold = 50; // pixels from bottom
      return container.scrollHeight - container.scrollTop - container.clientHeight < threshold;
    }
    
    /**
     * Escape regex special characters
     * @param {string} string - String to escape
     * @returns {string} Escaped string
     */
    function escapeRegex(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }
    
    /**
     * Initialize logs section when navigated to
     */
    function initLogsSection() {
      initSIPLogs();
      initDTMFLogs();
    }
    
    // ===== Task 12: Hardware Testing Section Functions =====
    
    /**
     * Initialize hardware testing section
     */
    function initHardwareTesting() {
      // Hardware testing initialization is handled by navigation
      // Polling starts when section becomes active via navigateToSection
      console.log('Hardware Testing section initialized');
    }
    
    // ===== Task 9: Hardware Testing JavaScript Functions =====
    
    /**
     * Update hardware state display with 500ms polling interval
     * Polls the /api/hardware/state endpoint and updates the UI
     */
    let hardwareStateInterval = null;
    
    async function updateHardwareState() {
      try {
        const response = await apiRequest('/api/hardware/state');
        
        // Update door relay state
        const doorRelayState = document.getElementById('hw-door-relay-state');
        const doorRelayCard = document.getElementById('hw-door-relay-card');
        const doorCountdown = document.getElementById('hw-door-countdown');
        const doorRemaining = document.getElementById('hw-door-remaining');
        
        if (doorRelayState && doorRelayCard) {
          if (response.door_relay_active) {
            doorRelayState.textContent = 'Active';
            doorRelayCard.style.borderColor = 'var(--color-status-connected)';
            
            // Show countdown if remaining time is available
            if (doorCountdown && doorRemaining && response.door_relay_remaining_ms > 0) {
              const remainingSeconds = Math.ceil(response.door_relay_remaining_ms / 1000);
              doorRemaining.textContent = remainingSeconds;
              doorCountdown.hidden = false;
            }
          } else {
            doorRelayState.textContent = 'Inactive';
            doorRelayCard.style.borderColor = 'var(--color-border)';
            if (doorCountdown) {
              doorCountdown.hidden = true;
            }
          }
        }
        
        // Update light relay state
        const lightRelayState = document.getElementById('hw-light-relay-state');
        const lightRelayCard = document.getElementById('hw-light-relay-card');
        
        if (lightRelayState && lightRelayCard) {
          if (response.light_relay_active) {
            lightRelayState.textContent = 'On';
            lightRelayCard.style.borderColor = 'var(--color-warning)';
          } else {
            lightRelayState.textContent = 'Off';
            lightRelayCard.style.borderColor = 'var(--color-border)';
          }
        }
        
        // Update bell 1 state
        const bell1State = document.getElementById('hw-bell1-state');
        const bell1Card = document.getElementById('hw-bell1-card');
        
        if (bell1State && bell1Card) {
          if (response.bell1_pressed) {
            bell1State.textContent = 'Pressed';
            bell1Card.style.borderColor = 'var(--color-primary)';
          } else {
            bell1State.textContent = 'Not Pressed';
            bell1Card.style.borderColor = 'var(--color-border)';
          }
        }
        
        // Update bell 2 state
        const bell2State = document.getElementById('hw-bell2-state');
        const bell2Card = document.getElementById('hw-bell2-card');
        
        if (bell2State && bell2Card) {
          if (response.bell2_pressed) {
            bell2State.textContent = 'Pressed';
            bell2Card.style.borderColor = 'var(--color-primary)';
          } else {
            bell2State.textContent = 'Not Pressed';
            bell2Card.style.borderColor = 'var(--color-border)';
          }
        }
        
      } catch (error) {
        console.error('Error updating hardware state:', error);
        // Don't show error toast for polling failures
      }
    }
    
    /**
     * Start hardware state polling when testing section is active
     */
    function startHardwareStatePolling() {
      // Clear any existing interval
      if (hardwareStateInterval) {
        clearInterval(hardwareStateInterval);
      }
      
      // Initial update
      updateHardwareState();
      
      // Poll every 500ms
      hardwareStateInterval = setInterval(updateHardwareState, 500);
    }
    
    /**
     * Stop hardware state polling
     */
    function stopHardwareStatePolling() {
      if (hardwareStateInterval) {
        clearInterval(hardwareStateInterval);
        hardwareStateInterval = null;
      }
    }
    
    /**
     * Test doorbell button press
     * @param {number} bell - Bell number (1 or 2)
     */
    async function testDoorbell(bell) {
      const btnId = `test-bell${bell}-btn`;
      const btn = document.getElementById(btnId);
      
      if (!btn) return;
      
      try {
        // Show loading state
        setLoadingState(btn, true);
        
        // Make API request
        const response = await apiRequest('/api/hardware/test/doorbell', {
          method: 'POST',
          body: JSON.stringify({ bell: bell })
        });
        
        // Show success feedback
        showFeedback('success', `Doorbell ${bell} test successful! ${response.message || 'Button press simulated.'}`);
        
      } catch (error) {
        // Show error feedback
        showFeedback('error', `Doorbell ${bell} test failed: ${error.message}`);
        
      } finally {
        // Reset button state
        setLoadingState(btn, false);
      }
    }
    
    /**
     * Test door opener relay with duration from slider
     */
    async function testDoorOpener() {
      const btn = document.getElementById('test-door-btn');
      const durationInput = document.getElementById('door-duration');
      
      if (!btn || !durationInput) return;
      
      // Get duration in seconds from slider
      const durationSeconds = parseInt(durationInput.value);
      
      // Validate duration
      if (isNaN(durationSeconds) || durationSeconds < 1 || durationSeconds > 10) {
        showFeedback('error', 'Duration must be between 1 and 10 seconds');
        return;
      }
      
      // Show confirmation dialog with duration and safety warning
      const confirmed = await showConfirmDialog(
        'Activate Door Opener Relay',
        `<strong>Duration: ${durationSeconds} second${durationSeconds !== 1 ? 's' : ''}</strong><br><br>` +
        `This will <strong>physically activate the door opener relay</strong> for ${durationSeconds} second${durationSeconds !== 1 ? 's' : ''}.<br><br>` +
        `‚ö†Ô∏è <strong>Safety Check:</strong><br>` +
        `‚Ä¢ Verify proper wiring connections<br>` +
        `‚Ä¢ Ensure door mechanism is safe to operate<br>` +
        `‚Ä¢ Confirm no one is near the door<br><br>` +
        `Do you want to proceed?`,
        'Activate Relay',
        'Cancel',
        'warning'
      );
      
      if (!confirmed) {
        return;
      }
      
      try {
        // Show loading state
        setLoadingState(btn, true);
        
        // Make API request (convert to milliseconds)
        const response = await apiRequest('/api/hardware/test/door', {
          method: 'POST',
          body: JSON.stringify({ duration: durationSeconds * 1000 })
        });
        
        // Show success feedback
        showFeedback('success', `Door opener activated for ${durationSeconds} seconds. ${response.message || ''}`);
        
      } catch (error) {
        // Show error feedback
        showFeedback('error', `Door opener test failed: ${error.message}`);
        
      } finally {
        // Reset button state
        setLoadingState(btn, false);
      }
    }
    
    /**
     * Test light relay toggle
     */
    async function testLightToggle() {
      const btn = document.getElementById('test-light-btn');
      
      if (!btn) return;
      
      try {
        // Show loading state
        setLoadingState(btn, true);
        
        // Make API request
        const response = await apiRequest('/api/hardware/test/light', {
          method: 'POST',
          body: JSON.stringify({})
        });
        
        // Show success feedback with new state
        const newState = response.state || 'unknown';
        showFeedback('success', `Light toggled ${newState.toUpperCase()}. ${response.message || ''}`);
        
      } catch (error) {
        // Show error feedback
        showFeedback('error', `Light toggle failed: ${error.message}`);
        
      } finally {
        // Reset button state
        setLoadingState(btn, false);
      }
    }
    
    /**
     * Emergency stop - immediately deactivate all active tests
     */
    async function emergencyStop() {
      const btn = document.getElementById('emergency-stop-btn');
      
      if (!btn) return;
      
      try {
        // Show loading state
        setLoadingState(btn, true);
        
        // Make API request
        const response = await apiRequest('/api/hardware/test/stop', {
          method: 'POST',
          body: JSON.stringify({})
        });
        
        // Show success feedback
        showFeedback('success', response.message || 'All tests stopped');
        
        // Force immediate state update
        updateHardwareState();
        
      } catch (error) {
        // Show error feedback
        showFeedback('error', `Emergency stop failed: ${error.message}`);
        
      } finally {
        // Reset button state
        setLoadingState(btn, false);
      }
    }
    
    /**
     * Update duration display when slider value changes
     * @param {number} value - Duration value in seconds
     */
    function updateDurationDisplay(value) {
      const displayElement = document.getElementById('door-duration-value');
      if (displayElement) {
        displayElement.textContent = value;
      }
    }
    
    /**
     * Show feedback message in the test feedback area
     * @param {string} type - Feedback type ('success', 'error', 'info')
     * @param {string} message - Feedback message to display
     */
    function showFeedback(type, message) {
      const feedbackArea = document.getElementById('test-feedback');
      const feedbackIcon = document.getElementById('test-feedback-icon');
      const feedbackMessage = document.getElementById('test-feedback-message');
      
      if (!feedbackArea || !feedbackIcon || !feedbackMessage) return;
      
      // Set icon based on type
      const icons = {
        'success': '‚úÖ',
        'error': '‚ùå',
        'info': '‚ÑπÔ∏è'
      };
      
      feedbackIcon.textContent = icons[type] || '‚ÑπÔ∏è';
      feedbackMessage.textContent = message;
      
      // Set border color based on type
      const colors = {
        'success': 'var(--color-success)',
        'error': 'var(--color-danger)',
        'info': 'var(--color-info)'
      };
      
      feedbackArea.style.borderLeftColor = colors[type] || 'var(--color-info)';
      feedbackArea.style.display = 'block';
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        feedbackArea.style.display = 'none';
      }, 5000);
    }
    
    // ===== Task 13: Email Reports Section Functions =====
    
    /**
     * Task 13.5: Load existing email configuration
     */
    async function loadEmailConfiguration() {
      try {
        const response = await apiRequest('/api/email/config');
        
        // Populate SMTP form fields
        const smtpServer = document.getElementById('smtp-server');
        const smtpPort = document.getElementById('smtp-port');
        const smtpUsername = document.getElementById('smtp-username');
        const smtpPassword = document.getElementById('smtp-password');
        const smtpSender = document.getElementById('smtp-sender');
        
        if (response.smtp) {
          if (smtpServer && response.smtp.server) smtpServer.value = response.smtp.server;
          if (smtpPort && response.smtp.port) smtpPort.value = response.smtp.port;
          if (smtpUsername && response.smtp.username) smtpUsername.value = response.smtp.username;
          if (smtpPassword && response.smtp.password) smtpPassword.value = response.smtp.password;
          if (smtpSender && response.smtp.sender) smtpSender.value = response.smtp.sender;
        }
        
        // Populate report configuration fields
        const reportsEnabled = document.getElementById('reports-enabled');
        const reportRecipient = document.getElementById('report-recipient');
        const reportSchedule = document.getElementById('report-schedule');
        const reportTime = document.getElementById('report-time');
        const reportDay = document.getElementById('report-day');
        const reportDayOfMonth = document.getElementById('report-day-of-month');
        const includeStatus = document.getElementById('include-status');
        const includeLogs = document.getElementById('include-logs');
        const includeBackup = document.getElementById('include-backup');
        
        if (response.reports) {
          if (reportsEnabled) reportsEnabled.checked = response.reports.enabled !== false;
          if (reportRecipient && response.reports.recipient) reportRecipient.value = response.reports.recipient;
          if (reportSchedule && response.reports.schedule) reportSchedule.value = response.reports.schedule;
          if (reportTime && response.reports.time) reportTime.value = response.reports.time;
          if (reportDay && response.reports.day !== undefined) reportDay.value = response.reports.day;
          if (reportDayOfMonth && response.reports.day_of_month) reportDayOfMonth.value = response.reports.day_of_month;
          if (includeStatus) includeStatus.checked = response.reports.include_status !== false;
          if (includeLogs) includeLogs.checked = response.reports.include_logs !== false;
          if (includeBackup) includeBackup.checked = response.reports.include_backup !== false;
        }
        
        // Update last report status (Task 13.3)
        if (response.last_report) {
          const lastReportTime = document.getElementById('last-report-time');
          const lastReportStatusValue = document.getElementById('last-report-status-value');
          
          if (lastReportTime && response.last_report.timestamp) {
            const date = new Date(response.last_report.timestamp * 1000);
            lastReportTime.textContent = date.toLocaleString();
          }
          
          if (lastReportStatusValue) {
            if (response.last_report.success) {
              lastReportStatusValue.innerHTML = '<span style="color: var(--color-success);">‚úÖ Success</span>';
            } else {
              lastReportStatusValue.innerHTML = '<span style="color: var(--color-danger);">‚ùå Failed</span>';
              if (response.last_report.error) {
                lastReportStatusValue.innerHTML += `<br><span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">${response.last_report.error}</span>`;
              }
            }
          }
        }
        
        // Toggle report config fields based on enabled checkbox
        toggleReportConfigFields();
        
        // Save initial state for change tracking
        const smtpForm = document.getElementById('email-smtp-form');
        const reportForm = document.getElementById('email-report-form');
        if (smtpForm) {
          saveFormInitialState(smtpForm);
          trackFormChanges(smtpForm);
        }
        if (reportForm) {
          saveFormInitialState(reportForm);
          trackFormChanges(reportForm);
        }
        
        console.log('Email configuration loaded successfully');
        
      } catch (error) {
        console.error('Error loading email configuration:', error);
        // Don't show error toast on initial load - config might not exist yet
      }
    }
    
    /**
     * Toggle report configuration fields based on enabled checkbox
     */
    function toggleReportConfigFields() {
      const reportsEnabled = document.getElementById('reports-enabled');
      const reportConfigFields = document.getElementById('report-config-fields');
      
      if (reportsEnabled && reportConfigFields) {
        reportConfigFields.style.display = reportsEnabled.checked ? 'block' : 'none';
        
        // Update required state of fields
        const requiredFields = reportConfigFields.querySelectorAll('input[required], select[required]');
        requiredFields.forEach(field => {
          field.disabled = !reportsEnabled.checked;
        });
      }
    }
    
    /**
     * Task 13.1: Handle test email button
     */
    async function handleTestEmail() {
      const button = document.getElementById('test-email-btn');
      if (button) setLoadingState(button, true);
      
      try {
        // First save the SMTP configuration
        const form = document.getElementById('email-smtp-form');
        if (!validateForm(form)) {
          showToast('Please fix the errors in the SMTP configuration', 'error');
          return;
        }
        
        const formData = new FormData(form);
        const smtpConfig = {
          smtp: {
            server: formData.get('smtp_server'),
            port: parseInt(formData.get('smtp_port')),
            username: formData.get('smtp_username'),
            password: formData.get('smtp_password'),
            sender: formData.get('smtp_sender')
          }
        };
        
        // Save configuration first
        await apiRequest('/api/email/config', {
          method: 'POST',
          body: JSON.stringify(smtpConfig)
        });
        
        // Send test email
        showToast('Sending test email...', 'info');
        const response = await apiRequest('/api/email/test', { method: 'POST' });
        
        if (response.status === 'success') {
          showToast('Test email sent successfully! Check your inbox.', 'success', 5000);
        } else {
          showToast(response.message || 'Failed to send test email', 'error');
        }
        
      } catch (error) {
        console.error('Error sending test email:', error);
        // Error toast already shown by apiRequest
      } finally {
        if (button) setLoadingState(button, false);
      }
    }
    
    /**
     * Task 13.4: Handle send report now button
     */
    async function handleSendReportNow() {
      const button = document.getElementById('send-report-now-btn');
      if (button) setLoadingState(button, true);
      
      try {
        // Validate both forms
        const smtpForm = document.getElementById('email-smtp-form');
        const reportForm = document.getElementById('email-report-form');
        
        if (!validateForm(smtpForm)) {
          showToast('Please fix the errors in the SMTP configuration', 'error');
          return;
        }
        
        if (!validateForm(reportForm)) {
          showToast('Please fix the errors in the report configuration', 'error');
          return;
        }
        
        // Save configurations first
        await saveEmailConfiguration();
        
        // Send report now
        showToast('Generating and sending report...', 'info');
        const response = await apiRequest('/api/email/send-report', { method: 'POST' });
        
        if (response.status === 'success') {
          showToast('Report sent successfully!', 'success', 5000);
          
          // Reload configuration to update last report status
          setTimeout(() => loadEmailConfiguration(), 1000);
        } else {
          showToast(response.message || 'Failed to send report', 'error');
        }
        
      } catch (error) {
        console.error('Error sending report:', error);
        // Error toast already shown by apiRequest
      } finally {
        if (button) setLoadingState(button, false);
      }
    }
    
    /**
     * Save email configuration (both SMTP and report settings)
     */
    async function saveEmailConfiguration() {
      const smtpForm = document.getElementById('email-smtp-form');
      const reportForm = document.getElementById('email-report-form');
      
      const smtpData = new FormData(smtpForm);
      const reportData = new FormData(reportForm);
      
      const config = {
        smtp: {
          server: smtpData.get('smtp_server'),
          port: parseInt(smtpData.get('smtp_port')),
          username: smtpData.get('smtp_username'),
          password: smtpData.get('smtp_password'),
          sender: smtpData.get('smtp_sender')
        },
        reports: {
          enabled: reportData.get('reports_enabled') === 'on',
          recipient: reportData.get('report_recipient'),
          schedule: reportData.get('report_schedule'),
          time: reportData.get('report_time'),
          day: parseInt(reportData.get('report_day')),
          day_of_month: parseInt(reportData.get('report_day_of_month')),
          include_status: reportData.get('include_status') === 'on',
          include_logs: reportData.get('include_logs') === 'on',
          include_backup: reportData.get('include_backup') === 'on'
        }
      };
      
      await apiRequest('/api/email/config', {
        method: 'POST',
        body: JSON.stringify(config)
      });
    }
    
    /**
     * Initialize Email Reports section
     */
    function initEmailReports() {
      // Load existing configuration
      loadEmailConfiguration();
      
      // Setup reports enabled checkbox handler
      const reportsEnabled = document.getElementById('reports-enabled');
      if (reportsEnabled) {
        reportsEnabled.addEventListener('change', toggleReportConfigFields);
      }
      
      // Setup form submit handlers
      const smtpForm = document.getElementById('email-smtp-form');
      if (smtpForm) {
        smtpForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          if (!validateForm(smtpForm)) {
            showToast('Please fix the errors in the form', 'error');
            return;
          }
          
          const submitBtn = smtpForm.querySelector('button[type="submit"]');
          if (submitBtn) setLoadingState(submitBtn, true);
          
          try {
            await saveEmailConfiguration();
            showToast('SMTP configuration saved successfully!', 'success');
            
            // Update initial state
            saveFormInitialState(smtpForm);
            trackFormChanges(smtpForm);
            
          } catch (error) {
            console.error('Error saving SMTP configuration:', error);
          } finally {
            if (submitBtn) setLoadingState(submitBtn, false);
          }
        });
      }
      
      const reportForm = document.getElementById('email-report-form');
      if (reportForm) {
        reportForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          if (!validateForm(reportForm)) {
            showToast('Please fix the errors in the form', 'error');
            return;
          }
          
          const submitBtn = reportForm.querySelector('button[type="submit"]');
          if (submitBtn) setLoadingState(submitBtn, true);
          
          try {
            await saveEmailConfiguration();
            showToast('Report configuration saved successfully!', 'success');
            
            // Update initial state
            saveFormInitialState(reportForm);
            trackFormChanges(reportForm);
            
          } catch (error) {
            console.error('Error saving report configuration:', error);
          } finally {
            if (submitBtn) setLoadingState(submitBtn, false);
          }
        });
      }
      
      console.log('Email Reports section initialized');
    }
    
    // ===== Task 14: OTA Update Section =====
    
    let otaSelectedFile = null;
    let otaUploadStartTime = 0;
    let otaUploadedBytes = 0;
    
    /**
     * Task 14.1: Load current firmware information
     */
    async function loadOTAFirmwareInfo() {
      try {
        const response = await apiRequest('/api/ota/version');
        
        document.getElementById('ota-current-version').textContent = response.version || 'Unknown';
        document.getElementById('ota-build-date').textContent = response.build_date || 'Unknown';
        document.getElementById('ota-chip-model').textContent = response.chip_model || 'Unknown';
        
      } catch (error) {
        console.error('Error loading firmware info:', error);
        document.getElementById('ota-current-version').textContent = 'Error';
        document.getElementById('ota-build-date').textContent = 'Error';
        document.getElementById('ota-chip-model').textContent = 'Error';
      }
    }
    
    /**
     * Task 14.2: Initialize file upload interface
     */
    function initOTAFileUpload() {
      const dropZone = document.getElementById('ota-drop-zone');
      const fileInput = document.getElementById('ota-file-input');
      
      // Prevent default drag behaviors
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
      });
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      // Highlight drop zone when item is dragged over it
      ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
          dropZone.style.borderColor = 'var(--color-primary)';
          dropZone.style.backgroundColor = 'rgba(76, 175, 80, 0.05)';
        }, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
          dropZone.style.borderColor = 'var(--color-border)';
          dropZone.style.backgroundColor = 'var(--color-bg)';
        }, false);
      });
      
      // Handle dropped files
      dropZone.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
          handleOTAFileSelected(files[0]);
        }
      }, false);
      
      // Handle file input change
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleOTAFileSelected(e.target.files[0]);
        }
      });
      
      // Make drop zone clickable
      dropZone.addEventListener('click', (e) => {
        if (e.target.tagName !== 'BUTTON') {
          fileInput.click();
        }
      });
    }
    
    /**
     * Task 14.2: Handle file selection and validation
     */
    function handleOTAFileSelected(file) {
      // Validate file format
      if (!file.name.endsWith('.bin')) {
        showToast('Invalid file format. Please select a .bin file.', 'error');
        return;
      }
      
      // Validate file size (max 5MB)
      const maxSize = 5 * 1024 * 1024; // 5MB in bytes
      if (file.size > maxSize) {
        showToast('File too large. Maximum size is 5MB.', 'error');
        return;
      }
      
      // Store selected file
      otaSelectedFile = file;
      
      // Display file info
      document.getElementById('ota-file-name').textContent = file.name;
      document.getElementById('ota-file-size').textContent = formatFileSize(file.size);
      document.getElementById('ota-file-info').style.display = 'block';
      
      // Enable upload button
      document.getElementById('ota-upload-btn').disabled = false;
      
      // Hide other sections
      document.getElementById('ota-apply-section').style.display = 'none';
      document.getElementById('ota-status-section').style.display = 'none';
      document.getElementById('ota-reload-section').style.display = 'none';
      
      showToast('Firmware file selected successfully', 'success');
    }
    
    /**
     * Clear selected OTA file
     */
    function clearOTAFile() {
      otaSelectedFile = null;
      document.getElementById('ota-file-input').value = '';
      document.getElementById('ota-file-info').style.display = 'none';
      document.getElementById('ota-upload-btn').disabled = true;
      document.getElementById('ota-progress-container').style.display = 'none';
    }
    
    /**
     * Format file size for display
     */
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
    }
    
    /**
     * Format upload speed for display
     */
    function formatSpeed(bytesPerSecond) {
      if (bytesPerSecond === 0) return '0 B/s';
      const k = 1024;
      const sizes = ['B/s', 'KB/s', 'MB/s'];
      const i = Math.floor(Math.log(bytesPerSecond) / Math.log(k));
      return Math.round((bytesPerSecond / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
    }
    
    /**
     * Format time remaining for display
     */
    function formatTimeRemaining(seconds) {
      if (seconds < 60) {
        return Math.round(seconds) + 's';
      } else {
        const minutes = Math.floor(seconds / 60);
        const secs = Math.round(seconds % 60);
        return minutes + 'm ' + secs + 's';
      }
    }
    
    /**
     * Task 14.3: Handle OTA upload with progress tracking
     */
    async function handleOTAUpload() {
      if (!otaSelectedFile) {
        showToast('Please select a firmware file first', 'error');
        return;
      }
      
      const uploadBtn = document.getElementById('ota-upload-btn');
      setLoadingState(uploadBtn, true);
      
      // Show progress container
      const progressContainer = document.getElementById('ota-progress-container');
      progressContainer.style.display = 'block';
      
      // Reset progress
      otaUploadStartTime = Date.now();
      otaUploadedBytes = 0;
      updateOTAProgress(0, 'Preparing upload...');
      
      try {
        // Create FormData
        const formData = new FormData();
        formData.append('firmware', otaSelectedFile);
        
        // Upload with progress tracking
        const xhr = new XMLHttpRequest();
        
        // Track upload progress
        xhr.upload.addEventListener('progress', (e) => {
          if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            otaUploadedBytes = e.loaded;
            
            // Calculate speed and time remaining
            const elapsedTime = (Date.now() - otaUploadStartTime) / 1000; // seconds
            const speed = e.loaded / elapsedTime; // bytes per second
            const remainingBytes = e.total - e.loaded;
            const timeRemaining = remainingBytes / speed; // seconds
            
            // Update progress display
            updateOTAProgress(percentComplete, 'Uploading...', speed, timeRemaining);
          }
        });
        
        // Handle completion
        xhr.addEventListener('load', () => {
          if (xhr.status === 200) {
            try {
              const response = JSON.parse(xhr.responseText);
              updateOTAProgress(100, 'Upload complete!');
              showToast('Firmware uploaded successfully!', 'success');
              
              // Show apply section
              document.getElementById('ota-apply-section').style.display = 'block';
              
              // Scroll to apply section
              setTimeout(() => {
                document.getElementById('ota-apply-section').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
              }, 500);
              
            } catch (error) {
              throw new Error('Invalid response from server');
            }
          } else {
            throw new Error(`Upload failed with status ${xhr.status}`);
          }
          setLoadingState(uploadBtn, false);
        });
        
        // Handle errors
        xhr.addEventListener('error', () => {
          updateOTAProgress(0, 'Upload failed');
          showToast('Upload failed. Please check your connection and try again.', 'error');
          setLoadingState(uploadBtn, false);
        });
        
        xhr.addEventListener('abort', () => {
          updateOTAProgress(0, 'Upload cancelled');
          showToast('Upload cancelled', 'warning');
          setLoadingState(uploadBtn, false);
        });
        
        // Send request
        xhr.open('POST', '/api/ota/upload');
        xhr.send(formData);
        
      } catch (error) {
        console.error('Error uploading firmware:', error);
        showToast('Upload failed: ' + error.message, 'error');
        updateOTAProgress(0, 'Upload failed');
        setLoadingState(uploadBtn, false);
      }
    }
    
    /**
     * Task 14.3: Update progress display
     */
    function updateOTAProgress(percent, status, speed = 0, timeRemaining = 0) {
      document.getElementById('ota-progress-bar').style.width = percent + '%';
      document.getElementById('ota-progress-percent').textContent = Math.round(percent) + '%';
      document.getElementById('ota-upload-status').textContent = status;
      
      if (speed > 0) {
        document.getElementById('ota-upload-speed').textContent = 'Speed: ' + formatSpeed(speed);
      }
      
      if (timeRemaining > 0) {
        document.getElementById('ota-time-remaining').textContent = 'Time remaining: ' + formatTimeRemaining(timeRemaining);
      }
    }
    
    /**
     * Task 14.4 & 14.5: Handle OTA apply with confirmation
     */
    async function handleOTAApply() {
      // Show confirmation dialog
      const confirmed = await showConfirmDialog(
        'Apply Firmware Update?',
        'The device will restart and apply the new firmware. This process will take 1-2 minutes. Do not disconnect power during this time.',
        'Apply Update',
        'danger'
      );
      
      if (!confirmed) {
        return;
      }
      
      // Hide apply section, show status section
      document.getElementById('ota-apply-section').style.display = 'none';
      document.getElementById('ota-status-section').style.display = 'block';
      
      // Initialize update log
      const updateLog = document.getElementById('ota-update-log');
      updateLog.innerHTML = '';
      addOTALogEntry('Starting firmware update...');
      
      // Update status display
      updateOTAStatus('‚è≥', 'Verifying Firmware', 'Checking firmware integrity...');
      
      try {
        // Apply the update
        addOTALogEntry('Sending apply command to device...');
        const response = await apiRequest('/api/ota/apply', { method: 'POST' });
        
        addOTALogEntry('Apply command sent successfully');
        updateOTAStatus('üîÑ', 'Applying Update', 'Device is restarting and applying firmware...');
        
        // Start polling for device availability
        addOTALogEntry('Device is restarting...');
        setTimeout(() => {
          pollDeviceAvailability();
        }, 5000); // Wait 5 seconds before starting to poll
        
      } catch (error) {
        console.error('Error applying OTA update:', error);
        addOTALogEntry('ERROR: ' + error.message);
        updateOTAStatus('‚ùå', 'Update Failed', error.message);
        showToast('Failed to apply update: ' + error.message, 'error');
      }
    }
    
    /**
     * Task 14.5: Update status display
     */
    function updateOTAStatus(icon, message, detail) {
      document.getElementById('ota-status-icon').textContent = icon;
      document.getElementById('ota-status-message').textContent = message;
      document.getElementById('ota-status-detail').textContent = detail;
    }
    
    /**
     * Task 14.5: Add entry to update log
     */
    function addOTALogEntry(message) {
      const updateLog = document.getElementById('ota-update-log');
      const timestamp = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.textContent = `[${timestamp}] ${message}`;
      entry.style.marginBottom = 'var(--spacing-xs)';
      updateLog.appendChild(entry);
      
      // Scroll to bottom
      updateLog.scrollTop = updateLog.scrollHeight;
    }
    
    /**
     * Task 14.6: Poll for device availability after update
     */
    let pollAttempts = 0;
    const maxPollAttempts = 60; // 60 attempts = 2 minutes (2 second intervals)
    
    async function pollDeviceAvailability() {
      pollAttempts++;
      addOTALogEntry(`Checking device availability (attempt ${pollAttempts}/${maxPollAttempts})...`);
      
      try {
        // Try to fetch system status
        const response = await fetch('/api/system/status', {
          method: 'GET',
          cache: 'no-cache'
        });
        
        if (response.ok) {
          // Device is back online
          addOTALogEntry('Device is back online!');
          updateOTAStatus('‚úÖ', 'Update Complete', 'Firmware updated successfully');
          
          // Hide status section, show reload section
          document.getElementById('ota-status-section').style.display = 'none';
          document.getElementById('ota-reload-section').style.display = 'block';
          
          // Start countdown
          startReloadCountdown();
          
          return;
        }
      } catch (error) {
        // Device not available yet, continue polling
      }
      
      if (pollAttempts < maxPollAttempts) {
        // Continue polling
        setTimeout(pollDeviceAvailability, 2000); // Poll every 2 seconds
      } else {
        // Max attempts reached
        addOTALogEntry('ERROR: Device did not come back online within expected time');
        updateOTAStatus('‚ö†Ô∏è', 'Update Status Unknown', 'Device is taking longer than expected to restart. Please check device manually.');
        showToast('Device restart is taking longer than expected', 'warning');
      }
    }
    
    /**
     * Task 14.6: Start reload countdown
     */
    function startReloadCountdown() {
      let countdown = 30;
      const countdownElement = document.getElementById('ota-reload-countdown');
      
      const interval = setInterval(() => {
        countdown--;
        countdownElement.textContent = countdown;
        
        if (countdown <= 0) {
          clearInterval(interval);
          location.reload();
        }
      }, 1000);
    }
    
    /**
     * Initialize OTA Update section
     */
    function initOTASection() {
      // Load firmware information
      loadOTAFirmwareInfo();
      
      // Initialize file upload
      initOTAFileUpload();
      
      console.log('OTA Update section initialized');
    }
    
    // ===== Task 15: Documentation Section =====
    
    /**
     * Task 15.1: Load documentation content from embedded file
     */
    async function loadDocumentation() {
      try {
        const response = await fetch('/documentation.html');
        if (response.ok) {
          const html = await response.text();
          document.getElementById('documentation-container').innerHTML = html;
          
          // Load firmware version info (Task 15.11)
          loadDocsFirmwareInfo();
          
          console.log('Documentation loaded successfully');
        } else {
          console.error('Failed to load documentation:', response.status);
          document.getElementById('documentation-container').innerHTML = 
            '<p style="text-align: center; padding: var(--spacing-xl); color: var(--color-danger);">Failed to load documentation. Please check the firmware build.</p>';
        }
      } catch (error) {
        console.error('Error loading documentation:', error);
        document.getElementById('documentation-container').innerHTML = 
          '<p style="text-align: center; padding: var(--spacing-xl); color: var(--color-danger);">Error loading documentation: ' + error.message + '</p>';
      }
    }
    
    /**
     * Task 15.1: Toggle documentation section collapse/expand
     */
    function toggleDocsSection(sectionId) {
      const section = document.getElementById(`docs-${sectionId}`);
      if (section) {
        section.classList.toggle('collapsed');
      }
    }
    
    /**
     * Task 15.1: Scroll to specific documentation section
     */
    function scrollToDocsSection(sectionId) {
      const section = document.getElementById(`docs-${sectionId}`);
      if (section) {
        // Expand section if collapsed
        section.classList.remove('collapsed');
        
        // Scroll to section
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        // Highlight section briefly
        section.style.backgroundColor = 'var(--color-hover)';
        setTimeout(() => {
          section.style.backgroundColor = '';
        }, 1000);
      }
    }
    
    /**
     * Task 15.10: Search documentation content
     */
    function searchDocumentation(query) {
      if (!query || query.length < 2) {
        // Clear highlights
        clearDocumentationHighlights();
        return;
      }
      
      // Clear previous highlights
      clearDocumentationHighlights();
      
      const container = document.getElementById('documentation-container');
      const searchQuery = query.toLowerCase();
      let matchCount = 0;
      
      // Search through all text nodes
      const walker = document.createTreeWalker(
        container,
        NodeFilter.SHOW_TEXT,
        null,
        false
      );
      
      const nodesToHighlight = [];
      let node;
      
      while (node = walker.nextNode()) {
        const text = node.textContent.toLowerCase();
        if (text.includes(searchQuery)) {
          nodesToHighlight.push(node);
        }
      }
      
      // Highlight matches
      nodesToHighlight.forEach(node => {
        const parent = node.parentNode;
        if (parent && parent.nodeName !== 'SCRIPT' && parent.nodeName !== 'STYLE') {
          const text = node.textContent;
          const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
          const highlightedHTML = text.replace(regex, '<span class="docs-search-highlight">$1</span>');
          
          const span = document.createElement('span');
          span.innerHTML = highlightedHTML;
          parent.replaceChild(span, node);
          matchCount++;
        }
      });
      
      // Expand all sections if matches found
      if (matchCount > 0) {
        document.querySelectorAll('.docs-section').forEach(section => {
          section.classList.remove('collapsed');
        });
      }
    }
    
    /**
     * Task 15.10: Clear documentation search highlights
     */
    function clearDocumentationHighlights() {
      const highlights = document.querySelectorAll('.docs-search-highlight');
      highlights.forEach(highlight => {
        const parent = highlight.parentNode;
        parent.replaceChild(document.createTextNode(highlight.textContent), highlight);
        parent.normalize();
      });
    }
    
    /**
     * Helper: Escape regex special characters
     */
    function escapeRegex(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }
    
    /**
     * Task 15.11: Load firmware version info for documentation
     */
    async function loadDocsFirmwareInfo() {
      try {
        const response = await fetch('/api/system/info');
        if (response.ok) {
          const data = await response.json();
          document.getElementById('docs-firmware-version').textContent = data.version || 'v1.0.0';
          document.getElementById('docs-build-date').textContent = data.buildDate || new Date().toLocaleDateString();
        }
      } catch (error) {
        console.error('Error loading firmware info for docs:', error);
        document.getElementById('docs-firmware-version').textContent = 'v1.0.0';
        document.getElementById('docs-build-date').textContent = new Date().toLocaleDateString();
      }
    }
    
    /**
     * Task 15.11: Report issue with pre-filled template
     */
    function reportIssue() {
      // Get system information
      const firmwareVersion = document.getElementById('docs-firmware-version')?.textContent || 'Unknown';
      const buildDate = document.getElementById('docs-build-date')?.textContent || 'Unknown';
      
      // Create issue template
      const issueTemplate = encodeURIComponent(
        `**Describe the issue:**\n\n` +
        `\n\n` +
        `**Steps to reproduce:**\n` +
        `1. \n` +
        `2. \n` +
        `3. \n\n` +
        `**Expected behavior:**\n\n` +
        `\n\n` +
        `**System Information:**\n` +
        `- Firmware Version: ${firmwareVersion}\n` +
        `- Build Date: ${buildDate}\n` +
        `- Browser: ${navigator.userAgent}\n`
      );
      
      // Open GitHub issues page with template
      const githubIssueUrl = `https://github.com/yourusername/esp32-sip-doorstation/issues/new?body=${issueTemplate}`;
      window.open(githubIssueUrl, '_blank');
    }
    
    /**
     * Task 15.7: Copy text to clipboard
     */
    function copyToClipboard(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
          showToast('Copied to clipboard', 'success');
        }).catch(err => {
          console.error('Failed to copy:', err);
          showToast('Failed to copy to clipboard', 'error');
        });
      } else {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          showToast('Copied to clipboard', 'success');
        } catch (err) {
          console.error('Failed to copy:', err);
          showToast('Failed to copy to clipboard', 'error');
        }
        document.body.removeChild(textArea);
      }
    }
    
    /**
     * Initialize Documentation section
     */
    function initDocumentation() {
      // Load documentation content
      loadDocumentation();
      
      console.log('Documentation section initialized');
    }
    
    // ===== Initialization =====
    
    // ===== Task 19: Session Management =====
    
    /**
     * Session management state
     */
    const sessionManager = {
      checkInterval: null,
      warningTimeout: null,
      sessionExpiresAt: null,
      warningShown: false,
      activityListeners: []
    };
    
    /**
     * Check if user has a valid session
     * @returns {Promise<boolean>} True if session is valid
     */
    async function checkSession() {
      try {
        // Make a simple API call to check session validity
        const response = await fetch('/api/system/info', {
          method: 'GET',
          credentials: 'include'
        });
        
        if (response.status === 401) {
          // Session invalid or expired - redirect to login
          console.log('Session expired or invalid, redirecting to login');
          window.location.href = '/login.html';
          return false;
        }
        
        if (response.ok) {
          // Session is valid
          return true;
        }
        
        // Other error - log but don't redirect
        console.warn('Session check returned unexpected status:', response.status);
        return true; // Assume valid to avoid false redirects
      } catch (error) {
        console.error('Session check failed:', error);
        // Network error - don't redirect, might be temporary
        return true;
      }
    }
    
    /**
     * Show session timeout warning
     * @param {number} minutesRemaining - Minutes until session expires
     */
    function showSessionWarning(minutesRemaining) {
      if (sessionManager.warningShown) {
        return; // Already showing warning
      }
      
      sessionManager.warningShown = true;
      
      const message = `Your session will expire in ${minutesRemaining} minute${minutesRemaining !== 1 ? 's' : ''}. Please save your work.`;
      
      showToast(message, 'warning', 0); // 0 = don't auto-dismiss
      
      console.log('Session timeout warning shown:', message);
    }
    
    /**
     * Extend session by making an API call
     */
    async function extendSession() {
      try {
        // Make any authenticated API call to extend session
        const response = await fetch('/api/system/info', {
          method: 'GET',
          credentials: 'include'
        });
        
        if (response.ok) {
          // Reset warning state
          sessionManager.warningShown = false;
          
          // Update session expiration time (30 minutes from now)
          sessionManager.sessionExpiresAt = Date.now() + (30 * 60 * 1000);
          
          console.log('Session extended');
        }
      } catch (error) {
        console.error('Failed to extend session:', error);
      }
    }
    
    /**
     * Setup automatic session extension on user activity
     */
    function setupActivityTracking() {
      // Throttle activity tracking to avoid excessive API calls
      let lastActivityTime = 0;
      const ACTIVITY_THROTTLE = 60000; // 1 minute
      
      const handleActivity = () => {
        const now = Date.now();
        if (now - lastActivityTime > ACTIVITY_THROTTLE) {
          lastActivityTime = now;
          extendSession();
        }
      };
      
      // Track various user activities
      const events = ['mousedown', 'keydown', 'scroll', 'touchstart'];
      
      events.forEach(event => {
        document.addEventListener(event, handleActivity, { passive: true });
        sessionManager.activityListeners.push({ event, handler: handleActivity });
      });
      
      console.log('Activity tracking initialized');
    }
    
    /**
     * Start session monitoring
     */
    function startSessionMonitoring() {
      // Check session every 2 minutes
      sessionManager.checkInterval = setInterval(async () => {
        const isValid = await checkSession();
        
        if (isValid && sessionManager.sessionExpiresAt) {
          const timeRemaining = sessionManager.sessionExpiresAt - Date.now();
          const minutesRemaining = Math.floor(timeRemaining / 60000);
          
          // Show warning 5 minutes before expiration
          if (minutesRemaining <= 5 && minutesRemaining > 0 && !sessionManager.warningShown) {
            showSessionWarning(minutesRemaining);
          }
        }
      }, 120000); // Check every 2 minutes
      
      // Set initial session expiration time (30 minutes from now)
      sessionManager.sessionExpiresAt = Date.now() + (30 * 60 * 1000);
      
      console.log('Session monitoring started');
    }
    
    /**
     * Stop session monitoring (cleanup)
     */
    function stopSessionMonitoring() {
      if (sessionManager.checkInterval) {
        clearInterval(sessionManager.checkInterval);
        sessionManager.checkInterval = null;
      }
      
      if (sessionManager.warningTimeout) {
        clearTimeout(sessionManager.warningTimeout);
        sessionManager.warningTimeout = null;
      }
      
      // Remove activity listeners
      sessionManager.activityListeners.forEach(({ event, handler }) => {
        document.removeEventListener(event, handler);
      });
      sessionManager.activityListeners = [];
      
      console.log('Session monitoring stopped');
    }
    
    /**
     * Initialize session management on page load
     */
    async function initSessionManagement() {
      console.log('Initializing session management');
      
      // Check if session is valid on page load
      const isValid = await checkSession();
      
      if (!isValid) {
        // Will redirect to login, no need to continue
        return;
      }
      
      // Setup activity tracking for automatic session extension
      setupActivityTracking();
      
      // Start monitoring session expiration
      startSessionMonitoring();
      
      console.log('Session management initialized');
    }
    
    /**
     * Initialize the application
     */
    function initApp() {
      // Initialize session management first
      initSessionManagement();
      
      // Initialize theme
      initTheme();
      
      // Initialize navigation
      initNavigation();
      
      // Initialize status panel
      initStatusPanel();
      
      // Initialize forms
      initForms();
      
      // Initialize global search
      initGlobalSearch();
      
      // Initialize Dashboard section
      initDashboard();
      
      // Initialize SIP Settings section
      initSIPSettings();
      
      // Initialize Network Settings section
      initNetworkSettings();
      
      // Initialize Hardware Settings section
      initHardwareSettings();
      
      // Initialize Hardware Testing section
      initHardwareTesting();
      
      // Initialize Security Settings section
      initSecuritySettings();
      
      // Initialize Email Reports section
      initEmailReports();
      
      // Initialize OTA Update section
      initOTASection();
      
      // Initialize Documentation section
      initDocumentation();
      
      // Setup theme toggle
      const themeToggle = document.getElementById('theme-toggle');
      if (themeToggle) {
        themeToggle.addEventListener('click', toggleTheme);
      }
      
      // Setup mobile menu toggle
      const menuToggle = document.querySelector('.menu-toggle');
      if (menuToggle) {
        menuToggle.addEventListener('click', toggleMobileSidebar);
      }
      
      // Initialize touch gestures for mobile (Task 16.2)
      initTouchGestures();
      
      // Close sidebar when clicking outside on mobile
      document.addEventListener('click', (e) => {
        if (window.innerWidth < 768) {
          const sidebar = document.getElementById('sidebar');
          const menuToggle = document.querySelector('.menu-toggle');
          if (sidebar.classList.contains('open') && 
              !sidebar.contains(e.target) && 
              !menuToggle.contains(e.target)) {
            closeMobileSidebar();
          }
        }
      });
      
      // Handle window resize
      window.addEventListener('resize', () => {
        if (window.innerWidth >= 768) {
          const sidebar = document.getElementById('sidebar');
          sidebar.classList.remove('open');
        }
      });
      
      console.log('ESP32 SIP Door Station initialized');
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      initApp();
    }
  </script>

</body>
</html>
